<?php
//20.0.56.0 WL/HF/AN/Oracle.php GF 
//VersionVI: 30F200066p
//(c) 2005-2012 PC SOFT  - Release
 F3f50a0c6(HF_ORACLE); define('ORACLE_ESCAPE_CHAR','"'); define('WD_NLS_CHARSET','NLS_CHARACTER_SET'); class FMK_AN_ORACLE extends FMK_AN { var $m_tabPostCreateSQL; var $m_resStmt; var $m_tabCacheError = false; var $m_sNLSCharset = null; function FMK_AN_ORACLE($sHost=null,$sDB=null,$sUser=null,$sPass=null,$sInfosEtendues=null) { parent::FMK_AN($sHost,$sDB,$sUser,$sPass,$sInfosEtendues); $tabInfosEtendues = utf8_explode('=',$sInfosEtendues); if (array_key_exists(WD_NLS_CHARSET,$tabInfosEtendues)) { $this->m_sNLSCharset = $tabInfosEtendues[WD_NLS_CHARSET]; } else { $this->m_sNLSCharset = $this->Fe47ec54f() ? 'UTF8' : 'WE8MSWIN1252'; } } function F2b2924d8($resParse) { $this->m_resStmt = $resParse; } function F22067d84() { return TYPE_BASE_ORACLE; } function Fb640a0ce($bErreur = true, $sMdp = null, $bCreateDatabse = false) { if (PHPVERSION_5) { if (!function_exists( 'oci_connect' )) { if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, utf8_sprintf(F1ac3f040("ERR_LIB_SQL_NON_TROUVEE"),"Oracle")); } return false; } F6b1e3687(); $this->m_resConnexionId = oci_pconnect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur ) . '/' . ($this->m_sBase)); if ($this->m_resConnexionId === false) $this->m_resConnexionId = oci_pconnect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),($this->m_sServeur )); F1e7b0563(); if ($this->m_resConnexionId === false) { F6b1e3687(); $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur ) . '/' . ($this->m_sBase)); if ($this->m_resConnexionId === false) $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),($this->m_sServeur )); F1e7b0563(); } } else { if (function_exists( 'oci_connect' )) { F6b1e3687(); $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur ). '/' . ($this->m_sBase)); if ($this->m_resConnexionId === false) $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),($this->m_sServeur )); F1e7b0563(); } elseif (function_exists( 'ocilogon' )) { F6b1e3687(); $this->m_resConnexionId = ocilogon($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur ) . '/' . ($this->m_sBase)); if ($this->m_resConnexionId === false) $this->m_resConnexionId = ocilogon($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),( $this->m_sServeur )); F1e7b0563(); } else { if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, utf8_sprintf(F1ac3f040("ERR_LIB_SQL_NON_TROUVEE"),"Oracle")); } return false; } } if (!$this->m_resConnexionId) { $last_error = $this->F6b3e9cdf(); if ($bCreateDatabse) { if (PHPVERSION_5) { F6b1e3687(); $this->m_resConnexionId = oci_pconnect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur ) ); if ($this->m_resConnexionId === false) $this->m_resConnexionId = oci_pconnect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),($this->m_sServeur )); F1e7b0563(); if ($this->m_resConnexionId === false) { F6b1e3687(); $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur ) ); if ($this->m_resConnexionId === false) $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),($this->m_sServeur )); F1e7b0563(); } } else { if (function_exists( 'oci_connect' )) { F6b1e3687(); $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur )); if ($this->m_resConnexionId === false) $this->m_resConnexionId = oci_connect($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),($this->m_sServeur )); F1e7b0563(); } elseif (function_exists( 'ocilogon' )) { F6b1e3687(); $this->m_resConnexionId = ocilogon($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),'//' . ($this->m_sServeur )); if ($this->m_resConnexionId === false) $this->m_resConnexionId = ocilogon($this->m_sUtilisateur,((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse),( $this->m_sServeur )); F1e7b0563(); } } if ($this->m_resConnexionId !== false) { $res = $this->query('CREATE DATABASE ' . $this->m_sBase); if (!$res) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, $this->F6b3e9cdf()); } else { return $this->Fb640a0ce($bErreur,$sMdp,false); } } } if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, $last_error); } return false; } $this->F52fb3679('ALTER SESSION SET NLS_NUMERIC_CHARACTERS=\'. \''); $this->F52fb3679('ALTER SESSION SET NLS_CHARACTER_SET=\''.$this->m_sMotDePasse.'\''); return true; } function F9d634e1a() { if (PHPVERSION_5) { F6b1e3687(); if (function_exists( 'oci_close' )) oci_close($this->m_resConnexionId); elseif (function_exists( 'ocilogoff' )) ocilogoff($this->m_resConnexionId); F1e7b0563(); } } function F6b3e9cdf() { F6b1e3687(); $sMessage = (PHPVERSION_5) ? oci_error() : ocierror(); F1e7b0563(); if (is_array($sMessage)) $sMessage = (isset($sMessage['message'])) ? $sMessage['message'] : $sMessage[key($sMessage)]; return $sMessage; } function Fa7865f89($nOptions=null) { if (!$this->m_resConnexionId) $this->Fb640a0ce(); if (empty($this->m_sBase)) return ''; if(!isset($nOptions)) $nOptions=512; $sSQL = ''; if(($nOptions&(512|2048))!=0) { $sSQL = "SELECT OWNER,TABLE_NAME,'TABLE' AS TYPE FROM SYS.ALL_TABLES"; if(($nOptions&512)==0) { $sSQL .= " WHERE OWNER IN " . '(\'AURORA$ORB$UNAUTHENTICATED\',\'AURORA$JIS$UTILITY$\',\'OSE$HTTP$ADMIN\',\'CTXSYS\',\'DBSNMP\',\'DIP\',\'DMSYS\',\'EXFSYS\',\'LBACSYS\'\'MDDATA\',\'MDSYS\',\'MGMT_VIEW\',\'MTSSYS\',\'ODM\',\'ODM_MTR\',\'OLAPSYS\',\'OWBSYS\',\'ORDPLUGINS\',\'ORDSYS\',\'OUTLN\',\'SI_INFORMTN_SCHEMA\',\'SYS\',\'SYSMAN\',\'SYSTEM\',\'TSMSYS\',\'WK_TEST\',\'WKSYS\',\'WKPROXY\',\'WMSYS\',\'XDB\')'; } else if(($nOptions&2048)==0) { $sSQL .= " WHERE OWNER NOT IN " . '(\'AURORA$ORB$UNAUTHENTICATED\',\'AURORA$JIS$UTILITY$\',\'OSE$HTTP$ADMIN\',\'CTXSYS\',\'DBSNMP\',\'DIP\',\'DMSYS\',\'EXFSYS\',\'LBACSYS\'\'MDDATA\',\'MDSYS\',\'MGMT_VIEW\',\'MTSSYS\',\'ODM\',\'ODM_MTR\',\'OLAPSYS\',\'OWBSYS\',\'ORDPLUGINS\',\'ORDSYS\',\'OUTLN\',\'SI_INFORMTN_SCHEMA\',\'SYS\',\'SYSMAN\',\'SYSTEM\',\'TSMSYS\',\'WK_TEST\',\'WKSYS\',\'WKPROXY\',\'WMSYS\',\'XDB\')'; } } if(($nOptions&1024)!=0) { if(!empty($sSQL)) { $sSQL .= " UNION "; } $sSQL .= "SELECT OWNER,VIEW_NAME AS TABLE_NAME,'VIEW' AS TYPE FROM SYS.ALL_VIEWS"; if(($nOptions&2048)==0) { $sSQL .= " WHERE OWNER NOT IN " . '(\'AURORA$ORB$UNAUTHENTICATED\',\'AURORA$JIS$UTILITY$\',\'OSE$HTTP$ADMIN\',\'CTXSYS\',\'DBSNMP\',\'DIP\',\'DMSYS\',\'EXFSYS\',\'LBACSYS\'\'MDDATA\',\'MDSYS\',\'MGMT_VIEW\',\'MTSSYS\',\'ODM\',\'ODM_MTR\',\'OLAPSYS\',\'OWBSYS\',\'ORDPLUGINS\',\'ORDSYS\',\'OUTLN\',\'SI_INFORMTN_SCHEMA\',\'SYS\',\'SYSMAN\',\'SYSTEM\',\'TSMSYS\',\'WK_TEST\',\'WKSYS\',\'WKPROXY\',\'WMSYS\',\'XDB\')'; } $sSQL .= " UNION "; $sSQL .= "SELECT OWNER, SYNONYM_NAME AS TABLE_NAME,'SYNONYM' AS TYPE FROM SYS.ALL_SYNONYMS"; if(($nOptions&2048)==0) { $sSQL .= " WHERE TABLE_OWNER NOT IN " . '(\'AURORA$ORB$UNAUTHENTICATED\',\'AURORA$JIS$UTILITY$\',\'OSE$HTTP$ADMIN\',\'CTXSYS\',\'DBSNMP\',\'DIP\',\'DMSYS\',\'EXFSYS\',\'LBACSYS\'\'MDDATA\',\'MDSYS\',\'MGMT_VIEW\',\'MTSSYS\',\'ODM\',\'ODM_MTR\',\'OLAPSYS\',\'OWBSYS\',\'ORDPLUGINS\',\'ORDSYS\',\'OUTLN\',\'SI_INFORMTN_SCHEMA\',\'SYS\',\'SYSMAN\',\'SYSTEM\',\'TSMSYS\',\'WK_TEST\',\'WKSYS\',\'WKPROXY\',\'WMSYS\',\'XDB\')'; } } if(($nOptions&4096)!=0) { if(!empty($sSQL)) $sSQL .= " UNION "; $sSQL .= "SELECT OWNER,NAME AS TABLE_NAME, TYPE FROM SYS.ALL_SOURCE WHERE TYPE IN ('PROCEDURE','FUNCTION') GROUP BY OWNER,NAME,TYPE"; } if(!empty($sSQL)) { { $sSQL .= " ORDER BY OWNER,TABLE_NAME,TYPE"; } } $clResultat = $this->query($sSQL); if ($clResultat === false) return false; $tabRetour = array(); while( ($tabBaseDonnees = $clResultat->F5374034a(FMK_AN_FETCH_ASSOC)) !== false ) { $tabRetour[] = $tabBaseDonnees[ 'TABLE_NAME' ]; } return $tabRetour; } function F218cc1a0() { F6b1e3687(); $bEtatConnexion = ($this->m_resConnexionId !== false); F1e7b0563(); if ($bEtatConnexion) { $sSHOW_DATABASES_SQL = "SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA ORDER BY SCHEMA_NAME"; $clResultat = $this->query($sSHOW_DATABASES_SQL); if ($clResultat === false) return false; $tabRetour = array(); while( ($tabBaseDonnees = $clResultat->F5374034a(FMK_AN_FETCH_ASSOC)) !== false ) { $tabRetour[] = reset($tabBaseDonnees); } return $tabRetour; } else { return false; } } function F850edd33(&$sSQL,$tabOptions) { parent::F850edd33($sSQL,$tabOptions); if (isset($tabOptions['LIMIT'])) { $sLimit = uniqid('reqlimit'); if (isset($tabOptions['LIMITFROM'])) { $sSQL = 'SELECT * FROM
							(SELECT '.$sLimit.'.*,ROWNUM WB_PHP_RNUM FROM
								('.$sSQL.')
							'.$sLimit.' WHERE rownum < '. (1+intval($tabOptions['LIMITFROM'])+intval($tabOptions['LIMIT'])).')
						  WHERE WB_PHP_RNUM > ' . intval($tabOptions['LIMITFROM']); } elseif (isset($tabOptions['LIMIT'])) { $sSQL = 'SELECT '.$sLimit.'.* FROM ('.$sSQL.') '.$sLimit.' WHERE rownum < '. (intval($tabOptions['LIMIT'])+1); } } } function query($sSQL,$tabOptions=null, $pclFichier = null) { if (!$this->m_resConnexionId) $this->Fb640a0ce(); if (isset($tabOptions)) { $this->F850edd33($sSQL,$tabOptions); } $this->F5399a982($sSQL); F6b1e3687(); if (!PHPVERSION_5) { $resQuery = ociparse($this->m_resConnexionId,$sSQL); $this->F2b2924d8($resQuery); $bRequeteValide = ociexecute($resQuery); } else { $resQuery = ociparse($this->m_resConnexionId,$sSQL); $this->F2b2924d8($resQuery); $bRequeteValide = oci_execute($resQuery); } F1e7b0563(); if (($bRequeteValide === false)||($resQuery===false)) { return false; } F6b1e3687(); $sTagQuery = (PHPVERSION_5) ? oci_statement_type($resQuery) : ocistatementtype($resQuery); F1e7b0563(); if (empty($sTagQuery)) { $sTagQuery = F9d60968a($sSQL,false); } $tabInformations = array(FMK_AN_INFO_RESTYPE => $sTagQuery); if ($sTagQuery == 'SELECT') { $sCompteurSQL = 'SELECT MAX(ROWNUM) FROM ('.$sSQL.')'; $this->F5399a982($sSQL); F6b1e3687(); if (!PHPVERSION_5) { $resQueryCompteur = ociparse($this->m_resConnexionId,$sCompteurSQL); XVERIFY( ociexecute($resQueryCompteur) ); if (function_exists('ocifetchrow')) { $tab = ocifetchrow ($resQueryCompteur ); } else { ocifetchinto($resQueryCompteur,$tab); } } else { $resQueryCompteur = oci_parse($this->m_resConnexionId,$sCompteurSQL); XVERIFY( oci_execute($resQueryCompteur) ); $tab = oci_fetch_row ($resQueryCompteur ); } F1e7b0563(); if (!is_array($tab)) { $retour = null; } elseif (!isset($tab[0])) { $retour = 0; } else $retour = $tab[0]; $tabInformations[FMK_AN_INFO_ROWCOUNT] = $retour; } return new FMK_AN_Statement_ORACLE($resQuery,$tabInformations); } function F4b3597dc() { return ''; } function F5218fab1() { F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); F1e7b0563(); $sChaineInformationServeur = (PHPVERSION_5) ? oci_server_version($this->m_resConnexionId) : ociserverversion($this->m_resConnexionId); $sVersion = parent::F03323c7e($sChaineInformationServeur); if (empty($sVersion)) return ''; return $sVersion; } function F9cff51f0($pclRubAnalyse,$sValeurExpression,$sOperateurComparaison) { $sNomRubrique = $this->Ff43faec2($pclRubAnalyse,$pclRubAnalyse->sNomBase,(isset($this->m_sClauseEnCours) ? $this->m_sClauseEnCours : 'WHERE')); if ($pclRubAnalyse->F81d228c1()) { switch ($sOperateurComparaison) { case '<>': { return ($sValeurExpression=='') ? (' and '.$sNomRubrique . ' not is null') : (' or '.$sNomRubrique . ' is null'); } break; case '=': { if ($sValeurExpression=='') return ' or '.$sNomRubrique.' is null'; } break; } } return ''; } function F48bb09ec(&$pclRubrique,$Valeur) { $sFormatWD = null; switch($pclRubrique->nType) { case TYPE_DATE : $sFormatSQL = "YYYYMMDD"; $sFormatWD = "YYYYMMDD"; break; case TYPE_HEURE : { switch ($pclRubrique->nTaille) { case 2: $sFormatWD = "HH24"; break; case 4: $sFormatWD = "HH24MI"; break; case 6: $sFormatWD = "HH24MISS"; break; case 8: $sFormatWD = "HH24MISS\"000\""; break; default:$sFormatWD = "HH24MISS"; } $sFormatSQL = "HH24MISS"; } break; case TYPE_DATE_HEURE : $sFormatWD = 'YYYYMMDDHH24MISS"000"'; $sFormatSQL = 'YYYYMMDDHH24MISS'; break; case TYPE_DUREE : $Valeur = utf8_str_pad($Valeur,10,'0',STR_PAD_LEFT); break; case TYPE_MEMO_BINAIRE: if (is_object($Valeur)) { $bVersionBUG38612 = PHPVERSION_5 && (version_compare(PHP_VERSION,'5.2')!==1); $Valeur = (PHPVERSION_5) ? ($bVersionBUG38612? ((string)$Valeur):$Valeur->load()) : ociloadlob($Valeur); } break; default : if ($pclRubrique->F7b5edca9()) { $Valeur = doubleval($Valeur); } break; } if(isset($sFormatWD)) { if (empty($Valeur)) return null; $xNouvelleValeur = $this->Ff31e2a62("SELECT to_char(to_date('".$Valeur."', '".$sFormatSQL."'),'".$sFormatWD."') FROM DUAL"); if (!is_bool($xNouvelleValeur)) $Valeur = $xNouvelleValeur; } return $Valeur; } function Fdee89755(&$Rubrique,$sValeur) { $sResultat = $sValeur; if(!isset($sResultat)) { $sResultat = "NULL"; } else if($Rubrique->F7b5edca9()) { if(!is_numeric($sResultat)) { if (empty($sResultat)) { $sResultat = 0; } else { $sResultat = $this->F90fb578a($sValeur); } } } elseif ($Rubrique->nType == TYPE_DATE) { if (empty($sResultat)) return 'NULL'; $sResultat = 'to_date(\'' . $sResultat . '\',\'YYYYMMDD\')'; } elseif ($Rubrique->nType == TYPE_HEURE) { if (empty($sResultat)) return 'NULL'; $sResultat = 'to_date(\'' . $sResultat . '\',\'HH24MISS\')'; } elseif ($Rubrique->nType == TYPE_DATE_HEURE) { if (empty($sResultat)) return 'NULL'; $sResultat = 'to_date(\'' . $sResultat . '\',\'YYYYMMDDHH24MISS\')'; } else { return parent::Fdee89755($Rubrique,$sResultat); } return $sResultat; } function F137bdb94(&$Rubrique,$sValeur) { $sResultat = $sValeur; if(!isset($sResultat)) { $sResultat = null; } else if($Rubrique->F7b5edca9()) { if(!is_numeric($sResultat)) { if (empty($sResultat)) { $sResultat = 0; } } } elseif ($Rubrique->nType == TYPE_DATE) { $sFormatSQL = 'YYYYMMDD'; $sFormatWD = 'YYYYMMDD'; $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min(8,utf8_strlen($sResultat))),8,'0',STR_PAD_RIGHT); } elseif ($Rubrique->nType == TYPE_HEURE) { $nTaille = $Rubrique->nTaille; switch ($Rubrique->nTaille) { case 2: $sFormatWD = "HH24"; break; case 4: $sFormatWD = "HH24MI"; break; case 6: $sFormatWD = "HH24MISS"; break; default:$sFormatWD = "HH24MISS"; $nTaille = 6; } $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min($nTaille,utf8_strlen($sResultat))),$nTaille,'0',STR_PAD_RIGHT); $sFormatSQL = 'HH24MISS'; } elseif ($Rubrique->nType == TYPE_DATE_HEURE) { $sFormatSQL = 'YYYYMMDDHH24MISS'; $sFormatWD = 'YYYYMMDDHH24MISS'; $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min(14,utf8_strlen($sResultat))),14,'0',STR_PAD_RIGHT); } if (isset($sFormatSQL)) { if (empty($sResultat)) return null; $xNouvelleValeur = $this->Ff31e2a62('SELECT to_char(to_date(\''.$sResultat.'\',\''.$sFormatWD.'\'),\''.$sFormatSQL.'\') FROM DUAL'); if (!is_bool($xNouvelleValeur)) $sResultat = $xNouvelleValeur; } return $sResultat; } function Ff43faec2(&$pclRubrique, $sNomRubrique, $bAvecFormattage) { $sNom = parent::Ff43faec2($pclRubrique,$sNomRubrique,$bAvecFormattage); if ($bAvecFormattage===false) return $sNom; switch($bAvecFormattage) { case 'SELECT': switch ($pclRubrique->nType) { case TYPE_DATE: return 'to_char(' . $sNom . ',\'YYYYMMDD\')'; break; case TYPE_DATE_HEURE: return 'to_char(' . $sNom . ',\'YYYYMMDDHH24MISS\')'; break; case TYPE_HEURE: return 'to_char(' . $sNom . ',\'HH24MISS\')'; break; default: return $sNom; } break; case 'WHERE': { switch ($pclRubrique->nType) { case TYPE_MEMO_BINAIRE: case TYPE_MEMO_TEXTE: case TYPE_MEMO_TEXTE_UNICODE: return 'dbms_lob.substr('.$sNom.',dbms_lob.getlength('.$sNom.') ) '; break; case TYPE_DATE: return 'to_date(to_char(' . $sNom . ',\'YYYYMMDD\'),\'YYYYMMDD\')'; break; case TYPE_DATE_HEURE: return 'to_date(to_char(' . $sNom . ',\'YYYYMMDDHH24MISS\'),\'YYYYMMDDHH24MISS\')'; break; case TYPE_HEURE: return 'to_date(to_char(' . $sNom . ',\'HH24MISS\'),\'HH24MISS\')'; break; default: return $sNom; } } break; default: return $sNom; } return $sNom; } function Fba409abd($nIdConnexion,$sNom, $sNomRequete='') { F6b1e3687(); $tabErreur = PHPVERSION_5 ? oci_error($nIdConnexion) : ocierror($nIdConnexion); if ($tabErreur===false) $tabErreur = PHPVERSION_5 ? oci_error($this->m_resStmt) : ocierror($this->m_resStmt); if ($tabErreur===false) $tabErreur = $this->m_tabCacheError; $sMessageBase = ''; if ($tabErreur!==false) { $sMessageBase = $tabErreur['message']; $nCodeErreur = $tabErreur['code']; $this->m_tabCacheError = $tabErreur; } F1e7b0563(); $bException = true; if (isset($nCodeErreur)) { $bException = false; $gclContextHF =& FMK_ContextHF(); switch(intval($nCodeErreur)) { case 942: $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_OUVERTURE_FICHIER"), $sNomRequete), $nCodeErreur, $this->F0df7c3d7($nCodeErreur, $nIdConnexion), $sNom, ""); $gclContextHF->ErreurHF = $Erreur; SetErreurDetectee(true); break; case 904: $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_SYNCHRO_ANALYSE"), $sNomRequete), $nCodeErreur, $this->F0df7c3d7($nCodeErreur, $nIdConnexion), $sNom, ""); $gclContextHF->ErreurHF = $Erreur; SetErreurDetectee(true); break; default: $bException = true; } } if ($bException) { if(!empty($sNomRequete)) { Erreur('ErreurHF_2_Param',"ErreurExecRequete",FMK_ChaineConstruit(F1ac3f040("ERR_ECHEC_EXEC_REQUETE"), $sNomRequete), $sMessageBase); } else { Erreur('ErreurHF_2_Param',"ErreurExecRequete",F1ac3f040("ERR_ERREUR_INTERNE_ORACLE"), $sMessageBase); } } } function F0df7c3d7($nCodeErreur, $IdConnexion) { return FMK_ChaineConstruit(Fc34ec142("ERR_MESSAGE_BASE"),$this->F5218fab1(),$nCodeErreur,$this->F6b3e9cdf()); } function F90fb578a($pszChaine) { if (is_string($pszChaine)) { $pszChaine = "'".utf8_str_replace("'","''",$pszChaine)."'"; } return $pszChaine; } function F6897ec01( &$pclFichier, $bEtVerifieDescription = null ) { return ($this->Ff31e2a62('SELECT 0 FROM '.$pclFichier->F9047540f().' WHERE rownum=1') !== false); } function F57e42f93($sNom=null) { if (! isset($sNom) ) return ORACLE_ESCAPE_CHAR; if (utf8_strlen($sNom)>30) $sNom = utf8_substr($sNom,0,30); if ( ( (utf8_strpos($sNom,' ')!==false) || (utf8_strpos($sNom,Fd7624002('°'))!==false) || (utf8_strpos($sNom,'_')===0) ) ) { if ($sNom[0]!=ORACLE_ESCAPE_CHAR) return ORACLE_ESCAPE_CHAR . $sNom . ORACLE_ESCAPE_CHAR; } return $sNom; } function Fe172c97d(&$pclFichier) { if ($this->F6897ec01($pclFichier)) { $sRequeteDrop = "DROP TABLE ". $pclFichier->F9047540f(); return $this->query($sRequeteDrop); } return true; } function F585065f5(&$pclFichier) { $sRequeteCreate = "CREATE TABLE ". $pclFichier->F9047540f()." ("; $tabKeys = array_keys( $pclFichier->TabRubriques ); $nOccurrence = count( $tabKeys ); for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sNom =& $tabKeys[ $nKey ]; $Rubrique =& $pclFichier->TabRubriques[ $sNom ]; if(!$Rubrique->Fbe67fb2c()) { $sRequeteCreate .= $Rubrique->F9047540f() ." ".$this->F4c4e336d($Rubrique).", "; } } if(isset($pclFichier->TabClePrimaire)) { foreach($pclFichier->TabClePrimaire as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; $sRequeteCreate .= "PRIMARY KEY (".$Rubrique->F9047540f() ."), "; } } if(isset($pclFichier->TabCleUnique)) { $sRequeteCreate .= $pclFichier->F020cb2dc($pclFichier->TabCleUnique, true); } if(isset($pclFichier->TabCleDoublon)) { $sRequeteCreate .= $pclFichier->F020cb2dc($pclFichier->TabCleDoublon, false); } if(utf8_strpos($sRequeteCreate,", ",utf8_strlen($sRequeteCreate) - 2)) { $sRequeteCreate = utf8_substr($sRequeteCreate, 0, utf8_strlen($sRequeteCreate) - 2); } $sRequeteCreate .= ")"; $bExec = ($this->F52fb3679($sRequeteCreate)!==false); if (isset($this->m_tabPostCreateSQL)) { $i=0; while(isset($this->m_tabPostCreateSQL[$i])) { $bExec = $bExec && ($this->F52fb3679($this->m_tabPostCreateSQL[$i])!==false); ++$i; } } $this->m_tabPostCreateSQL = null; return $bExec; } function F52fb3679($sSql) { $this->F5399a982($sSql); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $resQuery = $this->query($sSql); if ($resQuery === false) { return false; } return $resQuery->F0c638d70();; } function F4c4e336d(&$Rubrique) { $sChaine = ""; switch ($Rubrique->nType) { case TYPE_BINAIRE : $sChaine = "RAW(".$Rubrique->nTaille.")"; break; case TYPE_BOOLEEN : $sChaine = "NUMERIC(3,0)"; break; case TYPE_CARACTERE : $sChaine = "CHARACTER"; break; case TYPE_CHAINE : $sChaine = "VARCHAR2(".$Rubrique->nTaille.")"; break; case TYPE_UNICODE : $sChaine = "NVARCHAR2(".$Rubrique->nTaille.")"; break; case TYPE_DATE : $sChaine = "DATE"; break; case TYPE_DATE_HEURE : $sChaine = "DATE"; break; case TYPE_DUREE : $sChaine = "NUMERIC(19,0)"; break; case TYPE_ENTIER_1 : $sChaine = "NUMERIC(3,0)"; break; case TYPE_ENTIER_2 : $sChaine = "NUMERIC(5,0)"; break; case TYPE_ENTIER_4 : $sChaine = "NUMERIC(10,0)"; break; case TYPE_ENTIER_8 : $sChaine = "NUMERIC(19,0)"; break; case TYPE_ENTIER_NON_SIGNE_1 : $sChaine = "NUMERIC(3,0)"; break; case TYPE_ENTIER_NON_SIGNE_2 : $sChaine = "NUMERIC(5,0)"; break; case TYPE_ENTIER_NON_SIGNE_4 : $sChaine = "NUMERIC(10,0)"; break; case TYPE_ENTIER_NON_SIGNE_8 : $sChaine = "NUMERIC(20,0)"; break; case TYPE_REEL_4 : $sChaine = "REAL"; break; case TYPE_REEL_8 : $sChaine = "FLOAT"; break; case TYPE_HEURE : $sChaine = "DATE"; break; case TYPE_ID_AUTO : $sChaine = "NUMERIC(19,0) NOT NULL"; break; case TYPE_ID_AUTO_4 : $sChaine = "NUMERIC(10,0) NOT NULL"; break; case TYPE_MEMO_BINAIRE : $sChaine = "BLOB"; break; case TYPE_MEMO_TEXTE : $sChaine = "CLOB"; break; case TYPE_MEMO_TEXTE_UNICODE: $sChaine = "NCLOB"; break; case TYPE_MONETAIRE : $sChaine = "NUMERIC(24,6)"; break; case TYPE_DECIMAL : $sChaine = "NUMERIC(".$Rubrique->nTaille.",6)"; break; default : Fe81a7f9e('ERR_RUBRIQUE_TYPE_NON_GERE',$Rubrique->sNom); break; } if ( ($Rubrique->nType != TYPE_ID_AUTO) && ($Rubrique->nType != TYPE_ID_AUTO_4) && ($Rubrique->nType != TYPE_MEMO_TEXTE) && ($Rubrique->nType != TYPE_MEMO_BINAIRE) && ($Rubrique->nType != TYPE_MEMO_TEXTE_UNICODE) ) { if($Rubrique->bNull) { $sChaine .= " DEFAULT NULL"; } else { $sValeurParDefaut = ""; if ((!isset($Rubrique->ValeurDefaut)) || (empty($Rubrique->ValeurDefaut))) { switch ($Rubrique->nType) { case TYPE_BOOLEEN : case TYPE_DUREE : case TYPE_ENTIER_1 : case TYPE_ENTIER_2 : case TYPE_ENTIER_4 : case TYPE_ENTIER_8 : case TYPE_ENTIER_NON_SIGNE_1 : case TYPE_ENTIER_NON_SIGNE_2 : case TYPE_ENTIER_NON_SIGNE_4 : case TYPE_ENTIER_NON_SIGNE_8 : case TYPE_REEL_4 : case TYPE_REEL_8 : case TYPE_MONETAIRE : case TYPE_DECIMAL : $sValeurParDefaut = $this->Fdc8698c9($Rubrique, 0); break; case TYPE_DATE : case TYPE_DATE_HEURE : case TYPE_HEURE : return $sChaine; case TYPE_BINAIRE : case TYPE_CARACTERE : case TYPE_CHAINE : case TYPE_UNICODE : case TYPE_MEMO_BINAIRE : case TYPE_MEMO_TEXTE : case TYPE_MEMO_TEXTE_UNICODE: default : $sValeurParDefaut = "''"; break; } } else { switch ($Rubrique->nType) { case TYPE_DATE: case TYPE_HEURE: case TYPE_DATE_HEURE: return $sChaine; break; default: $sValeurParDefaut = $this->Fdc8698c9($Rubrique, $Rubrique->ValeurDefaut); } } $sChaine .= " DEFAULT ".$sValeurParDefaut; } } return $sChaine; } function F27cfe4f5(&$pclFichier) { $nIdAuto = false; $pclQueryStatement = $pclFichier->F52651677("SELECT MAX(".$this->F57e42f93($pclFichier->IdAuto->sNom). ") FROM ".$this->F57e42f93($pclFichier->Fe8d9985a()), $this->m_resConnexionId, true); if($pclQueryStatement===false) { $this->Fba409abd($this->m_resConnexionId,$pclFichier->sNomLogique); } else { $nIdMax = 0; $nResult = $pclQueryStatement->F3829673d(0); if ($nResult!==false) { $nIdMax = $nResult + 1; } else { $nIdMax = 1; } $pclQueryStatement->Faa2d6e4f(); $nIdAuto = $nIdMax; } return $nIdAuto; } function F7aeb10e1(&$pclFichier,&$Enreg, &$pnIdAuto,&$sNomRubIdAuto, $bForceIdAuto = false,$bEtExecute = true) { $sNomRubIdAuto = null; $nIdAuto = 0; $this->m_sClauseEnCours ='INSERT'; $sRequeteInsert = "INSERT INTO ".$this->F57e42f93($pclFichier->Fe8d9985a()). " ("; $sRequeteValues = " VALUES ("; $nIndex = 0; foreach($Enreg as $sNom => $valeur) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($Rubrique->Fa2afd757()) { $sNomRubIdAuto = $sNom; if(!$bForceIdAuto || $valeur == 0) { $nIdAuto = $this->F27cfe4f5($pclFichier); if(!is_bool($nIdAuto)) { $valeur = $nIdAuto; } else { continue; } } else { if($valeur < 0) { global $sLastFunction; Erreur('ErreurIdAutoNegatif',$sLastFunction, $sNom, $pclFichier->sNomLogique); } } } if($nIndex != 0) { $sRequeteInsert .= ", "; $sRequeteValues .= ", "; } ++$nIndex; $this->m_sClauseEnCours ='INSERT'; $sRequeteInsert .= $this->F57e42f93($Rubrique->sNomBase); $this->m_sClauseEnCours ='VALUES'; $sRequeteValues .= $this->Fdee89755($Rubrique, $valeur);; } } $sRequeteInsert = $sRequeteInsert . ")" . $sRequeteValues . ")"; if (!$bEtExecute) return $sRequeteInsert; $this->m_sClauseEnCours =null; $nResExec = $this->F52fb3679($sRequeteInsert); if(!$bForceIdAuto && isset($sNomRubIdAuto)) { $pnIdAuto = $nIdAuto; } return $nResExec; } function Fbac1b32d(&$pclFichier,$bForceIdAuto = false) { $this->m_sClauseEnCours ='UPDATE'; $sRequeteUpdate = "UPDATE ".$this->F57e42f93($pclFichier->F7653b31e())." SET "; $sRequeteWhere = " WHERE ("; $this->m_sClauseEnCours ='WHERE'; if(isset($pclFichier->TabClePrimaire)) { $sNomClePrimaire = $pclFichier->TabClePrimaire[0]; $ClePrimaire =& $pclFichier->TabRubriques[utf8_strtolower($sNomClePrimaire)]; $sRequeteWhere .= $pclFichier->F0fa6e24e($ClePrimaire, $pclFichier->EnregCourant[$ClePrimaire->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } else if(isset($pclFichier->IdAuto)) { $sRequeteWhere .= $pclFichier->F0fa6e24e($pclFichier->IdAuto, $pclFichier->EnregCourant[$pclFichier->IdAuto->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } $nIndex = 0; foreach($pclFichier->EnregUtilisateur as $sNom => $valeur) { if (!isset($pclFichier->TabRubriques[utf8_strtolower($sNom)])) { continue; } $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($Rubrique->Fa2afd757()) { if($bForceIdAuto && $valeur < 0) { global $sLastFunction; Erreur('ErreurIdAutoNegatif',$sLastFunction, $sNom, $pclFichier->sNomLogique); } else if(!$bForceIdAuto) { $pclFichier->EnregUtilisateur[$sNom] = $pclFichier->EnregCourant[$sNom]; continue; } } if($nIndex != 0) { $sRequeteUpdate .= ", "; } $this->m_sClauseEnCours = 'SET'; $sRequeteUpdate .= $pclFichier->F0fa6e24e($Rubrique,$valeur, TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, false, true); if(!isset($pclFichier->TabClePrimaire) && !isset($pclFichier->IdAuto)) { if($nIndex != 0) { $sRequeteWhere .= " AND "; } $this->m_sClauseEnCours = 'WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($Rubrique, $pclFichier->EnregCourant[$sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } ++$nIndex; } } $sRequeteUpdate = $sRequeteUpdate . $sRequeteWhere . ")"; $this->m_sClauseEnCours = null; return $this->F52fb3679($sRequeteUpdate); } function F100650c1(&$pclFichier) { $this->m_sClauseEnCours ='DELETE'; $sRequeteDelete = "DELETE FROM ".$this->F57e42f93($pclFichier->Fe8d9985a()); $sRequeteWhere = " WHERE ("; $nIndex = 0; foreach(array_keys($pclFichier->EnregCourant) as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $this; } if(!$Rubrique->Fbe67fb2c()) { if($nIndex != 0) { $sRequeteWhere .= " AND "; } ++$nIndex; $this->m_sClauseEnCours ='WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($Rubrique, $pclFichier->EnregCourant[$sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } } $sRequeteDelete .= $sRequeteWhere . ")"; $this->m_sClauseEnCours =null; return $this->F52fb3679($sRequeteDelete); } function F020cb2dc(&$pclFichier, $TabRub, $bUnique) { $sDefIndex = ""; foreach($TabRub as $sNom) { $Rubrique = &$pclFichier->TabRubriques[utf8_strtolower($sNom)]; if($Rubrique->Fa2afd757()) { $sDefIndex .= "PRIMARY KEY "; } else { if($bUnique) { $sDefIndex .= "UNIQUE "; } else { if (!isset($this->m_tabPostCreateSQL)) $this->m_tabPostCreateSQL = array(); if($Rubrique->Fbe67fb2c()) { $sNomIndex = $pclFichier->sNom.'_'.$Rubrique->sNom; $sListeRubriques = ''; foreach(array_keys($Rubrique->TabRubCleComp) as $sRubriqueI) { if(!empty($sListeRubriques)) { $sListeRubriques .= ", "; } $sListeRubriques.= $this->F57e42f93( $sRubriqueI ); } } else { $sNomIndex = $Rubrique->sNom .utf8_substr(uniqid("_wb_"),0,17); $sListeRubriques = $Rubrique->F9047540f(); } $this->m_tabPostCreateSQL[] = "CREATE INDEX " . $this->F57e42f93( $sNomIndex ). " ON ".$pclFichier->F9047540f(). " (" . $sListeRubriques . ")"; continue; } } if($Rubrique->Fbe67fb2c()) { $sDefIndex .= $Rubrique->F9047540f(); $nIndex = count($Rubrique->TabRubCleComp); foreach(array_keys($Rubrique->TabRubCleComp) as $sComposante) { $sDefIndex .= $this->F57e42f93($sComposante); --$nIndex; if($nIndex != 0) { $sDefIndex .= ", "; } } $sDefIndex .= ")"; } else { $sDefIndex .= "(" .$Rubrique->F9047540f(). ")"; } $sDefIndex .= ", "; } return $sDefIndex; } function Fe8d9985a(&$pclFichier) { return $this->F98e40c2c($pclFichier->sNom); } function F7653b31e(&$pclFichier) { return $this->F98e40c2c($pclFichier->sNom); } function Fd5be2853(&$pclFichier,$TabRub, $nTypeParcours) { if(count($TabRub) == 0) { return ""; } $sOrderBy = ""; $nNbRub = count($TabRub); foreach($TabRub as $rubrique) { --$nNbRub; $sRubriqueOrderBy = $rubrique->F0c01be43($this,$nTypeParcours); $sOrderBy.= $sRubriqueOrderBy; if($nNbRub > 0 && !empty($sRubriqueOrderBy)) { $sOrderBy .= ", "; } } return (empty($sOrderBy)) ? $sOrderBy : " ORDER BY " . $sOrderBy; } function F5237a205(&$pclFichier,$TabRub, $nTypeParcours, &$DernierEnregLu) { $sWhere = " WHERE ("; $oldRub = null; $nNbParentheses = 0; foreach($TabRub as $rubrique) { if($rubrique->Fbe67fb2c()) { foreach($rubrique->TabRubCleComp as $composante => $sens ) { $RubComp = $pclFichier->TabRubriques[utf8_strtolower($composante)]; $RubComp->nSens_Parcours = $sens; if(isset($oldRub)) { $sWhere .= " OR (".$pclFichier->F0fa6e24e($oldRub, $DernierEnregLu[$oldRub->sNom], true, $nTypeParcours)." AND ("; $nNbParentheses += 2; } $sWhere .= $pclFichier->F0fa6e24e($RubComp, $DernierEnregLu[$RubComp->sNom], false, $nTypeParcours); $oldRub = $RubComp; } } else if($rubrique->nType == TYPE_CALCULE) { continue; } else { if(isset($oldRub)) { $sWhere .= " OR (".$pclFichier->F0fa6e24e($oldRub, $DernierEnregLu[$oldRub->sNom], true, $nTypeParcours)." AND ("; $nNbParentheses += 2; } $sWhere .= $pclFichier->F0fa6e24e($rubrique, $DernierEnregLu[$rubrique->sNom], false, $nTypeParcours); $oldRub = $rubrique; } } for($i=0;$i<$nNbParentheses;$i++) { $sWhere .= ")"; } return $sWhere.")"; } function F0fa6e24e(&$pclFichier,&$Rubrique, $sValeur, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull = true, $bNomRubriqueBase = false) { if($bNomRubriqueBase) { $sResultat = $this->Ff43faec2( $Rubrique , $Rubrique->sNomBase, (isset($this->m_sClauseEnCours) ? $this->m_sClauseEnCours : 'WHERE') ); } else { $sResultat = $this->Ff43faec2( $Rubrique , $Rubrique->sNom, (isset($this->m_sClauseEnCours) ? $this->m_sClauseEnCours : 'WHERE') ); } if( (!isset($sValeur)||($sValeur=='')) && $bNull) { if($nTypeCompare == TYPE_COMP_EGAL) { $sResultat.=" IS NULL"; } else { $sResultat.=" IS NOT NULL"; } return $sResultat; } if($nTypeCompare == TYPE_COMP_EGAL) { $sResultat .= " = "; } else if($nTypeCompare == TYPE_COMP_COMMENCE_PAR) { if($Rubrique->F7b5edca9()) { $sResultat .= " = "; } else { $sResultat .= " LIKE "; $sResultat .= $this->Fdee89755($Rubrique, $sValeur."%"); return $sResultat; } } else { if($Rubrique->F19c595c2()) { if($nTypeParcours == PARCOURS_PREMIER_SUIVANT) { $sResultat .= " >"; } else { $sResultat .= " <"; } } else { if($nTypeParcours == PARCOURS_PREMIER_SUIVANT) { $sResultat .= " <"; } else { $sResultat .= " >"; } } if($nTypeCompare == TYPE_COMP_INF_EGAL || $nTypeCompare == TYPE_COMP_SUP_EGAL) { $sResultat .= "= "; } else { $sResultat .= " "; } } $sResultat .= $this->Fdee89755($Rubrique,$sValeur); return $sResultat; } function F25514b5d(&$pclFichier,$sValCleComp, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull, &$FirstComp) { $sResultat = ""; $sValCleComp = utf8_substr($sValCleComp, 1); $hVal = ""; if((utf8_strpos($sValCleComp, H_VAL_MIN) == (utf8_strlen($sValCleComp) - 1)) || (utf8_strpos($sValCleComp, H_VAL_MAX) == (utf8_strlen($sValCleComp) - 1))) { $hVal = utf8_substr($sValCleComp, (utf8_strlen($sValCleComp) - 1)); $sValCleComp = utf8_substr($sValCleComp, 0, (utf8_strlen($sValCleComp) - 1)); } $TabComposante = utf8_explode(SEPARATEUR_COMPOSANTE, $sValCleComp); $nBorneMax=count($TabComposante); for($i=0;$i<$nBorneMax;$i++) { $TabCoupleCleValeur = utf8_explode(SEPARATEUR_VALEUR, $TabComposante[$i]); if($i > 0) { $sResultat .= " AND "; } else { $FirstComp = $TabCoupleCleValeur; } $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($TabCoupleCleValeur[0])]; $sResultat .= $pclFichier->F0fa6e24e($Rubrique, $this->F137bdb94($Rubrique,$TabCoupleCleValeur[1].$hVal), $nTypeCompare, $nTypeParcours, $bNull); } return $sResultat; } function Fa7a7772d($sCodeRequete1, $sCodeRequete2,$bAll) { return 'SELECT * FROM (' . $sCodeRequete1 . ') UNION' . ($bAll ? ' ALL' : '') . ' SELECT * FROM (' . $sCodeRequete2.') '; } function F4500afc6(&$pclOpExpression) { $sCodeExpression=null; switch($pclOpExpression->m_nOpExpression) { case eMATH_UUID: return '(SELECT SYS_GUID() FROM dual)'; break; case eCOMP_EGAL: case eCOMP_DIF: { if ($pclOpExpression->m_tabItems[0]->m_nClasse == FMK_SQL_CLASSE_RUBRIQUE) { $pclRub =& $pclOpExpression->m_tabItems[0]; if ( ($pclOpExpression->m_tabItems[1]->m_nClasse == FMK_SQL_CLASSE_ITEM)||($pclOpExpression->m_tabItems[1]->m_nClasse == FMK_SQL_CLASSE_PARAM) ) { $pclItem =& $pclOpExpression->m_tabItems[1]; } } elseif ( ($pclOpExpression->m_tabItems[0]->m_nClasse == FMK_SQL_CLASSE_ITEM)||($pclOpExpression->m_tabItems[0]->m_nClasse == FMK_SQL_CLASSE_PARAM) ) { $pclItem =& $pclOpExpression->m_tabItems[0]; if ($pclOpExpression->m_tabItems[1]->m_nClasse == FMK_SQL_CLASSE_RUBRIQUE) { $pclRub =& $pclOpExpression->m_tabItems[1]; } } if (isset($pclItem)&&isset($pclRub)) { $sValeur = Ffaa5b6f5($pclItem,$this,true); if (isset($sValeur)) { $sOpExpression = $pclOpExpression->m_sOpExpression; $pclRubAnalyse =& $this->Fae15aba3($pclRub->m_sNomFichier,$pclRub->m_sNom); if (isset($pclRubAnalyse)) { $sRub = Ffaa5b6f5($pclRub,$this) ; $sValeurRequete = $sValeur; $this->F3f69ad5f($pclRub,$sRubUNUSED,$pclItem,$sValeurRequete); return '(' . $sRub . $sOpExpression .$sValeurRequete. $this->F9cff51f0($pclRubAnalyse,$sValeur,$sOpExpression) . ')'; } } } return parent::F4500afc6($pclOpExpression); } break; case eSTRING_LEFT: case eSTRING_RIGHT: case eSTRING_MID: $sCodeOperandeChaine = Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this); if (!isset($sCodeOperandeChaine)) return null; $nNbItems = 0; if ($pclOpExpression->m_nOpExpression == eSTRING_MID) { $nValMin = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); $nValMax = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal2']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal2'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); } else if ($pclOpExpression->m_nOpExpression == eSTRING_LEFT) { $nValMin = '1'; $nValMax = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); } else { XASSERT ($pclOpExpression->m_nOpExpression == eSTRING_RIGHT); $nValMin = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); $nValMax = null; } $sFonctionSubstr = 'SUBSTR'; if ($pclOpExpression->m_tabItems[0]->m_nClasse === FMK_SQL_CLASSE_RUBRIQUE) { $pclRubriqueRequete =& $pclOpExpression->m_tabItems[0]; $pclRubrique =& $this->Fae15aba3($pclRubriqueRequete->m_sNomFichier,$pclRubriqueRequete->m_sNom); if ( ($pclRubrique->nType === TYPE_MEMO_TEXTE) ||($pclRubrique->nType === TYPE_MEMO_TEXTE_UNICODE) || ($pclRubrique->nType === TYPE_MEMO_BINAIRE)) { $sFonctionSubstr = 'dbms_lob.SUBSTR'; } } $sCodeExpression = $sFonctionSubstr .'(' . $sCodeOperandeChaine . ','; $sCodeExpression.=$nValMin; if (isset($nValMax)) { $sCodeExpression.=','.$nValMax; } $sCodeExpression.=')'; break; default: return parent::F4500afc6($pclOpExpression); } return $sCodeExpression; } function Fe47eea61(&$pclRequete) { $this->Faa055082($pclRequete , 'LIMIT'); $pclLimit =& $pclRequete->m_clLimit; if (isset($pclLimit)) { $nType = $pclLimit->m_nType; $nOffset = $pclLimit->m_nDepuis; $nEnregs = $pclLimit->m_nNombreEnregs; $sLimit = uniqid('reqlimit'); switch ($nType) { case eTOP: { $sCodeSQL = 'SELECT '.$sLimit.'.* FROM ('.$pclRequete->m_pszCodeSQLEnCours.') '.$sLimit.' WHERE rownum < '. ($nEnregs+1); $pclRequete->m_pszCodeSQLEnCours = ''; return $sCodeSQL; } break; case eBOTTOM: { $sCodeSQL = 'SELECT '.$sLimit.'.* FROM ('.$pclRequete->m_pszCodeSQLEnCours.') '.$sLimit.' WHERE rownum > '. $nOffset; $pclRequete->m_pszCodeSQLEnCours = ''; return $sCodeSQL; } break; case eLIMIT_MYSQL: case eLIMIT_POSTGRESQL: { $sCodeSQL = 'SELECT * FROM (SELECT '.$sLimit.'.*,ROWNUM WB_PHP_RNUM FROM ('.$pclRequete->m_pszCodeSQLEnCours.')
									'.$sLimit.' WHERE rownum < '. ($nEnregs+$nOffset+1) .') WHERE WB_PHP_RNUM > ' . $nOffset; $pclRequete->m_pszCodeSQLEnCours = ''; return $sCodeSQL; } break; case eEVERY: break; default: } } return null; } } class FMK_AN_Statement_ORACLE extends FMK_AN_Statement { function FMK_AN_Statement_ORACLE($resQuery,$tabInformations = null) { parent::FMK_AN_Statement($resQuery,$tabInformations); } function F5374034a($nFetchType = FMK_AN_FETCH_BOTH, $cursor_orientation = null, $cursor_offset = null) { if (!isset($nFetchType)) $nFetchType = FMK_AN_FETCH_BOTH ; switch ($nFetchType) { case FMK_AN_FETCH_BOTH: { if (PHPVERSION_5) { F6b1e3687(); $tabPgFetch = oci_fetch_array($this->m_resQuery,OCI_BOTH); F1e7b0563(); } else { F6b1e3687(); ocifetchinto($this->m_resQuery,$tabPgFetch,OCI_ASSOC+OCI_NUM+OCI_RETURN_NULLS+OCI_RETURN_LOBS); F1e7b0563(); } if ($tabPgFetch === false) { return false; } return $tabPgFetch; } break; case FMK_AN_FETCH_ASSOC: { if (PHPVERSION_5) { F6b1e3687(); $tabPgFetch = oci_fetch_assoc($this->m_resQuery); F1e7b0563(); } else { F6b1e3687(); ocifetchinto($this->m_resQuery,$tabPgFetch,OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS); F1e7b0563(); } if ($tabPgFetch === false) { return false; } return $tabPgFetch; } break; case FMK_AN_FETCH_LAZY: { if (PHPVERSION_5) { F6b1e3687(); $tabPgFetch = oci_fetch_object($this->m_resQuery); F1e7b0563(); return $tabPgFetch; } else { F6b1e3687(); ocifetchinto($this->m_resQuery,$tabPgFetch,OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS); F1e7b0563(); } if ($tabPgFetch === false) { return false; } $clResultat = new FMK_AN_Row(); F34bbd047($clResultat,$tabPgFetch); unset($tabPgFetch); return $clResultat; } break; case FMK_AN_FETCH_OBJ: { if (PHPVERSION_5) { F6b1e3687(); $tabPgFetch = oci_fetch_assoc($this->m_resQuery); F1e7b0563(); } else { F6b1e3687(); ocifetchinto($this->m_resQuery,$tabPgFetch,OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS); F1e7b0563(); } if ($tabPgFetch === false) { return false; } $clResultat = new stdClass(); F34bbd047($clResultat,$tabPgFetch); unset($tabPgFetch); return $clResultat; } default: return false; } } function F6e51814c() { } function F210e6480() { return $this->F0c638d70(); } function F0c638d70() { F6b1e3687(); $nOccurrence = (PHPVERSION_5) ? oci_num_rows($this->m_resQuery) : ocirowcount($this->m_resQuery); F1e7b0563(); return $nOccurrence; } function F36a82aa8() { F6b1e3687(); $nColCount = (PHPVERSION_5) ? oci_num_fields($this->m_resQuery) : ocinumfields($this->m_resQuery); F1e7b0563(); return $nColCount; } function Faa2d6e4f() { F6b1e3687(); if (PHPVERSION_5) { oci_free_statement($this->m_resQuery); } else { ocifreestatement($this->m_resQuery); } F1e7b0563(); } } class FMK_BufferParcours_ORACLE extends FMK_BufferParcours { function FMK_BufferParcours_ORACLE(&$Rubrique, $nIdModif, $sValeur = null, $bIdentique = false, $bLimiteParcours = false) { parent::FMK_BufferParcours($Rubrique, $nIdModif, $sValeur , $bIdentique , $bLimiteParcours ); } function Ff394115b(&$pclQueryStatement) { $nIndex = $this->nPosition; if($nIndex != 0) { ++$nIndex; } $nCount = null; $tabNomsLogiques = array(); while(($Enreg = $pclQueryStatement->F5374034a(FMK_AN_FETCH_ASSOC)) != 0) { $EnregNomsLogiques = array(); if (!isset($nCount)) { $nCount = count($Enreg); $tabKeys = array_keys($Enreg); for($i=0; $i<$nCount; $i++) { $sNomBdd = $tabKeys[$i]; $pclRub =& F2b6640f3($this->RubriqueParcours->Fichier,$sNomBdd,false); if (isset($pclRub)) { $tabNomsLogiques[$i] = $pclRub->sNom; } else { $tabNomsLogiques[$i] = $tabKeys[$i]; } } } $bVersionBUG38612 = PHPVERSION_5 && (version_compare(PHP_VERSION,'5.2')!==1); for($i=0; $i<$nCount; $i++) { $sNomBdd = $tabKeys[$i]; if ($sNomBdd == 'WB_PHP_RNUM') continue; $EnregNomsLogiques[$tabNomsLogiques[$i] ] = $Enreg[ $sNomBdd ]; $pclValeur =& $EnregNomsLogiques[$tabNomsLogiques[$i] ]; if (is_object($pclValeur)) { $pclValeur = (PHPVERSION_5) ? ($bVersionBUG38612? ((string)$pclValeur):$pclValeur->load()) : ociloadlob($pclValeur); } } $this->Cache[$nIndex] = $EnregNomsLogiques; ++$nIndex; } $pclQueryStatement->Faa2d6e4f(); } } ?>