<?php
//20.0.56.0 WL/HF/AN/Pgsql.php GF 
//VersionVI: 30F200066p
//(c) 2005-2012 PC SOFT  - Release
 F3f50a0c6(HF_PGSQL); define('PGSQL_ESCAPE_CHAR','"'); class FMK_AN_PGSQL extends FMK_AN { var $m_tabPostCreateSQL; function FMK_AN_PGSQL($sHost=null,$sDB=null,$sUser=null,$sPass=null,$sInfosEtendues=null) { parent::FMK_AN($sHost,$sDB,$sUser,$sPass,$sInfosEtendues); } function F22067d84() { return TYPE_BASE_PGSQL; } function Fb640a0ce($bErreur = true, $sMdp = null, $bCreateDatabse = false) { if (!function_exists( 'pg_connect' )) { if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, utf8_sprintf(F1ac3f040("ERR_LIB_SQL_NON_TROUVEE"),"PostegrSQL")); } return false; } F6b1e3687(); $this->m_resConnexionId = pg_connect('host='.$this->m_sServeur.' dbname=\''.$this->m_sBase.'\' user=\''.$this->m_sUtilisateur.'\' password=\''.((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse).'\''); F1e7b0563(); if (!$this->m_resConnexionId) { $pg_last_error = pg_last_error(); if ($bCreateDatabse) { F6b1e3687(); $this->m_resConnexionId = pg_connect('host='.$this->m_sServeur.' user=\''.$this->m_sUtilisateur.'\' password=\''.((isset($sMdp)) ? $sMdp : $this->m_sMotDePasse).'\''); F1e7b0563(); if ($this->m_resConnexionId !== false) { if ($this->Fe47ec54f()) $this->Fa6486962($this->m_resConnexionId); $res = $this->query('CREATE DATABASE ' . $this->m_sBase . ($this->Fe47ec54f()? " WITH ENCODING 'UTF8'" : '')); if (!$res) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, $this->F6b3e9cdf()); } else { return $this->Fb640a0ce($bErreur,$sMdp,false); } } } if($bErreur) { global $sLastFunction; F6b1e3687(); $pg_last_error = pg_last_error(); F1e7b0563(); Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, $pg_last_error); } } else { if ($this->Fe47ec54f()) $this->Fa6486962($this->m_resConnexionId); } return true; } function Fa6486962($conn) { pg_set_client_encoding('UTF-8'); $res = pg_query('SHOW client_encoding;'); $obj = pg_fetch_object($res); } function F9d634e1a() { F6b1e3687(); pg_close($this->m_resConnexionId); F1e7b0563(); } function F6b3e9cdf() { F6b1e3687(); $sMessage = pg_last_error(); F1e7b0563(); return $sMessage; } function F218cc1a0() { F6b1e3687(); $bEtatConnexion = (pg_connection_status($this->m_resConnexionId) === PGSQL_CONNECTION_OK); F1e7b0563(); if ($bEtatConnexion) { $sSHOW_DATABASES_SQL = "SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA ORDER BY SCHEMA_NAME"; $clResultat = $this->query($sSHOW_DATABASES_SQL); if ($clResultat === false) return false; $tabRetour = array(); while( ($tabBaseDonnees = $clResultat->F5374034a(FMK_AN_FETCH_ASSOC)) !== false ) { $tabRetour[] = reset($tabBaseDonnees); } return $tabRetour; } else { return false; } } function Fa7865f89($nFlags=null) { if (!isset($nFlags)) $nFlags = 512; if (!$this->m_resConnexionId) $this->Fb640a0ce(); if (empty($this->m_sBase)) return ''; $clstrQuery = ("SELECT pg_namespace.nspname || '.' || pg_class.relname, '', pg_user.usename,") .("	CASE") .("		WHEN (pg_namespace.nspname like 'pg_%' OR pg_namespace.nspname like 'information_schema') AND pg_class.relkind='r' THEN 'SYSTEM TABLE'") .("		WHEN (pg_namespace.nspname like 'pg_%' OR pg_namespace.nspname like 'information_schema') AND pg_class.relkind='v' THEN 'SYSTEM VIEW'") .("		WHEN pg_class.relkind='r' THEN 'TABLE'") .("		WHEN pg_class.relkind='v' THEN 'VIEW'") .("		ELSE 'OTHER'") .("	END") .("	FROM pg_class, pg_namespace, pg_user") .("	WHERE pg_class.relnamespace = pg_namespace.oid") .("	AND (pg_class.relkind='r' OR pg_class.relkind='v')") .("	AND pg_class.relowner = pg_user.usesysid") ; $csConditionType = ''; $bTable = (Fdef56c7f($nFlags,512)); $bView = (Fdef56c7f($nFlags,1024)); $bTableSysteme = (Fdef56c7f($nFlags,2048)); if(!$bTableSysteme) { $clstrQuery.=(" AND pg_namespace.nspname not like 'pg_%' AND pg_namespace.nspname not like 'information_schema'"); } if(!$bTable) { if($bTableSysteme) { $clstrQuery.=((" AND (pg_class.relkind<>'r' OR pg_namespace.nspname like 'pg_%' OR pg_namespace.nspname like 'information_schema')")); } else { $clstrQuery.=((" AND pg_class.relkind<>'r'")); } } if(!$bView) { if($bTableSysteme) { $clstrQuery.=((" AND (pg_class.relkind<>'v' OR pg_namespace.nspname like 'pg_%' OR pg_namespace.nspname like 'information_schema')")); } else { $clstrQuery.=((" AND pg_class.relkind<>'v'")); } } $clstrQuery.=((" ORDER BY pg_class.relname")); $clResultat = $this->query($clstrQuery); if ($clResultat === false) return false; $tabRetour = array(); while( ($tabBaseDonnees = $clResultat->F5374034a(FMK_AN_FETCH_BOTH)) !== false ) { $tabRetour[] = $tabBaseDonnees[0]; } return $tabRetour; } function F850edd33(&$sSQL,$tabOptions) { parent::F850edd33($sSQL,$tabOptions); if (isset($tabOptions['LIMIT'])) { $sSQL .= " LIMIT ". intval($tabOptions['LIMIT']); if (isset($tabOptions['LIMITFROM'])) { $sSQL .= " OFFSET ". intval($tabOptions['LIMITFROM']); } } } function query($sSQL,$tabOptions=null, $pclFichier = null) { if (!$this->m_resConnexionId) $this->Fb640a0ce(); if (isset($tabOptions)) { $this->F850edd33($sSQL,$tabOptions); } $this->F5399a982($sSQL); F6b1e3687(); $resQuery = pg_query($this->m_resConnexionId,$sSQL); F1e7b0563(); if ($resQuery === false) { return false; } return new FMK_AN_Statement_PGSQL($resQuery); } function F4b3597dc() { F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $bEtatConnexion = (pg_connection_status($this->m_resConnexionId) === PGSQL_CONNECTION_OK); F1e7b0563(); if ($bEtatConnexion) { $tabinfos = pg_version($this->m_resConnexionId); if (!isset($tabinfos['client'])) return ''; return $tabinfos['client']; } else { return ''; } } function F5218fab1() { F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $bEtatConnexion = (pg_connection_status($this->m_resConnexionId) === PGSQL_CONNECTION_OK); F1e7b0563(); if ($bEtatConnexion) { $sChaineInformationServeur = $this->Ff31e2a62("select version()"); $sVersion = parent::F03323c7e($sChaineInformationServeur); if (empty($sVersion)) return ''; return $sVersion; } else { return ''; } } function F48bb09ec(&$pclRubrique,$Valeur) { $sFormat = ""; switch($pclRubrique->nType) { case TYPE_DATE : $Valeur = 'to_date(\'' . $Valeur.'\',\'YYYY-MM-DD\')'; $sFormat = "YYYYMMDD"; break; case TYPE_HEURE : { $Valeur = 'to_timestamp(\'' . $Valeur.'\',\'HH24:MI:SS-MS\')'; $sFormat = "HH24MISSMS"; } break; case TYPE_DATE_HEURE : $Valeur = 'to_timestamp(\'' . $Valeur.'\',\'YYYY-MM-DD HH24:MI:SS-MS\')'; $sFormat = "YYYYMMDDHH24MISSMS"; break; case TYPE_DUREE : $Valeur = utf8_str_pad($Valeur,10,'0',STR_PAD_LEFT); break; default : if ($pclRubrique->F7b5edca9()) { $Valeur = doubleval($Valeur); } break; } if(!empty($sFormat)) { if (empty($Valeur)) return null; F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $id_result = pg_query($this->m_resConnexionId,"SELECT to_char(".$Valeur.", '".$sFormat."')"); if($id_result!==false) { $Valeur = pg_result($id_result,0); } F1e7b0563(); if (($pclRubrique->nType==TYPE_HEURE) && (utf8_strlen($Valeur)>$pclRubrique->nTaille)) { $Valeur = utf8_substr($Valeur,0,$pclRubrique->nTaille); } } return $Valeur; } function Fdee89755(&$Rubrique,$sValeur) { $sResultat = $sValeur; if(!isset($sResultat)) { $sResultat = 'NULL'; } else if($Rubrique->nType==TYPE_BOOLEEN) { $sResultat = VersBooleen($sResultat) ? 'TRUE' : 'FALSE'; } else if($Rubrique->F7b5edca9()) { if(!is_numeric($sResultat)) { if (empty($sResultat)) { $sResultat = 0; } else { $sResultat = $this->F90fb578a($sResultat); } } } else { switch($Rubrique->nType) { case TYPE_DATE: if (!isset($sFormatSQL)) { $sFormatSQL = 'YYYY-MM-DD'; $sCommandeSQL = 'to_date'; } case TYPE_DATE_HEURE: if (!isset($sFormatSQL)) { $sFormatSQL = 'YYYY-MM-DD HH24:MI:SS-MS'; $sCommandeSQL = 'to_timestamp'; } case TYPE_HEURE: if(empty($sResultat)) { return 'NULL'; } else { if (isset($sFormatSQL)) { return $sCommandeSQL .'(\''.$sResultat.'\',\''.$sFormatSQL.'\')'; } else { return $this->F90fb578a($sResultat); } } default: return parent::Fdee89755($Rubrique,$sResultat); } } return $sResultat; } function F137bdb94(&$Rubrique,$sValeur) { $sResultat = $sValeur; if(!isset($sValeur)) { $sResultat = null; } else if($Rubrique->F7b5edca9()) { if(!is_numeric($sResultat)) { if (empty($sResultat)) { $sResultat = 0; } } } else { switch($Rubrique->nType) { case TYPE_DATE: if (!isset($sFormatSQL)) { $sFormatSQL = 'YYYY-MM-DD'; $sFormatWD = 'YYYYMMDD'; $sCommandeSQL = 'to_date'; $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min(8,utf8_strlen($sResultat))),8,'0',STR_PAD_RIGHT); } case TYPE_DATE_HEURE: if (!isset($sFormatSQL)) { $sFormatSQL = 'YYYY-MM-DD HH24:MI:SS-MS'; $sFormatWD = 'YYYYMMDDHH24MISSMS'; $sCommandeSQL = 'to_timestamp'; $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min(17,utf8_strlen($sResultat))),17,'0',STR_PAD_RIGHT); } case TYPE_HEURE: if (!isset($sFormatSQL)) { $sFormatSQL = 'HH24:MI:SS-MS'; $sFormatWD = 'HH24MISSMS'; $sCommandeSQL = 'to_timestamp'; $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min($Rubrique->nTaille,utf8_strlen($sResultat))),$Rubrique->nTaille,'0',STR_PAD_RIGHT); } if(empty($sResultat)) { return null; } F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $id_result = pg_query($this->m_resConnexionId,"SELECT to_char(".$sCommandeSQL."('".$sResultat."','".$sFormatWD."'), '".$sFormatSQL."')"); if($id_result!==false) { $sResultat = pg_result($id_result,0); } F1e7b0563(); break; default: break; } } return $sResultat; } function F90fb578a($pszChaine) { if (is_string($pszChaine)) { if ($this->m_resConnexionId == 0) $this->Fb640a0ce(); $nIdConnexion = $this->m_resConnexionId; if (!empty($pszChaine)) { F6b1e3687(); if (PHPVERSION_5) { $pszChainePHP5 = pg_escape_string($nIdConnexion , $pszChaine); if (empty($pszChainePHP5)) { $pszChaine = pg_escape_string( $pszChaine); } else { $pszChaine = $pszChainePHP5; } } else { $pszChaine = pg_escape_string( $pszChaine); } F1e7b0563(); } return "'".$pszChaine."'"; } return $pszChaine; } function F6e9e8df8($pszChaine) { return "'".pg_escape_bytea($pszChaine)."'"; } function Fba409abd($nIdConnexion,$sNom, $sNomRequete='') { F6b1e3687(); $sMessageBase = (function_exists('pg_errormessage')) ? pg_errormessage($nIdConnexion) : pg_last_error($nIdConnexion); F1e7b0563(); if (!empty($sMessageBase) && (utf8_strpos($sMessageBase,'does not exist')!==false)) { $gclContextHF =& FMK_ContextHF(); if ( (utf8_strpos($sMessageBase,'relation')!==false)) { $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_OUVERTURE_FICHIER"), $sNomRequete), '', $this->F0df7c3d7('', $nIdConnexion), $sNom, ''); $gclContextHF->ErreurHF = $Erreur; SetErreurDetectee(true); return; } elseif ( (utf8_strpos($sMessageBase,'column')!==false)) { $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_SYNCHRO_ANALYSE"), $sNomRequete), '', $this->F0df7c3d7('', $nIdConnexion), $sNom, ''); $gclContextHF->ErreurHF = $Erreur; SetErreurDetectee(true); return; } } if(!empty($sMessageBase)) { if(!empty($sNomRequete)) { Erreur('ErreurHF_2_Param',"ErreurExecRequete",FMK_ChaineConstruit(F1ac3f040("ERR_ECHEC_EXEC_REQUETE"), $sNomRequete), $sMessageBase); } else { Erreur('ErreurHF_2_Param',"ErreurExecRequete",F1ac3f040("ERR_ERREUR_INTERNE_PGSQL"), $sMessageBase); } } } function Ff43faec2(&$pclRubrique, $sNomRubrique, $bAvecFormattage) { $sNom = parent::Ff43faec2($pclRubrique,$sNomRubrique,$bAvecFormattage); if ($bAvecFormattage===false) return $sNom; switch($bAvecFormattage) { case 'SELECT': switch ($pclRubrique->nType) { case TYPE_DATE: return 'to_char(' . $sNom . ',\'YYYY-MM-DD\')'; break; case TYPE_DATE_HEURE: return 'to_char(' . $sNom . ',\'YYYY-MM-DD HH24:MI:SS-MS\')'; break; case TYPE_HEURE: return 'to_char(' . $sNom . ',\'HH24:MI:SS-MS\')'; break; default: return $sNom; } break; case 'WHERE': switch ($pclRubrique->nType) { case TYPE_DATE: case TYPE_DATE_HEURE: case TYPE_HEURE: default: return $sNom; } break; default: return $sNom; break; } } function F0df7c3d7($nCodeErreur, $IdConnexion) { return FMK_ChaineConstruit(Fc34ec142("ERR_MESSAGE_BASE"),$this->F5218fab1(),$nCodeErreur,pg_last_error($IdConnexion)); } function F6897ec01( &$pclFichier, $bEtVerifieDescription = null ) { return ($this->Ff31e2a62('SELECT 0 FROM '. $pclFichier->F9047540f().' LIMIT 1')!==false); } function F57e42f93($sNom=null) { return (isset ( $sNom ) && ($sNom[0]!=PGSQL_ESCAPE_CHAR)) ? (PGSQL_ESCAPE_CHAR . $sNom . PGSQL_ESCAPE_CHAR) : PGSQL_ESCAPE_CHAR; } function Fe172c97d(&$pclFichier) { $sRequeteDrop = "DROP TABLE IF EXISTS ". $pclFichier->F9047540f(); return $this->query($sRequeteDrop); } function F585065f5(&$pclFichier) { $sRequeteCreate = "CREATE TABLE ". $pclFichier->F9047540f()." ("; $tabKeys = array_keys( $pclFichier->TabRubriques ); $nOccurrence = count( $tabKeys ); for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sNom =& $tabKeys[ $nKey ]; $Rubrique =& $pclFichier->TabRubriques[ $sNom ]; if(!$Rubrique->Fbe67fb2c()) { $sRequeteCreate .= $Rubrique->F9047540f() ." ".$this->F4c4e336d($Rubrique).", "; } } if(isset($pclFichier->TabClePrimaire)) { foreach($pclFichier->TabClePrimaire as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; $sRequeteCreate .= "PRIMARY KEY (".$Rubrique->F9047540f() ."), "; } } if(isset($pclFichier->TabCleUnique)) { $sRequeteCreate .= $pclFichier->F020cb2dc($pclFichier->TabCleUnique, true); } if(isset($pclFichier->TabCleDoublon)) { $sRequeteCreate .= $pclFichier->F020cb2dc($pclFichier->TabCleDoublon, false); } if(utf8_strpos($sRequeteCreate,", ",utf8_strlen($sRequeteCreate) - 2)) { $sRequeteCreate = utf8_substr($sRequeteCreate, 0, utf8_strlen($sRequeteCreate) - 2); } $sRequeteCreate .= ")"; $bExec = ($this->F52fb3679($sRequeteCreate)!==false); if (isset($this->m_tabPostCreateSQL)) { $i=0; while(isset($this->m_tabPostCreateSQL[$i])) { $bExec = $bExec && ($this->F52fb3679($this->m_tabPostCreateSQL[$i])!==false); ++$i; } } $this->m_tabPostCreateSQL = null; return $bExec; } function F52fb3679($sSql) { $this->F5399a982($sSql); if (!$this->m_resConnexionId) $this->Fb640a0ce(); F6b1e3687(); $resQuery = pg_query($this->m_resConnexionId,$sSql); F1e7b0563(); if ($resQuery === false) { return false; } F6b1e3687(); $nRows = pg_affected_rows($resQuery); F1e7b0563(); return $nRows; } function F4c4e336d(&$Rubrique) { $sChaine = ""; switch ($Rubrique->nType) { case TYPE_BINAIRE : $sChaine = "BYTEA"; break; case TYPE_BOOLEEN : $sChaine = "BOOLEAN"; break; case TYPE_CARACTERE : $sChaine = "CHARACTER"; break; case TYPE_UNICODE : case TYPE_CHAINE : $sChaine = "VARCHAR(".$Rubrique->nTaille.")"; break; case TYPE_DATE : $sChaine = "DATE"; break; case TYPE_DATE_HEURE : $sChaine = "TIMESTAMP"; break; case TYPE_DUREE : $sChaine = "NUMERIC(19,0)"; break; case TYPE_ENTIER_1 : $sChaine = "SMALLINT"; break; case TYPE_ENTIER_2 : $sChaine = "SMALLINT"; break; case TYPE_ENTIER_4 : $sChaine = "INTEGER"; break; case TYPE_ENTIER_8 : $sChaine = "BIGINT"; break; case TYPE_ENTIER_NON_SIGNE_1 : $sChaine = "SMALLINT"; break; case TYPE_ENTIER_NON_SIGNE_2 : $sChaine = "SMALLINT"; break; case TYPE_ENTIER_NON_SIGNE_4 : $sChaine = "INTEGER"; break; case TYPE_ENTIER_NON_SIGNE_8 : $sChaine = "NUMERIC(20,0)"; break; case TYPE_REEL_4 : $sChaine = "REAL"; break; case TYPE_REEL_8 : $sChaine = "FLOAT8"; break; case TYPE_HEURE : $sChaine = "TIME"; break; case TYPE_ID_AUTO : $sChaine = "SERIAL8 NOT NULL"; break; case TYPE_ID_AUTO_4 : $sChaine = "SERIAL4 NOT NULL"; break; case TYPE_MEMO_BINAIRE : $sChaine = "BYTEA"; break; case TYPE_MEMO_TEXTE_UNICODE: case TYPE_MEMO_TEXTE : $sChaine = "TEXT"; break; case TYPE_MONETAIRE : $sChaine = "NUMERIC(24,6)"; break; case TYPE_DECIMAL : $sChaine = "NUMERIC(".$Rubrique->nTaille.",6)"; break; default : Fe81a7f9e('ERR_RUBRIQUE_TYPE_NON_GERE',$Rubrique->sNom); break; } if ( ($Rubrique->nType != TYPE_ID_AUTO) && ($Rubrique->nType != TYPE_ID_AUTO_4) && ($Rubrique->nType != TYPE_MEMO_TEXTE) && ($Rubrique->nType != TYPE_MEMO_TEXTE_UNICODE) && ($Rubrique->nType != TYPE_MEMO_BINAIRE) ) { if($Rubrique->bNull) { $sChaine .= " DEFAULT NULL"; } else { $sValeurParDefaut = ""; if ((!isset($Rubrique->ValeurDefaut)) || (empty($Rubrique->ValeurDefaut))) { switch ($Rubrique->nType) { case TYPE_BOOLEEN : $sValeurParDefaut = (VersBooleen($Rubrique->ValeurDefaut)) ? 'TRUE' : 'FALSE'; break; case TYPE_DUREE : case TYPE_ENTIER_1 : case TYPE_ENTIER_2 : case TYPE_ENTIER_4 : case TYPE_ENTIER_8 : case TYPE_ENTIER_NON_SIGNE_1 : case TYPE_ENTIER_NON_SIGNE_2 : case TYPE_ENTIER_NON_SIGNE_4 : case TYPE_ENTIER_NON_SIGNE_8 : case TYPE_REEL_4 : case TYPE_REEL_8 : case TYPE_MONETAIRE : case TYPE_DECIMAL : $sValeurParDefaut = $this->Fdc8698c9($Rubrique, 0); break; case TYPE_DATE : case TYPE_DATE_HEURE : case TYPE_HEURE : return $sChaine; case TYPE_BINAIRE : case TYPE_CARACTERE : case TYPE_CHAINE : case TYPE_MEMO_BINAIRE : case TYPE_MEMO_TEXTE : case TYPE_MEMO_TEXTE_UNICODE: default : $sValeurParDefaut = "''"; break; } } else { switch ($Rubrique->nType) { case TYPE_DATE_HEURE: return $sChaine; break; default: $sValeurParDefaut = $this->Fdc8698c9($Rubrique, $Rubrique->ValeurDefaut); } } $sChaine .= " DEFAULT ".$sValeurParDefaut; } } return $sChaine; } function F27cfe4f5(&$pclFichier) { $nIdAuto = false; $pclQueryStatement = $pclFichier->F52651677("SELECT MAX(".$this->F57e42f93($pclFichier->IdAuto->sNom). ") FROM ".$this->F57e42f93($pclFichier->Fe8d9985a()), $this->m_resConnexionId, true); if($pclQueryStatement===false) { $this->Fba409abd($this->m_resConnexionId,$pclFichier->sNomLogique); } else { $nIdMax = 0; $nResult = $pclQueryStatement->F3829673d(0); if ($nResult!==false) { $nIdMax = $nResult + 1; } else { $nIdMax = 1; } $pclQueryStatement->Faa2d6e4f(); $nIdAuto = $nIdMax; } return $nIdAuto; } function F7aeb10e1(&$pclFichier,&$Enreg, &$pnIdAuto,&$sNomRubIdAuto, $bForceIdAuto = false,$bEtExecute = true) { $sNomRubIdAuto = null; $nIdAuto = 0; $this->m_sClauseEnCours ='INSERT'; $sRequeteInsert = "INSERT INTO ".$this->F57e42f93($pclFichier->Fe8d9985a()). " ("; $sRequeteValues = " VALUES ("; $nIndex = 0; foreach($Enreg as $sNom => $valeur) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($Rubrique->Fa2afd757()) { $sNomRubIdAuto = $sNom; if(!$bForceIdAuto || $valeur == 0) { $nIdAuto = $this->F27cfe4f5($pclFichier); if(!is_bool($nIdAuto)) { $valeur = $nIdAuto; } else { continue; } } else { if($valeur < 0) { global $sLastFunction; Erreur('ErreurIdAutoNegatif',$sLastFunction, $sNom, $pclFichier->sNomLogique); } } } if($nIndex != 0) { $sRequeteInsert .= ", "; $sRequeteValues .= ", "; } ++$nIndex; $this->m_sClauseEnCours ='INSERT'; $sRequeteInsert .= $this->F57e42f93($Rubrique->sNomBase); $this->m_sClauseEnCours ='VALUES'; $sRequeteValues .= $this->Fdee89755($Rubrique,$valeur); } } $sRequeteInsert = $sRequeteInsert . ")" . $sRequeteValues . ")"; if (!$bEtExecute) return $sRequeteInsert; $this->m_sClauseEnCours =null; $nResExec = $this->F52fb3679($sRequeteInsert); if(!$bForceIdAuto && isset($sNomRubIdAuto)) { $pnIdAuto = $nIdAuto; } return $nResExec; } function Fbac1b32d(&$pclFichier,$bForceIdAuto = false) { $this->m_sClauseEnCours ='UPDATE'; $sRequeteUpdate = "UPDATE ".$this->F57e42f93($pclFichier->F7653b31e())." SET "; $sRequeteWhere = " WHERE ("; $this->m_sClauseEnCours ='WHERE'; if(isset($pclFichier->TabClePrimaire)) { $sNomClePrimaire = $pclFichier->TabClePrimaire[0]; $ClePrimaire =& $pclFichier->TabRubriques[utf8_strtolower($sNomClePrimaire)]; $sRequeteWhere .= $pclFichier->F0fa6e24e($ClePrimaire, $pclFichier->EnregCourant[$ClePrimaire->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } else if(isset($pclFichier->IdAuto)) { $this->m_sClauseEnCours ='WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($pclFichier->IdAuto, $pclFichier->EnregCourant[$pclFichier->IdAuto->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } $nIndex = 0; foreach($pclFichier->EnregUtilisateur as $sNom => $valeur) { if (!isset($pclFichier->TabRubriques[utf8_strtolower($sNom)])) { continue; } $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($Rubrique->Fa2afd757()) { if($bForceIdAuto && $valeur < 0) { global $sLastFunction; Erreur('ErreurIdAutoNegatif',$sLastFunction, $sNom, $pclFichier->sNomLogique); } else if(!$bForceIdAuto) { $pclFichier->EnregUtilisateur[$sNom] = $pclFichier->EnregCourant[$sNom]; continue; } } if($nIndex != 0) { $sRequeteUpdate .= ", "; } $this->m_sClauseEnCours = 'SET'; $sRequeteUpdate .= $pclFichier->F0fa6e24e($Rubrique,$valeur, TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, false, true); if(!isset($pclFichier->TabClePrimaire) && !isset($pclFichier->IdAuto)) { if($nIndex != 0) { $sRequeteWhere .= " AND "; } $this->m_sClauseEnCours = 'WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($Rubrique, $pclFichier->EnregCourant[$sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } ++$nIndex; } } $sRequeteUpdate = $sRequeteUpdate . $sRequeteWhere . ")"; $this->m_sClauseEnCours = null; return $this->F52fb3679($sRequeteUpdate); } function F100650c1(&$pclFichier) { $this->m_sClauseEnCours ='DELETE'; $sRequeteDelete = "DELETE FROM ".$this->F57e42f93($pclFichier->Fe8d9985a()); $sRequeteWhere = " WHERE ("; $nIndex = 0; foreach(array_keys($pclFichier->EnregCourant) as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $this; } if(!$Rubrique->Fbe67fb2c()) { if($nIndex != 0) { $sRequeteWhere .= " AND "; } ++$nIndex; $this->m_sClauseEnCours ='WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($Rubrique, $pclFichier->EnregCourant[$sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } } $sRequeteDelete .= $sRequeteWhere . ")"; $this->m_sClauseEnCours =null; return $this->F52fb3679($sRequeteDelete); } function F020cb2dc(&$pclFichier, $TabRub, $bUnique) { $sDefIndex = ''; foreach($TabRub as $sNom) { $Rubrique = &$pclFichier->TabRubriques[utf8_strtolower($sNom)]; if($Rubrique->Fa2afd757()) { $sDefIndex .= 'PRIMARY KEY '; } else { if($bUnique) { $sDefIndex .= 'UNIQUE '; } else { if (!isset($this->m_tabPostCreateSQL)) $this->m_tabPostCreateSQL = array(); if($Rubrique->Fbe67fb2c()) { $sNomIndex = $pclFichier->sNom.'_'.$Rubrique->sNom; $sListeRubriques = ''; foreach(array_keys($Rubrique->TabRubCleComp) as $sRubriqueI) { if(!empty($sListeRubriques)) { $sListeRubriques .= ', '; } $sListeRubriques.= $this->F57e42f93( $sRubriqueI ); } } else { $sNomIndex = $Rubrique->sNom .uniqid('_cleavecdoublon_'); $sListeRubriques = $Rubrique->F9047540f(); } $this->m_tabPostCreateSQL[] = 'CREATE INDEX ' . $this->F57e42f93( $sNomIndex ). ' ON '.$pclFichier->F9047540f(). ' (' . $sListeRubriques . ')'; continue; } } if($Rubrique->Fbe67fb2c()) { $sDefIndex .= '('; $nIndex = count($Rubrique->TabRubCleComp); foreach(array_keys($Rubrique->TabRubCleComp) as $sComposante) { $sDefIndex .= $this->F57e42f93($sComposante); --$nIndex; if($nIndex != 0) { $sDefIndex .= ', '; } } $sDefIndex .= ')'; } else { $sDefIndex .= '(' .$Rubrique->F9047540f(). ')'; } $sDefIndex .= ', '; } return $sDefIndex; } function Fe8d9985a(&$pclFichier) { return $this->F98e40c2c($pclFichier->sNom); } function F7653b31e(&$pclFichier) { return $this->F98e40c2c($pclFichier->sNom); } function Fd5be2853(&$pclFichier,$TabRub, $nTypeParcours) { if(count($TabRub) == 0) { return ""; } $sOrderBy = ""; $nNbRub = count($TabRub); foreach($TabRub as $rubrique) { --$nNbRub; $sRubriqueOrderBy = $rubrique->F0c01be43($this,$nTypeParcours); $sOrderBy.= $sRubriqueOrderBy; if($nNbRub > 0 && !empty($sRubriqueOrderBy)) { $sOrderBy .= ", "; } } return (empty($sOrderBy)) ? $sOrderBy : " ORDER BY " . $sOrderBy; } function F5237a205(&$pclFichier,$TabRub, $nTypeParcours, &$DernierEnregLu) { $sClausePrecedente = $this->m_sClauseEnCours; $this->m_sClauseEnCours = 'WHERE'; $sWhere = " WHERE ("; $oldRub = null; $nNbParentheses = 0; foreach($TabRub as $rubrique) { if($rubrique->Fbe67fb2c()) { foreach($rubrique->TabRubCleComp as $composante => $sens ) { $RubComp = $pclFichier->TabRubriques[utf8_strtolower($composante)]; $RubComp->nSens_Parcours = $sens; if(isset($oldRub)) { $sWhere .= " OR (".$pclFichier->F0fa6e24e($oldRub, $DernierEnregLu[$oldRub->sNom], true, $nTypeParcours)." AND ("; $nNbParentheses += 2; } $sWhere .= $pclFichier->F0fa6e24e($RubComp, $DernierEnregLu[$RubComp->sNom], false, $nTypeParcours); $oldRub = $RubComp; } } else if($rubrique->nType == TYPE_CALCULE) { continue; } else { if(isset($oldRub)) { $sWhere .= " OR (".$pclFichier->F0fa6e24e($oldRub, $DernierEnregLu[$oldRub->sNom], true, $nTypeParcours)." AND ("; $nNbParentheses += 2; } $sWhere .= $pclFichier->F0fa6e24e($rubrique, $DernierEnregLu[$rubrique->sNom], false, $nTypeParcours); $oldRub = $rubrique; } } for($i=0;$i<$nNbParentheses;$i++) { $sWhere .= ")"; } $this->m_sClauseEnCours=$sClausePrecedente; return $sWhere.")"; } function F0fa6e24e(&$pclFichier,&$Rubrique, $sValeur, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull = true, $bNomRubriqueBase = false) { if($bNomRubriqueBase) { $sResultat = $this->Ff43faec2( $Rubrique , $Rubrique->sNomBase, (isset($this->m_sClauseEnCours) ? $this->m_sClauseEnCours : 'WHERE') ); } else { $sResultat = $this->Ff43faec2( $Rubrique , $Rubrique->sNom, (isset($this->m_sClauseEnCours) ? $this->m_sClauseEnCours : 'WHERE') ); } if(!isset($sValeur) && $bNull) { if($nTypeCompare == TYPE_COMP_EGAL) { $sResultat.=" IS NULL"; } else { $sResultat.=" IS NOT NULL"; } return $sResultat; } if($nTypeCompare == TYPE_COMP_EGAL) { $sResultat .= " = "; } else if($nTypeCompare == TYPE_COMP_COMMENCE_PAR) { if($Rubrique->F7b5edca9()) { $sResultat .= " = "; } else { $sResultat .= " LIKE "; $sResultat .= $this->Fdee89755($Rubrique,$sValeur.'%'); return $sResultat; } } else { if($Rubrique->F19c595c2()) { if($nTypeParcours == PARCOURS_PREMIER_SUIVANT) { $sResultat .= " >"; } else { $sResultat .= " <"; } } else { if($nTypeParcours == PARCOURS_PREMIER_SUIVANT) { $sResultat .= " <"; } else { $sResultat .= " >"; } } if($nTypeCompare == TYPE_COMP_INF_EGAL || $nTypeCompare == TYPE_COMP_SUP_EGAL) { $sResultat .= "= "; } else { $sResultat .= " "; } } $sResultat .= $this->Fdee89755($Rubrique,$sValeur); return $sResultat; } function F25514b5d(&$pclFichier,$sValCleComp, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull, &$FirstComp) { $sResultat = ""; $sValCleComp = utf8_substr($sValCleComp, 1); $hVal = ""; if((utf8_strpos($sValCleComp, H_VAL_MIN) == (utf8_strlen($sValCleComp) - 1)) || (utf8_strpos($sValCleComp, H_VAL_MAX) == (utf8_strlen($sValCleComp) - 1))) { $hVal = utf8_substr($sValCleComp, (utf8_strlen($sValCleComp) - 1)); $sValCleComp = utf8_substr($sValCleComp, 0, (utf8_strlen($sValCleComp) - 1)); } $TabComposante = utf8_explode(SEPARATEUR_COMPOSANTE, $sValCleComp); $nBorneMax=count($TabComposante); for($i=0;$i<$nBorneMax;$i++) { $TabCoupleCleValeur = utf8_explode(SEPARATEUR_VALEUR, $TabComposante[$i]); if($i > 0) { $sResultat .= " AND "; } else { $FirstComp = $TabCoupleCleValeur; } $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($TabCoupleCleValeur[0])]; $sResultat .= $pclFichier->F0fa6e24e($Rubrique, $this->F137bdb94($Rubrique,$TabCoupleCleValeur[1].$hVal), $nTypeCompare, $nTypeParcours, $bNull); } return $sResultat; } function F4500afc6(&$pclOpExpression) { $sCodeExpression=null; switch($pclOpExpression->m_nOpExpression) { case eMATH_UUID: return 'uuid_generate_v1()'; break; case eSTRING_LEFT: case eSTRING_RIGHT: case eSTRING_MID: $sCodeOperandeChaine = Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this); if (!isset($sCodeOperandeChaine)) return null; $sCodeExpression = 'SUBSTR(' . $sCodeOperandeChaine . ','; $nNbItems = 0; if ($pclOpExpression->m_nOpExpression == eSTRING_MID) { $nValMin = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); $nValMax = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal2']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal2'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); } else if ($pclOpExpression->m_nOpExpression == eSTRING_LEFT) { $nValMin = '1'; $nValMax = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); } else { XASSERT ($pclOpExpression->m_nOpExpression == eSTRING_RIGHT); $nValMin = isset($pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1']) ? $pclOpExpression->m_tabOptionsExpression['nOPSTRING_GetVal1'] : Ffaa5b6f5($pclOpExpression->m_tabItems[++$nNbItems],$this); $nValMax = null; } $sCodeExpression.=$nValMin; if (isset($nValMax)) { $sCodeExpression.=','.$nValMax; } $sCodeExpression.=')'; break; default: return parent::F4500afc6($pclOpExpression); } return $sCodeExpression; } function Fe47eea61(&$pclRequete) { $this->Faa055082($pclRequete , 'LIMIT'); $pclLimit =& $pclRequete->m_clLimit; if (isset($pclLimit)) { $nType = $pclLimit->m_nType; $nOffset = $pclLimit->m_nDepuis; $nEnregs = $pclLimit->m_nNombreEnregs; switch ($nType) { case eTOP: return 'LIMIT '.$nEnregs; break; case eBOTTOM: $sCodeLimit = '(SELECT * FROM ' . $pclRequete->m_pszCodeSQLEnCours; $sCodeLimit.='LIMIT '.$nEnregs; $sCodeLimit.=') AS ' . uniqid('REQ_BOTTOM_') . ' '; $sCodeSQL_ORDERBY = $this->Fdf02384a($pclRequete,true); if (isset($sCodeSQL_ORDERBY)) $sCodeLimit.=$sCodeSQL_ORDERBY; $pclRequete->m_pszCodeSQLEnCours = ''; return $sCodeLimit; break; case eLIMIT_MYSQL: case eLIMIT_POSTGRESQL: return 'LIMIT '.$nEnregs.' OFFSET '.$nOffset; break; case eEVERY: break; default: } } return null; } } class FMK_AN_Statement_PGSQL extends FMK_AN_Statement { function FMK_AN_Statement_PGSQL($resQuery,$tabInformations = null) { if (!isset($tabInformations[FMK_AN_INFO_RESTYPE])) { F6b1e3687(); $sTagQuery = pg_result_status($resQuery,PGSQL_STATUS_STRING); $nPosFinMot = strpos($sTagQuery,' '); if ($nPosFinMot>0) { $sTagQuery = substr($sTagQuery,0,$nPosFinMot); } F1e7b0563(); $tabInformations[FMK_AN_INFO_RESTYPE] = $sTagQuery; } parent::FMK_AN_Statement($resQuery,$tabInformations); } function F5374034a($nFetchType = FMK_AN_FETCH_BOTH, $cursor_orientation = null, $cursor_offset = null) { if (!isset($nFetchType)) $nFetchType = FMK_AN_FETCH_BOTH ; switch ($nFetchType) { case FMK_AN_FETCH_BOTH: { F6b1e3687(); $tabPgFetch = pg_fetch_array($this->m_resQuery,null,PGSQL_BOTH); F1e7b0563(); if ($tabPgFetch === false) { return false; } return $tabPgFetch; } break; case FMK_AN_FETCH_ASSOC: { F6b1e3687(); $tabPgFetch = pg_fetch_assoc($this->m_resQuery); F1e7b0563(); if ($tabPgFetch === false) { return false; } return $tabPgFetch; } break; case FMK_AN_FETCH_LAZY: { F6b1e3687(); $tabPgFetch = pg_fetch_assoc($this->m_resQuery); F1e7b0563(); if ($tabPgFetch === false) { return false; } $clResultat = new FMK_AN_Row(); F34bbd047($clResultat,$tabPgFetch); unset($tabPgFetch); return $clResultat; } break; case FMK_AN_FETCH_OBJ: { F6b1e3687(); $tabPgFetch = pg_fetch_assoc($this->m_resQuery); F1e7b0563(); if ($tabPgFetch === false) { return false; } $clResultat = new stdClass(); F34bbd047($clResultat,$tabPgFetch); unset($tabPgFetch); return $clResultat; } default: return false; } } function F6e51814c() { F6b1e3687(); pg_result_seek($this->m_resQuery,0); F1e7b0563(); } function F210e6480() { F6b1e3687(); $nOccurrence = pg_num_rows($this->m_resQuery); F1e7b0563(); return $nOccurrence; } function F0c638d70() { F6b1e3687(); $nOccurrence = pg_affected_rows($this->m_resQuery); F1e7b0563(); return $nOccurrence; } function F36a82aa8() { F6b1e3687(); $nColCount = pg_num_fields($this->m_resQuery); F1e7b0563(); return $nColCount; } function Faa2d6e4f() { F6b1e3687(); pg_free_result($this->m_resQuery); F1e7b0563(); } } class FMK_BufferParcours_PGSQL extends FMK_BufferParcours { function FMK_BufferParcours_PGSQL(&$Rubrique, $nIdModif, $sValeur = null, $bIdentique = false, $bLimiteParcours = false) { parent::FMK_BufferParcours($Rubrique, $nIdModif, $sValeur , $bIdentique , $bLimiteParcours ); } function Ff394115b(&$pclQueryStatement) { $nIndex = $this->nPosition; if($nIndex != 0) { ++$nIndex; } while(($Enreg = $pclQueryStatement->F5374034a(FMK_AN_FETCH_ASSOC)) != 0) { $EnregCorrige = array(); if (!isset($nCount)) { $nCount = count($Enreg); $tabKeys = array_keys($Enreg); } for($i=0; $i<$nCount; $i++) { $sNomBdd = $tabKeys[$i]; $pclRub =& F2b6640f3($this->RubriqueParcours->Fichier,$sNomBdd,false); if (isset($pclRub) && ($pclRub->nType == TYPE_BOOLEEN)) { $xValeur = ( ($Enreg[$sNomBdd]=='1')||($Enreg[$sNomBdd]=='t') ) ? true : false; } elseif (isset($pclRub) && (($pclRub->nType == TYPE_BINAIRE)||($pclRub->nType == TYPE_MEMO_BINAIRE))) { $xValeur = pg_unescape_bytea($Enreg[$sNomBdd]); } else { $xValeur = $Enreg[$sNomBdd]; } $EnregCorrige[$sNomBdd] = $xValeur; } $this->Cache[$nIndex] = $EnregCorrige; ++$nIndex; } $pclQueryStatement->Faa2d6e4f(); } } ?>