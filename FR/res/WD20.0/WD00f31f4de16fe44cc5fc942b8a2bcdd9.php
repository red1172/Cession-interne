<?php
//20.0.56.0 WL/SQl/Sql.php GF 
//VersionVI: 30F200066p
//(c) 2005-2012 PC SOFT  - Release
 if (!defined('__INC__FMK/Chaine.php')) { define('__INC__FMK/Chaine.php',true); include_once(WB_INCLUDE_PATH.'WD55acb2e708e26f23cb8956cd93e98123.php'); } if (!defined('__INC__FMK/Sql.php')) { define('__INC__FMK/Sql.php',true); include_once(WB_INCLUDE_PATH.'WD4b9c73b07be5742abf5273cd830e12f9.php'); } if (!defined('__INC__FMK/Sql.php')) { define('__INC__FMK/Sql.php',true); include_once(WB_INCLUDE_PATH.'WD4b9c73b07be5742abf5273cd830e12f9.php'); } $SQL = null; if (!isset($gclContextSQL)) $gclContextSQL = new FMK_HFContext(); function& F144dce03() { global $SQL; if (!isset($SQL)) { $SQL = new CVariablesSQL(); } return $SQL; } class CVariablesSQL { var $Connexion; var $EnDehors; var $EnCours; var $Erreur; var $MesErreur; var $NbCol; var $NbLig; var $IdAuto; var $m_ResQuery; var $m_TabSQLFetch; var $m_TabSQLPremier; var $m_TabSQLAssocie; } function SQL_SauveContexte(&$pclPage) { global $gclContextSQL; $pclPage->pclContexteSQL = $gclContextSQL; } function F6ff10cef() { global $gclContextSQL; if ( $gclContextSQL->ConnectID != 0 ) return; if ( isset($gclContextSQL->TabConnectSettings[$gclContextSQL->nIndiceTabConnectSettings]) ) { $tabConnexionCourante = $gclContextSQL->TabConnectSettings[$gclContextSQL->nIndiceTabConnectSettings]; $Source = $tabConnexionCourante[0]; $Utilisateur = $tabConnexionCourante[1]; $MotDePasse = $tabConnexionCourante[2]; $NomDeLaDataBase = $tabConnexionCourante[3]; $TypeDeLaDataBase = $tabConnexionCourante[4]; $clSQLControl = FMK_SQL(); $gclContextSQL->m_pclConnexion =& $clSQLControl->F0afbbf2f($TypeDeLaDataBase); $bOk = $gclContextSQL->m_pclConnexion->F98fedcfa( $Source, $Utilisateur, $MotDePasse, $NomDeLaDataBase ); if ($bOk === false) return; $gclContextSQL->ConnectID = $gclContextSQL->m_pclConnexion->ConnectID; } } function SQL_RestaureContexte( &$pclPage ) { if (!isset($pclPage->pclContexteSQL)) return; $GLOBALS['gclContextSQL'] =& $pclPage->pclContexteSQL; $gclContextSQL =& $GLOBALS['gclContextSQL']; if ( isset( $gclContextSQL->m_szLastTable)) { $szNomReq = $gclContextSQL->m_szLastTable ; if ( isset( $gclContextSQL->TabSQLTable[$szNomReq]) ) { $SQL =& F144dce03(); $SQL = $gclContextSQL->TabSQLTable[$szNomReq]; } } } function F0deb9f5f($szNomReq) { global $gclContextSQL; $gclContextSQL->m_szLastTable = $szNomReq; $SQL =& F144dce03(); $SQL = $gclContextSQL->TabSQLTable[$szNomReq]; } function SQLConnecte($Source, $Utilisateur, $MotDePasse, $NomDeLaDataBase="", $TypeDeLaBase="MySQL" ) { global $gclContextSQL; $SQL =& F144dce03(); $clSQLControl = FMK_SQL(); $pclConnexion =& $clSQLControl->F0afbbf2f($TypeDeLaBase); if ( !isset($pclConnexion)) { Ffe27c994("$TypeDeLaBase : Invalid."); return 0; } $gclContextSQL->m_pclConnexion = &$pclConnexion; $bOk = $pclConnexion->F98fedcfa( $Source, $Utilisateur, $MotDePasse, $NomDeLaDataBase ); if (!$bOk) { unset( $gclContextSQL->m_pclConnexion ); return 0; } $clContexte =& F4a1887ce(); $clContexte->F4c8f9bd4('SQL_CONNECTE',true); $SQL->ConnectID = $pclConnexion->ConnectID; $gclContextSQL->ConnectID = $pclConnexion->ConnectID; $gclContextSQL->TabConnectSettings[] = array( $Source, $Utilisateur, $MotDePasse, $NomDeLaDataBase, $TypeDeLaBase ); $gclContextSQL->nIndiceTabConnectSettings = count($gclContextSQL->TabConnectSettings,COUNT_NORMAL)-1; return $gclContextSQL->nIndiceTabConnectSettings+1; } function SQLDeconnecte() { global $gclContextSQL; if ( $gclContextSQL->ConnectID == 0 ) return; if ( !isset($gclContextSQL->m_pclConnexion)) return; unset( $gclContextSQL->TabSQLTable ); $gclContextSQL->m_pclConnexion->F3f4d9a86(); $clContexte =& F4a1887ce(); $clContexte->F4c8f9bd4('SQL_CONNECTE',false); $gclContextSQL->ConnectID = 0; unset( $gclContextSQL->m_pclConnexion ); } function SQLExec( $szCodeSQL, $szNomReq ) { return Fbe102bcd( $szCodeSQL, $szNomReq ); } function Fbe102bcd( $szCodeSQL, $szNomReq ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); $clContexte =& F4a1887ce(); $ValeurConnection = $clContexte->F239ddeda('SQL_CONNECTE'); if ( (!isset($ValeurConnection)) || (!$ValeurConnection) ) { Erreur('ErreurGenerique', FMK_ChaineConstruit(Fc34ec142("ERR_SQL_NOTCONNECTED"), $szNomReq ) ); return false; } F6ff10cef(); if (isset($gclContextSQL->TabSQLTable[$szNomReq])) { Fb1da264a( $szNomReq ); } if (!isset( $gclContextSQL->m_pclConnexion)) { Erreur('ErreurGenerique',FMK_ChaineConstruit(Fc34ec142("ERR_SQL_NOTCONNECTED"), $szNomReq ) ); return false; } $res = $gclContextSQL->m_pclConnexion->Fc639f13d( $szCodeSQL ); if ($res === false) { return false; } $stNewInfoReq = new CVariablesSQL(); $stNewInfoReq->m_ResQuery = $res; if (F9d60968a($szCodeSQL,false)=='INSERT') { $stNewInfoReq->IdAuto = $gclContextSQL->m_pclConnexion->F75609ad1( $gclContextSQL->m_pclConnexion->ConnectID, $szCodeSQL ); } else { $stNewInfoReq->NbCol = $gclContextSQL->m_pclConnexion->Fd5a050a1( $res ); } $stNewInfoReq->Connexion = $gclContextSQL->m_pclConnexion->ConnectID; $gclContextSQL->TabSQLTable[$szNomReq] = &$stNewInfoReq; F0deb9f5f( $szNomReq ); return true; } function SQLExecWDR( $szNomReq ) { $szNomReq = Feb2bba04($szNomReq); $clSqlInfo = new FMK_WDR_CHARGEUR($szNomReq); $szCodeSQL = $clSqlInfo->F5b17b436(); $nNbArg = func_num_args(); $lstParametres = Ff46baf49($szCodeSQL); for ($i=0;$i<$nNbArg-1;$i++) { if(isset($lstParametres[$i])) { $sNomParam = $lstParametres[$i]; $ValElement = func_get_arg($i+1); $szNomTagArg= '{'.$sNomParam.'#'.$i.'}'; $szNomTagArgLike = '%{'.$sNomParam.'#'.$i.'}%'; $bLikePresent = utf8_strpos( $szCodeSQL, $szNomTagArgLike) > 0; $szValElement = $ValElement . ''; if ($bLikePresent) { $szValElement = '\'%'. $ValElement . '%\''; $szNomTagArg = $szNomTagArgLike; } else { $szNomTagArgLike = '%{'.$sNomParam.'#'.$i.'}'; $bLikePresent = utf8_strpos( $szCodeSQL, $szNomTagArgLike) > 0; if ($bLikePresent) { $szValElement = '\'%'. $ValElement . '\''; $szNomTagArg = $szNomTagArgLike; } else { $szNomTagArgLike = '{'.$sNomParam.'#'.$i.'}%'; $bLikePresent = utf8_strpos( $szCodeSQL, $szNomTagArgLike) > 0; if ($bLikePresent) { $szValElement = '\''. $ValElement . '%\''; $szNomTagArg = $szNomTagArgLike; } else if ( Is_String($ValElement) ) { $szValElement = '\''. $ValElement . '\''; } } } $szCodeSQL = utf8_str_replace( $szNomTagArg, $szValElement, $szCodeSQL ); } } return Fbe102bcd( $szCodeSQL, $szNomReq ); } function SQLFerme( $NomReq ) { Fb1da264a( $NomReq ); } function Fb1da264a( $NomReq ) { global $gclContextSQL; $NomReq = Feb2bba04($NomReq); if (!isset($gclContextSQL->m_pclConnexion)) return; if (!isset($gclContextSQL->TabSQLTable[$NomReq])) return; $stInfoReq = &$gclContextSQL->TabSQLTable[$NomReq]; if (isset( $stInfoReq->m_ResQuery)) { $ResQuery = $stInfoReq->m_ResQuery; $gclContextSQL->m_pclConnexion->F58e3a375( $ResQuery ); } unset($stInfoReq->m_TabSQLPremier); unset( $gclContextSQL->TabSQLTable[$NomReq] ); } function SQLFetch( $szNomReq ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return -1; $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; F0deb9f5f( $szNomReq ); $res = $pstInfoReq->m_ResQuery; $resfetch = $gclContextSQL->m_pclConnexion->F4a096310( $res ); $pstInfoReq->TabSQLFetch = &$resfetch; if ($resfetch == false) { $pstInfoReq->EnDehors = true; F0deb9f5f( $szNomReq ); return -1; } $pstInfoReq->NbCol = count( $pstInfoReq->TabSQLFetch ); $pstInfoReq->EnDehors = false; F0deb9f5f( $szNomReq ); return 0; } function SQLLitCol( $szNomReq, $Indice ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) { return ""; } $stInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; F0deb9f5f( $szNomReq ); $resfetch = &$stInfoReq->TabSQLFetch; return $resfetch[$Indice-1]; } function F8b0166ce( $szNomReq ) { global $gclContextSQL; global $MaPage; $szNomReq = Feb2bba04($szNomReq); $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; if (!isset($pstInfoReq->m_TabSQLAssocie )) return; foreach ( $pstInfoReq->m_TabSQLAssocie as $nIndice => $szNomChamp ) { $Valeur = Fd106626e( $szNomReq, $nIndice+1 ); if (!is_object($pstInfoReq->m_TabSQLAssocie[$nIndice])) { $pclChamp =& $MaPage->F1cbb0dd2( $szNomChamp ); } else { $pclChamp =& $pstInfoReq->m_TabSQLAssocie[$nIndice]; } if ($pclChamp != null) $pclChamp->SetValeur( $Valeur ); } } function SQLPremier( $szNomReq, $nMaxFetch=-1 ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return; $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; if (isset( $pstInfoReq->m_TabSQLPremier )) { $pstInfoReq->EnCours = 1; $pstInfoReq->EnDehors = ($pstInfoReq->NbLig == 0); F0deb9f5f( $szNomReq ); return; } $res = $pstInfoReq->m_ResQuery; $Buffer = array(); $nNbLineRes =0; $TabResfetch = $gclContextSQL->m_pclConnexion->F4a096310( $res ); if ($TabResfetch) $pstInfoReq->NbCol = count( $TabResfetch ); while ($TabResfetch) { $Buffer[$nNbLineRes] = $TabResfetch; ++$nNbLineRes; $TabResfetch = $gclContextSQL->m_pclConnexion->F4a096310( $res ); if (($nMaxFetch!=-1) & ($nNbLineRes>=$nMaxFetch)) break; } $pstInfoReq->m_TabSQLPremier = &$Buffer; $pstInfoReq->NbLig = $nNbLineRes; $pstInfoReq->EnCours = 1; $pstInfoReq->EnDehors = ($nNbLineRes == 0); F8b0166ce( $szNomReq ); F0deb9f5f( $szNomReq ); } function SQLSuivant( $szNomReq ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) { Erreur('ErreurGenerique',Fc34ec142("ERR_WLL"),Fc34ec142("ERR_FATAL"), FMK_ChaineConstruit(Fc34ec142("ERR_SQLSUIVANT_BADNAME"), $szNomReq) ); return; } $stInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; if ($stInfoReq->EnCours +1 > $stInfoReq->NbLig ) { $stInfoReq->EnDehors = true; F0deb9f5f( $szNomReq ); return; } $stInfoReq->EnDehors = false; $stInfoReq->EnCours++; F8b0166ce( $szNomReq ); F0deb9f5f( $szNomReq ); } function SQLPrecedent( $szNomReq ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return; $stInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; if ($stInfoReq->EnCours - 1 <= 0 ) { $stInfoReq->EnDehors = true; F0deb9f5f( $szNomReq ); return; } $stInfoReq->EnDehors = false; $stInfoReq->EnCours--; F8b0166ce( $szNomReq ); F0deb9f5f( $szNomReq ); } function SQLPositionne( $szNomReq, $nIndice ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return; $stInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; if ($nIndice <= 0 ) $nIndice = 1; if ($nIndice > $stInfoReq->NbLig ) $nIndice = $stInfoReq->NbLig; $stInfoReq->EnCours = $nIndice; $stInfoReq->EnDehors = ($stInfoReq->NbLig == 0); F8b0166ce( $szNomReq ); F0deb9f5f( $szNomReq ); } function SQLDernier( $szNomReq ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return; $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; $pstInfoReq->EnCours = $pstInfoReq->NbLig; $pstInfoReq->EnDehors = ($pstInfoReq->NbLig == 0); F8b0166ce( $szNomReq ); F0deb9f5f( $szNomReq ); } function SQLCol( $szNomReq, $nIndice ) { return Fd106626e( $szNomReq, $nIndice ); } function Fd106626e( $szNomReq, $nIndice ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return null; $stInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; F0deb9f5f( $szNomReq ); $Buffer = &$stInfoReq->m_TabSQLPremier; if ($stInfoReq->EnDehors) return ''; $resfetch = $Buffer[$stInfoReq->EnCours - 1]; if ($nIndice <= 0) return ''; return $resfetch[$nIndice-1]; } function SQLColonne( $nIDConnection, $szNomTable, $bSimple=true ) { global $gclContextSQL; if (!isset($gclContextSQL->m_pclConnexion)) return ""; return $gclContextSQL->m_pclConnexion->Fbf1c42e2( $szNomTable, $bSimple ); } function SQLColonne2( $szNomReq, $bSimple=true ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return null; $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; F0deb9f5f( $szNomReq ); $res = $pstInfoReq->m_ResQuery; $szRes = ''; for ($i=0;$i<$pstInfoReq->NbCol;$i++) { if ($szRes != '') $szRes .= "\n"; $szRes .= $gclContextSQL->m_pclConnexion->F39bb791f( $res , $i, $bSimple ); } return $szRes; } function SQLReqExiste($NomReq) { global $gclContextSQL; $NomReq = Feb2bba04($NomReq); return isset($gclContextSQL->TabSQLTable[$NomReq]); } function SQLInfoGene($szNomReq="") { global $gclContextSQL; if ($szNomReq == 0) $szNomReq = $gclContextSQL->m_szLastTable; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) { return; } F0deb9f5f( $szNomReq ); $SQL =& F144dce03(); $SQL = $gclContextSQL->TabSQLTable[$szNomReq]; } function SQLListeTable($bSimple=FALSE,$bQueLesTableEtVues=false) { global $gclContextSQL; F6ff10cef(); if (!isset($gclContextSQL->m_pclConnexion)) return ""; return $gclContextSQL->m_pclConnexion->F978f8f4e( $bSimple, $bQueLesTableEtVues); } function SQLChangeConnexion($nNumConnexion) { global $gclContextSQL; if (!isset($gclContextSQL->TabConnectSettings[$nNumConnexion-1])) return false; $gclContextSQL->nIndiceTabConnectSettings = $nNumConnexion-1; $gclContextSQL->ConnectID = 0; return true; } function SQLTable($szNomReq, $szNomTable, $nMaxFetch=-1 ) { $szNomReq = Feb2bba04($szNomReq); if (!ChampExiste($szNomTable)) return ; $pclZR = &$GLOBALS[$szNomTable]; global $gclContextSQL; if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return; $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; F0deb9f5f( $szNomReq ); $res = $pstInfoReq->m_ResQuery; $resfetch = $gclContextSQL->m_pclConnexion->F4a096310( $res ); $i=0; while ( $resfetch ) { $pclZR->F07f90bd2($resfetch); $resfetch = $gclContextSQL->m_pclConnexion->F4a096310( $res ); ++$i; if (($nMaxFetch!=-1) & ($i>=$nMaxFetch)) break; } } function SQLModifie($szNomReq, $nNumLigne, $szTabValeur ) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) return; $pstInfoReq =& $gclContextSQL->TabSQLTable[$szNomReq]; F0deb9f5f( $szNomReq ); $Buffer =& $pstInfoReq->m_TabSQLPremier; $Buffer[ $nNumLigne - 1] = utf8_explode( "\t", $szTabValeur ); } function SQLAssocie($szNomReq,$tabChamps = null) { global $gclContextSQL; $szNomReq = Feb2bba04($szNomReq); if (!isset($gclContextSQL->TabSQLTable[$szNomReq])) { Erreur('ErreurGenerique',Fc34ec142("ERR_WLL"),Fc34ec142("ERR_FATAL"), FMK_ChaineConstruit(Fc34ec142("ERR_SQLASSOCIE_BADNAME"), $szNomReq) ); return; } $pstInfoReq = &$gclContextSQL->TabSQLTable[$szNomReq]; if (!isset($tabChamps)) return; $TabAssocie = array(); $nNbChamps = count($tabChamps); for ($i=0; $i<$nNbChamps; $i++) { $TabAssocie[] =& $tabChamps[$i]; } $pstInfoReq->m_TabSQLAssocie = $TabAssocie; F0deb9f5f( $szNomReq ); } function Feb2bba04($Requete) { if(is_object($Requete) && Feee3b2d5($Requete)) { return $Requete->sNom; } return $Requete; } ?>