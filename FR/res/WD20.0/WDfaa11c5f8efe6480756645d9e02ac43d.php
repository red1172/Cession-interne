<?php
//20.0.56.0 WL/HF/AN/AN.php GF 
//VersionVI: 30F200066p
//(c) 2005-2012 PC SOFT  - Release
 define('FMK_AN_FETCH_BOTH' ,0); define('FMK_AN_FETCH_ASSOC' ,1); define('FMK_AN_FETCH_LAZY' ,2); define('FMK_AN_FETCH_OBJ' ,3); define('FMK_AN_INFO_ROWCOUNT','rowCount'); define('FMK_AN_INFO_RESTYPE','resType'); define('FMK_AN_PREFIX_COL_FORMATSQL','WB_FORMAT_SQL_'); define('FMK_AN_PREFIX_COL_FORMATWD','WB_FORMAT_WD_'); define('WD_UNICODE_SUPPORT','WD Unicode Support'); if (!defined('__INC__FMK/Sql/HF.php')) { define('__INC__FMK/Sql/HF.php',true); include_once(WB_INCLUDE_PATH.'WDbdf5609dc04ea6e9de45d20e533ff0a5.php'); } function F34bbd047(&$pthis, $tabAssocNomValeur) { $tabKeys = array_keys( $tabAssocNomValeur ); $nOccurrence = count( $tabKeys ); for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $pclKey =& $tabKeys[ $nKey ]; $pthis->$pclKey = $tabAssocNomValeur[ $pclKey ]; } } function Fc394fe3e(&$pclAn,&$pclMessageErreur,$nIdAN,$sHost=null,$sDB=null,$sUser=null,$sPass=null,$sInfos=null) { $clNouvelAN = null; $pclMessageErreur = ''; switch ($nIdAN) { case TYPE_BASE_MYSQL: case TYPE_BASE_MARIA: { if (!(HF_MODULES & HF_MYSQL)) Fe6ad5774($nIdAN); $clNouvelAN = new FMK_AN_MYSQL($sHost,$sDB,$sUser,$sPass,$sInfos); } break; case TYPE_BASE_PGSQL: { if (!(HF_MODULES & HF_PGSQL)) Fe6ad5774($nIdAN); $clNouvelAN = new FMK_AN_PGSQL($sHost,$sDB,$sUser,$sPass,$sInfos); } break; case TYPE_BASE_ORACLE: { if (!(HF_MODULES & HF_ORACLE)) Fe6ad5774($nIdAN); $clNouvelAN = new FMK_AN_ORACLE($sHost,$sDB,$sUser,$sPass,$sInfos); } break; case TYPE_BASE_AS400: { if (!(HF_MODULES & HF_AS400)) Fe6ad5774($nIdAN); $clNouvelAN = new FMK_AN_AS400($sHost,$sDB,$sUser,$sPass,$sInfos); } break; default: return false; } $pclAn = $clNouvelAN; return true; } class FMK_AN_Row { function FMK_AN_Row() { } } class FMK_AN { var $m_resConnexionId; var $m_sServeur; var $m_sBase; var $m_sUtilisateur; var $m_sMotDePasse; var $m_pclRequeteEnCours = null; var $m_pclItemEnCours = null; var $m_sClauseEnCours = null; function FMK_AN($sHost=null,$sDB=null,$sUser=null,$sPass=null,$sInfosEtendues=null) { $this->m_resConnexionId = false; $this->m_sServeur=$sHost; $this->m_sBase=$sDB; $this->m_sUtilisateur=$sUser; $this->m_sMotDePasse=$sPass; $tabInfosEtendues = utf8_explode('=',$sInfosEtendues); if (array_key_exists(WD_UNICODE_SUPPORT,$tabInfosEtendues)) { $this->m_bSupportUTF8 = ($tabInfosEtendues[WD_UNICODE_SUPPORT]) ? true : false; } else $this->m_bSupportUTF8 = UNICODE_PAGE_UTF8 ? true : false; } function F5399a982($sSQL) { if (AN_TRACE_SQL) Trace($sSQL); if (AN_SPY_SQL) { if (function_exists('Ecriture_gEcritSQL')) call_user_func('Ecriture_gEcritSQL',$sSQL); } } function F22067d84() { } function Fe47ec54f() { return $this->m_bSupportUTF8; } function F849de7ed($sMdp = null) { return ($this->m_resConnexionId != false) && ((null===$sMdp) || ($this->m_sMotDePasse===$sMdp)) ; } function F03323c7e($sChaine) { $arr = array(1=>''); if (preg_match('/([0-9]+\.([0-9\.])+)/',$sChaine, $arr)) return $arr[1]; else return ''; } function& Faa097ba5($sNom) { $clRub = new CRubriqueAnalyse($sNom); if (func_num_args() > 1) { $tabArgs = func_get_args(); call_user_func_array(array(&$clRub,'CRubriqueAnalyse'),$tabArgs); } return $clRub; } function Ff31e2a62($sql) { $ret = false; $rs = $this->query($sql); if ($rs!==false) { if ($rs->F2262f69c() === 0) return true; else { $ret = $rs->F3829673d(); if ($ret===false) return false; $rs->F6e51814c(); } return $ret; } return false; } function F57e42f93($sNom = null) { return (string)$sNom; } function Ff43faec2(&$pclRubrique, $sNomRubrique, $bAvecFormattage) { $sNom = $this->F57e42f93($sNomRubrique); if ( ($bAvecFormattage!==false)&&($bAvecFormattage!='SET')) $sNom = $pclRubrique->Fichier->F9047540f() .'.'.$sNom; return $sNom; } function F98e40c2c($sNomSurBase) { if (($nPosPointBDD=strpos($sNomSurBase,'.'))!==false && (utf8_substr($sNomSurBase,0) != $this->F57e42f93())) { $sNomSurBase = utf8_substr($sNomSurBase,$nPosPointBDD+1); } return $sNomSurBase; } function F850edd33(&$sSQL,$tabOptions) { $sEscape = $this->F57e42f93(); if (isset($tabOptions['SELECT'])) { $sSQL .= " SELECT "; if (!is_array($tabOptions['SELECT'])) { $sSQL .= " ".$this->F57e42f93($tabOptions['SELECT'])." "; } else { $bPremier = true; foreach ($tabOptions['SELECT'] as $sRubrique) { if (!$bPremier) $sSQL .= ','; $bPremier = false; $sSQL .= $this->F57e42f93($sRubrique); } } } if (isset($tabOptions['FROM'])) { if ((utf8_strcasecmp(utf8_substr(utf8_ltrim($tabOptions['FROM']),0,4),'FROM')!==0) && (utf8_strcasecmp(utf8_substr(utf8_rtrim($sSQL),max(0,utf8_strlen($sSQL)-5)),'FROM')!==0)) $sSQL .= " FROM "; if (!is_array($tabOptions['FROM'])) { $sSQL .= ( (isset($tabOptions['SOURCE'])&&((4==$tabOptions['SOURCE']))) || (utf8_strpos($tabOptions['FROM'],$sEscape)!==false) ) ? " ".$tabOptions['FROM']." " : " ".$this->F57e42f93($tabOptions['FROM'])." "; } else { $bPremier = true; foreach ($tabOptions['FROM'] as $sFichier) { if (!$bPremier) $sSQL .= ','; $bPremier = false; $sSQL .= $this->F57e42f93($sFichier); } } } if (isset($tabOptions['WHERE'])) { if ((utf8_strcasecmp(utf8_substr(utf8_ltrim($tabOptions['WHERE']),0,5),'WHERE')!==0) && (utf8_strcasecmp(utf8_substr(utf8_rtrim($sSQL),max(0,utf8_strlen($sSQL)-6)),'WHERE')!==0)) $sSQL .= " WHERE "; if (is_array($tabOptions['WHERE'])) { $sSQL .= implode(' AND ',$tabOptions['WHERE']); } else { $sSQL .= $tabOptions['WHERE']; } } if (isset($tabOptions['ORDERBY'])) { if ((utf8_strcasecmp(utf8_substr(utf8_ltrim($tabOptions['ORDERBY']),0,8),'ORDER BY')!==0) && (utf8_strcasecmp(utf8_substr(utf8_rtrim($sSQL),max(0,utf8_strlen($sSQL)-9)),'ORDER BY')!==0)) $sSQL .= " ORDER BY "; if (is_array($tabOptions['ORDERBY'])) { $sSQL .= implode(',',$tabOptions['ORDERBY']); } else { $sSQL .= $tabOptions['ORDERBY']; } } } function F0d85e54f(&$pclFichier, $sCondition, &$TabRubriques) { $sConditionSQL = ""; $TabSeparateur = array(' ', '(', ')', '<', '>', '=', '~', ']'); $TabMotLiaison = array("ET", "OU", "OR", "AND"); $nIndex = 0; $cCaractereCourant = ''; $nNbParentheseOuvrante = 0; $nNbParentheseFermante = 0; $sOperateurComparaison = ''; $sMotLiaison = ''; $sLastExpression = ''; $bExpressionGauche = false; $bWaitForOperateur = false; $bWaitForMotLiaison = false; $bWaitForExpressionGauche = false; $nLongueur = utf8_strlen($sCondition); while($nIndex < $nLongueur) { $cCaractereCourant = utf8_substr($sCondition, $nIndex, 1); switch ($cCaractereCourant) { case '\'' : $expression = '\''; ++$nIndex; $cCaractereCourant = utf8_substr($sCondition, $nIndex, 1); while($nIndex < $nLongueur && $cCaractereCourant != '\'') { $expression .= $cCaractereCourant; ++$nIndex; $cCaractereCourant = utf8_substr($sCondition, $nIndex, 1); } if($nIndex >= $nLongueur) { Erreur('ErreurHF',"ErreurFiltreQuoteManquante"); } else { $expression.='\''; if($bWaitForOperateur || $bWaitForMotLiaison) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $expression); } $bExpressionGauche = !$bExpressionGauche; if($bExpressionGauche) { $bWaitForOperateur = true; $bWaitForExpressionGauche = false; } else { $bWaitForMotLiaison = true; switch($sOperateurComparaison) { case ']' : case '~]' : $expression = utf8_substr_replace($expression, '%', 1, 0); $expression = utf8_substr_replace($expression, '%', utf8_strlen($expression) - 1, 0); break; case ']=' : $expression = utf8_substr_replace($expression, '%', utf8_strlen($expression) - 1, 0); break; } } $nTaille = utf8_strlen($expression); $pclRubAnalyse =& GetRubrique($pclFichier,$sLastExpression); $sValeurExpression = ''; if ($nTaille>2) { $sValeurExpression = utf8_substr($expression,1,$nTaille-2); $expression = $this->Fdc8698c9($pclRubAnalyse,$sValeurExpression); } $sConditionSQL .= $expression; $sConditionSQL .= $this->F9cff51f0($pclRubAnalyse,$sValeurExpression,$sOperateurComparaison); $sLastExpression = $expression; } break; case '(': $sConditionSQL .= '('; ++$nNbParentheseOuvrante; break; case ')': $sConditionSQL .= ')'; ++$nNbParentheseFermante; break; case '<' : $sConditionSQL .= '<'; $sOperateurComparaison= '<'; $cNextCar = utf8_substr($sCondition, $nIndex + 1, 1); if($cNextCar == '=' || $cNextCar == '>') { $sConditionSQL .= $cNextCar; ++$nIndex; $sOperateurComparaison .= $cNextCar; } if(!$bWaitForOperateur) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } $bWaitForOperateur = false; break; case '>' : $sConditionSQL .= '>'; $sOperateurComparaison= '>'; $cNextCar = utf8_substr($sCondition, $nIndex + 1, 1); if($cNextCar == '=') { $sConditionSQL .= $cNextCar; ++$nIndex; $sOperateurComparaison .= $cNextCar; } if(!$bWaitForOperateur) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } $bWaitForOperateur = false; break; case '~' : $sOperateurComparaison= '~'; $cNextCar = utf8_substr($sCondition, $nIndex + 1, 1); if($cNextCar == '=' || $cNextCar == '~' || $cNextCar == ']') { ++$nIndex; $sOperateurComparaison .= $cNextCar; } else { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } switch($sOperateurComparaison) { case "~=" : case "~~" : Erreur('ErreurHF_1_Param',"ErreurFiltreOperateurInterdit", $sOperateurComparaison); break; case "~]" : $sConditionSQL .= " LIKE "; break; } if(!$bWaitForOperateur) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } $bWaitForOperateur = false; break; case '=' : $sOperateurComparaison= $cCaractereCourant; $cNextCar = utf8_substr($sCondition, $nIndex + 1, 1); if($cNextCar == '=') { ++$nIndex; $sOperateurComparaison .= $cNextCar; } $sConditionSQL .= " = "; if(!$bWaitForOperateur) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } $bWaitForOperateur = false; break; case ']' : $sOperateurComparaison= $cCaractereCourant; $cNextCar = utf8_substr($sCondition, $nIndex + 1, 1); if($cNextCar == '=') { ++$nIndex; $sOperateurComparaison .= $cNextCar; } $sConditionSQL .= " LIKE "; if(!$bWaitForOperateur) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } $bWaitForOperateur = false; break; case ' ' : $sConditionSQL .= ' '; break; default : $expression = ''; while($nIndex < $nLongueur && !in_array($cCaractereCourant, $TabSeparateur)) { $expression .= $cCaractereCourant; ++$nIndex; $cCaractereCourant = utf8_substr($sCondition, $nIndex, 1); } if(in_array(utf8_strtoupper($expression), $TabMotLiaison)) { if(!$bWaitForMotLiaison) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $expression); } $bWaitForMotLiaison = false; switch(utf8_strtoupper($expression)) { case 'ET' : case 'AND' : $sConditionSQL .= 'AND'; break; case 'OU' : case 'OR' : $sConditionSQL .= 'OR'; break; default : break; } $sMotLiaison = $expression; $bWaitForExpressionGauche = true; } else { if($bWaitForOperateur || $bWaitForMotLiaison) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $expression); } $bExpressionGauche = !$bExpressionGauche; if($bExpressionGauche) { $bWaitForOperateur = true; $bWaitForExpressionGauche = false; } else { $bWaitForMotLiaison = true; } $sLastExpression = $expression; if(!is_numeric($expression)) { $pclRubrique =& $pclFichier->getRubrique($expression); if (isset($pclRubrique)) { $sConditionSQL .= $this->Ff43faec2($pclRubrique,$pclRubrique->sNom,'WHERE'); } else { $sConditionSQL .= $this->F57e42f93($expression); } if(($nPos = utf8_strpos($expression, ".")) !== false) { $sNomFichier = utf8_substr($expression, 0, $nPos); if(Fda9fdf77($pclFichier->sNomLogique, $sNomFichier, ccSansCasse + ccSansAccent) != 0) { Erreur('ErreurHF_1_Param',"ErreurFiltreClauseFrom", $sNomFichier, ''); } $expression = utf8_substr($expression, $nPos + 1, utf8_strlen($expression)); } $TabRubriques[ ] = $expression; } else { $sConditionSQL .= $expression; } } --$nIndex; break; } ++$nIndex; } if($nNbParentheseOuvrante < $nNbParentheseFermante) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", ')'); } if($nNbParentheseOuvrante > $nNbParentheseFermante) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", '('); } if($bWaitForOperateur) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sLastExpression); } if($bExpressionGauche) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sOperateurComparaison); } if($bWaitForExpressionGauche) { Erreur('ErreurHF_1_Param',"ErreurFiltreMotInnatendu", $sMotLiaison); } return $sConditionSQL; } function F9cff51f0($pclRubAnalyse,$sValeurExpression,$sOperateurComparaison) { return ''; } function Fe9b48ff7(&$pclFichier,$tabOptionsSQL = null, $Rubrique = null) { $sRubCount = (isset($Rubrique)) ? $Rubrique->F9047540f() : '*'; $sFrom = $pclFichier->F41e5bf49(null); $sFrom = (utf8_strpos(utf8_strtoupper($sFrom),'SELECT')!==false) ? $sFrom : $this->F57e42f93($sFrom); if (isset($tabOptionsSQL)) { $tabOptionsSQL['FROM'] = $sFrom; $sSQL = 'SELECT *'; $this->F850edd33($sSQL,$tabOptionsSQL); $sSQL = '('.$sSQL.') '. $this->F57e42f93(__FUNCTION__); } else { $sSQL = $sFrom; } $sSQL = 'SELECT COUNT('.$sRubCount.') FROM '.$sSQL; return $this->query($sSQL); } function F36b4d334(&$pclFichier,$sCodeSQL) { if ($pclFichier->m_clWDRInfo->Fb96834e7()>0) { $result = null; $sCodeSQL = utf8_trim($sCodeSQL); for ($i = 0; $i<$pclFichier->m_clWDRInfo->Fb96834e7(); $i++) { $sFichierCourant = $pclFichier->m_clWDRInfo->Fafa7a454($i); $Fichier =& F80229053(utf8_trim($sFichierCourant),false,false); if (isset($Fichier)) $pclFichier->TabFichierRequete[utf8_trim(utf8_strtolower($sFichierCourant))] =& $Fichier; } return true; } elseif(preg_match('/.+FROM\s(.+)((\s+(WHERE)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(GROUP BY)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(HAVING)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(UNION)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(ORDER BY)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(COMPUTE)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(FOR BROWSE)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(OPTION)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)((\s+(LIMIT)\s.+))/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0 || preg_match('/.+FROM\s(.+)$/'.UNICODE_REGEXP.'i', $sCodeSQL, $result) > 0) { $sFROM = utf8_trim($result[1]); $tab = utf8_explode(',', $sFROM); foreach($tab as $sNomFichier) { if ( utf8_strpos($sNomFichier,"JOIN") !== false) { $tabFrom = utf8_explode("JOIN ",$sNomFichier); foreach ($tabFrom as $cel) { $sFichierCourant = utf8_substr($cel,0,utf8_strpos($cel,' ')); $Fichier = &Fbad7a601(utf8_trim($sFichierCourant)); $pclFichier->TabFichierRequete[utf8_trim(utf8_strtolower($sFichierCourant))] = &$Fichier; } } else if(preg_match('/(.+)\s+AS\s+(.+)/'.UNICODE_REGEXP.'i', utf8_trim($sNomFichier), $result) > 0 || preg_match('/(.+)\s+(.+)/'.UNICODE_REGEXP.'i', utf8_trim($sNomFichier), $result) > 0) { $Fichier =& Fbad7a601(utf8_trim($result[1])); $pclFichier->TabFichierRequete[utf8_trim(utf8_strtolower($result[2]))] =& $Fichier; } else { $Fichier =& Fbad7a601(utf8_trim($sNomFichier)); $pclFichier->TabFichierRequete[utf8_trim(utf8_strtolower($sNomFichier))] =& $Fichier; } } return true; } Erreur('ErreurHF_1_Param',"ErreurClauseFrom", $pclFichier->sNomLogique, ""); return false; } function F8cd1fa6d($sSelect) { $nNbParentheseOuvrante = 0; $nIndiceCourant = 0; $TabRubriques = array(); $RubriqueCourante = ""; for ($i = 0; $i < utf8_strlen($sSelect); $i++) { $c = utf8_substr($sSelect, $i, 1); switch($c) { case '(' : ++$nNbParentheseOuvrante; $RubriqueCourante .= $c; break; case ')': --$nNbParentheseOuvrante; $RubriqueCourante .= $c; break; case ',' : if($nNbParentheseOuvrante == 0) { $TabRubriques[$nIndiceCourant] = $RubriqueCourante; $RubriqueCourante = ''; ++$nIndiceCourant; } else { $RubriqueCourante .= $c; } break; default : $RubriqueCourante .= $c; break; } } if(!empty($RubriqueCourante)) { $TabRubriques[$nIndiceCourant] = $RubriqueCourante; } return $TabRubriques; } function Ff783b6ff($sExpression) { if(count(preg_grep('/(SUM|AVG|COUNT|MAX|MIN)\s*\(.*/'.UNICODE_REGEXP.'i', array($sExpression)))>0) { return TYPE_CALCULE; } return UNICODE_PAGE_UTF8 ? TYPE_UNICODE : TYPE_CHAINE; } function F0dd17814(&$pclRequete,$sCodeSQL) { $result = null; $nTagExpression = WD_EXPRESSION; if ( ($pclRequete->m_clWDRInfo->Fd0a8b34d()>0) || (preg_match('/SELECT\s+(ALL|DISTINCT)?(\s*TOP\s+\d+\s*(PERCENT)?)?(.+)(((FROM|INTO).+))/'.UNICODE_REGEXP.'i', utf8_trim($sCodeSQL), $result) > 0) ) { $tabFichierDeLaRubrique = $tab = array(); if (!isset($result)) { for($nIndiceRub = 0; $nIndiceRub < $pclRequete->m_clWDRInfo->Fd0a8b34d(); $nIndiceRub++) { $tab[ utf8_trim($pclRequete->m_clWDRInfo->F56263717($nIndiceRub)) ] = $pclRequete->m_clWDRInfo->F790930e8($nIndiceRub); $tabFichierDeLaRubrique[utf8_trim($pclRequete->m_clWDRInfo->F56263717($nIndiceRub)) ] = utf8_trim($pclRequete->m_clWDRInfo->F4b91a9e9($nIndiceRub)) ; } } else { $sSELECT = utf8_trim($result[4]); $tab = $pclRequete->F8cd1fa6d($sSELECT); } $nIndexRubrique = 1; $Rubrique = null; foreach($tab as $sAlias => $sNomRubrique) { $sRubrique = utf8_trim($sNomRubrique); if (isset($result)) { $sAlias = ''; $result1 = null; if(preg_match('/(.+)\s+AS\s+(.+)/'.UNICODE_REGEXP.'i', utf8_trim($sRubrique), $result1) > 0) { $sAlias = utf8_trim($result1[2]); $sRubrique = utf8_trim($result1[1]); } } $result2 = null; if(is_numeric($sRubrique)) { $Rubrique =& $nTagExpression; } else if ( ( (!isset($result)) && (utf8_strlen($tabFichierDeLaRubrique[$sAlias]) > 0) ) || ( (isset($result)) && (preg_match('/(.+)\.(.+)/'.UNICODE_REGEXP.'i', utf8_trim($sRubrique), $result2) > 0) ) ) { if (!isset($result2)) { $sNomFichier = utf8_strtolower($tabFichierDeLaRubrique[$sAlias]); $sRubrique = $sNomRubrique; } else { $sNomFichier = utf8_strtolower(utf8_trim($result2[1])); $sRubrique = utf8_trim($result2[2]); } if(array_key_exists($sNomFichier, $pclRequete->TabFichierRequete)&&(array_key_exists(utf8_strtolower($sRubrique), $pclRequete->TabFichierRequete[$sNomFichier]->TabRubriques))) { $Rubrique =& _clone( $pclRequete->TabFichierRequete[$sNomFichier]->F133178d5($sRubrique) ); $Rubrique->Fe37f0136(); } else { $Rubrique =& $nTagExpression; } } else { $TabNomFichier = array_keys($pclRequete->TabFichierRequete); $nNbFichiers = count($TabNomFichier); for($i=0;$i<$nNbFichiers;$i++) { $Fichier = $pclRequete->TabFichierRequete[$TabNomFichier[$i]]; if($sRubrique == '*') { foreach(array_keys($Fichier->TabRubriques) as $sNom) { if ($pclRequete->Fc36b6a50($sNom)) continue; $Rubrique =& _clone($Fichier->TabRubriques[$sNom]); $Rubrique->Fe37f0136(); $pclRequete->F2c5c1106($Rubrique); } } else { if(array_key_exists(utf8_strtolower($sRubrique), $Fichier->TabRubriques)) { $Rubrique =& $Fichier->F133178d5($sRubrique); $Rubrique =& _clone($Rubrique); $Rubrique->Fe37f0136(); break; } } } if($i == $nNbFichiers) { if($sRubrique == '*') { continue; } else { $Rubrique =& $nTagExpression; } } } if( (is_scalar($Rubrique)) && ($Rubrique === WD_EXPRESSION)) { if(!empty($sAlias)) { $Rubrique =& $pclRequete->Faa097ba5($sAlias, $pclRequete->Ff783b6ff($sRubrique)); $pclRequete->F2c5c1106($Rubrique); } else { $sNomExpression = "expr".$nIndexRubrique; $pclRequete->TabNomRubriqueSansAccent[$sNomExpression] = $sNomExpression; $pclRequete->TabRubriques[$sNomExpression] = $pclRequete->Faa097ba5($sRubrique, $pclRequete->Ff783b6ff($sRubrique)); } ++$nIndexRubrique; } else { if(!empty($sAlias)) { $Rubrique->sNom = $sAlias; $Rubrique->sNomBase = $sRubrique; if (!$pclRequete->Fc36b6a50($Rubrique->sNom)) $pclRequete->F2c5c1106($Rubrique); } else { $Rubrique->sNom = $sRubrique; $Rubrique->sNomBase = $sRubrique; if (!$pclRequete->Fc36b6a50($Rubrique->sNom)) $pclRequete->F2c5c1106($Rubrique); } } } return true; } Erreur('ErreurHF_1_Param',"ErreurClauseSelect", $pclRequete->sNom, ""); return false; } function Fa18b40ba(&$pclRequete,$sCodeSQL) { $TabNomRubriques = array(); $result = null; if ( ($pclRequete->m_clWDRInfo->F4d68ebe1() >0) || ((utf8_strpos(utf8_strtolower($sCodeSQL),'order by')!==false) && ((preg_match('/.+ORDER\s+BY\s(.+)(\s+(COMPUTE|FOR BROWSE|LIMIT|OPTION)\s.+)/'.UNICODE_REGEXP.'i', utf8_trim($sCodeSQL), $result) > 0) || (preg_match('/.+ORDER\s+BY\s(.+)$/'.UNICODE_REGEXP.'i', utf8_trim($sCodeSQL), $result) > 0)) ) ) { $pclRequete->bOrderBy = true; if (isset($result)) { $sORDERBY = utf8_trim($result[1]); $pclRequete->sOrderByInitial = "ORDER BY ".$sORDERBY; } else { $sORDERBY = ''; $bNePasToucherDansOrderByInitial = (!empty($pclRequete->sOrderByInitial)); if (!$bNePasToucherDansOrderByInitial) $pclRequete->sOrderByInitial = "ORDER BY "; for ($nIndiceOrder = 0; $nIndiceOrder< $pclRequete->m_clWDRInfo->F4d68ebe1(); $nIndiceOrder++) { if ($nIndiceOrder>0) { $sORDERBY .= ', '; if (!$bNePasToucherDansOrderByInitial)$pclRequete->sOrderByInitial .= ', '; } $sORDERBY .= $pclRequete->m_clWDRInfo->F4b258a96($nIndiceOrder); if (!$bNePasToucherDansOrderByInitial) $pclRequete->sOrderByInitial .= $pclRequete->m_clWDRInfo->F4b258a96($nIndiceOrder).' '.$pclRequete->m_clWDRInfo->F3f046208($nIndiceOrder) ; } } $tab = utf8_explode(',', $sORDERBY); $nBorneMax=count($tab); for($i=0;$i<$nBorneMax;$i++) { $sNomRubrique = utf8_trim( $tab[$i] ); $result2 = null; if ( (!isset($result)) || (preg_match('/(.*\.)?(.+)/'.UNICODE_REGEXP.'i', $sNomRubrique, $result2) > 0) ) { if (isset($result2)) { $sNomRubrique = utf8_trim($result2[2]); $nPos = utf8_strpos($sNomRubrique,' '); if($nPos!==false) { $sNomRubrique = utf8_substr($sNomRubrique, 0, $nPos); } $result2 = null; } if (isset($pclRequete->TabRubriques[utf8_strtolower($sNomRubrique)])) $Rubrique = &$pclRequete->TabRubriques[utf8_strtolower($sNomRubrique)]; if(isset($Rubrique)) { if(!isset($pclRequete->RubriqueOrderBy)) { $pclRequete->RubriqueOrderBy = &$Rubrique; $pclRequete->bAscOrderBy = ($pclRequete->m_clWDRInfo->F3f046208(0) === 'ASC'); } $TabNomRubriques[] = $Rubrique->sNom; $pclRequete->RubSequence[] = $Rubrique; } } } if(isset($pclRequete->RubriqueOrderBy)) { $TabRub = $pclRequete->F0e38ea93($pclRequete->RubriqueOrderBy); $nBorneMax = count($TabRub); for($i=0;$i<$nBorneMax;$i++) { $RubriqueCourante = &$TabRub[$i]; if(!in_array($RubriqueCourante->sNom, $TabNomRubriques)) { $pclRequete->TabRubriqueOrderBy[] = $RubriqueCourante; $pclRequete->RubSequence[] = $RubriqueCourante; } } } } } function F08193936(&$pclRequete,$sNomConnexion, $TabParam) { $bAuMoinsUnParamNull = false; if (isset($pclRequete->TabParamRequete)) { $tabAssocParamValeur = array(); $tabNomParam = array_keys($pclRequete->TabParamRequete); if (isset($TabParam) && (count($TabParam,COUNT_NORMAL)>0)) { foreach ($tabNomParam as $sNom) { $pclRequete->TabParamRequete[$sNom] = null; } } else { foreach ($tabNomParam as $sNom) { $TabParam[] = $pclRequete->TabParamRequete[$sNom]; $pclRequete->TabParamRequete[$sNom] = null; } } $nOccurrence=count($tabNomParam,COUNT_NORMAL); for($i=0; $i<$nOccurrence; $i++) { if (isset($TabParam[$i])) { $tabAssocParamValeur[$tabNomParam[$i]] = $TabParam[$i]; } else { $tabAssocParamValeur[$tabNomParam[$i]] = null; $bAuMoinsUnParamNull = true; } } } else { $tabAssocParamValeur = null; } if ($pclRequete->nMode !== H_REQUETE_SANS_CORRECTION && isset($pclRequete->m_clWDRInfo)) { $clArbreRequete =& $pclRequete->m_clWDRInfo->F7361f67d(); if (isset($clArbreRequete)) { if(!empty($sNomConnexion)) { $pclRequete->sNomConnexion = $sNomConnexion; } $sCodeSQL = $clArbreRequete->Ffaa5b6f5($this,$tabAssocParamValeur); $pclRequete->sOrderByInitial = utf8_trim($this->Fdf02384a($clArbreRequete)); if (AN_SPY_SQL) { $sCodeSQL=&$sCodeSQL; if (function_exists('Ecriture_gEcritINF')) call_user_func('Ecriture_gEcritINF',$sCodeSQL); } $pclRequete->sCodeSQL = $sCodeSQL; $pclRequete->nTypeRequete = $pclRequete->F9d60968a($pclRequete->sCodeSQL); switch ($pclRequete->nTypeRequete) { case REQUETE_SELECT : $bOK = $this->F3bd60944($pclRequete,$this->F17b34f65($sCodeSQL),$bAuMoinsUnParamNull); if ($bOK) return true; break; case REQUETE_DELETE : case REQUETE_INSERT : case REQUETE_UPDATE : { $this->m_resConnexionId = $pclRequete->F475159c6(); $nResultQuery = $pclRequete->F52651677($pclRequete->sCodeSQL, $this->m_resConnexionId); if($nResultQuery===false) { if($bAuMoinsUnParamNull) { $this->Fba409abd($this->m_resConnexionId, $pclRequete->sNom); return false; } } else { $pclRequete->bHTrouve = false; $pclRequete->bHEnDehors = true; return true; } } break; } } } if ($bAuMoinsUnParamNull) { return false; } return $this->Fd398930a($pclRequete,$sNomConnexion, $TabParam); } function Faa055082(&$pclRequete,$sClause) { if (!isset($this->m_pclRequeteEnCours)) $this->m_pclRequeteEnCours =& $pclRequete; $pclRequete->m_pszClauseEnCours = $sClause; } function F8b1e2536(&$pclRequete) { if (isset($this->m_pclRequeteEnCours)) { $pclBackup =& $this->m_pclRequeteEnCours; $null = null; $this->m_pclRequeteEnCours =& $null; } $this->m_pclRequeteEnCours =& $pclRequete; switch ($pclRequete->m_nTypeRequete) { case eSELECTUNION: case eSELECT: $sCode = $this->Fd7721307($pclRequete); $sCode = utf8_trim($sCode); $n =utf8_strlen($sCode); if ( (utf8_substr($sCode,0,1)=='(')&&(utf8_substr($sCode,$n-1,1)==')')&&(count($pclRequete->m_tabItems,COUNT_NORMAL)==0) ) { $sCode = utf8_substr($sCode,1,$n-2); } break; case eUPDATE: $sCode = $this->F50eaf814($pclRequete); break; case eINSERT: $sCode = $this->F1935fad5($pclRequete); break; case eDELETE: $sCode = $this->Fd9e24443($pclRequete); break; case eCREATE_TABLE: case eDROP_TABLE: default: $sCode = null; } $this->m_pclRequeteEnCours->m_pszClauseEnCours = null; if (isset($pclBackup)) { $this->m_pclRequeteEnCours =& $pclBackup; unset($pclBackup); } else { $null = null; $this->m_pclRequeteEnCours =& $null; } return $sCode; } function Fd9e24443(&$pclRequete) { $sCodeSQL = ''; $pclRequete->m_pszCodeSQLEnCours =& $sCodeSQL; $sCodeSQL .= $this->F5304ec10($pclRequete); $sCodeSQL_WHERE = $this->Fbf1b4678($pclRequete); if (isset($sCodeSQL_WHERE)) $sCodeSQL.=$sCodeSQL_WHERE.' '; return $sCodeSQL; } function F5304ec10(&$pclRequete) { $this->Faa055082($pclRequete,'DELETE'); $sCodeSQL = 'DELETE '; $sFichier = Ffaa5b6f5($pclRequete->m_clFrom,$this); $sCodeSQL.= 'FROM ' . $sFichier . ' '; return $sCodeSQL; } function F1935fad5(&$pclRequete) { $sCodeSQL = ''; $pclRequete->m_pszCodeSQLEnCours =& $sCodeSQL; $sCodeSQL = $this->F3274f76b($pclRequete); return $sCodeSQL; } function F3274f76b(&$pclRequete) { $this->Faa055082($pclRequete,'INSERT'); $pclFichier =& F80229053($pclRequete->m_clFrom->m_sNom,false,false); if (isset($pclFichier)) { $tabMaj = $pclRequete->m_clSet->m_tabItems; $nOccurrence = count( $tabMaj , COUNT_NORMAL); $bAuMoinsUn = false; $Enreg = array(); $this->Faa055082($pclRequete,'VALUES'); for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $clColonne = $tabMaj[$nKey]['COLONNE']; $clExpression = $tabMaj[$nKey]['EXPRESSION']; $sCodeValeur = Ffaa5b6f5($clExpression,$this,true); $sNomOuNomComplet = $clColonne->m_sNom; $nPosPoint = utf8_strpos($sNomOuNomComplet,'.'); $sNomRubrique = ($nPosPoint===false) ? $sNomOuNomComplet : utf8_substr($sNomOuNomComplet,$nPosPoint+1); $Enreg[$sNomRubrique] = $this->F137bdb94($sCodeValeur); } $nIdAuto = false; $sNomRubIdAuto = ''; $sCodeSQL = $this->F7aeb10e1($pclFichier,$Enreg,$nIdAuto,$sNomRubIdAuto,false,false); } else { $sCodeSQL = 'INSERT '; $sFichier = Ffaa5b6f5($pclRequete->m_clFrom,$this); $sCodeSQL.= 'INTO ' . $sFichier . ' '; $sCodeRubriques = ''; $sCodeValues = ''; $tabMaj = $pclRequete->m_clSet->m_tabItems; $nOccurrence = count( $tabMaj , COUNT_NORMAL); $bAuMoinsUn = false; for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $clColonne = $tabMaj[$nKey]['COLONNE']; $clExpression = $tabMaj[$nKey]['EXPRESSION']; $this->Faa055082($pclRequete,'INSERT'); $sCodeColonne = Ffaa5b6f5($clColonne,$this); $this->Faa055082($pclRequete,'VALUES'); $sCodeValeur = Ffaa5b6f5($clExpression,$this,true); if (!isset($sCodeColonne)||!isset($sCodeValeur)) continue; if ($bAuMoinsUn) { $sCodeRubriques .= ','; $sCodeValues .= ','; } else { $sCodeRubriques .= '('; $sCodeValues .= '('; } $this->F3f69ad5f($clColonne,$sCodeColonneUNUSED, $clExpression,$sCodeValeur); $sCodeRubriques.= $sCodeColonne; $sCodeValues.= $sCodeValeur; } if (!empty($sCodeRubriques)) { $sCodeRubriques .= ')'; $sCodeValues .= ')'; $sCodeSQL.=$sCodeRubriques. ' VALUES '.$sCodeValues; } } return $sCodeSQL; } function F50eaf814(&$pclRequete) { $sCodeSQL = ''; $pclRequete->m_pszCodeSQLEnCours =& $sCodeSQL; $sCodeSQL .= $this->F974a87e6($pclRequete); $sCodeSQL .= $this->Fd1f78f4b($pclRequete); $sCodeSQL_WHERE = $this->Fbf1b4678($pclRequete); if (isset($sCodeSQL_WHERE)) $sCodeSQL.=$sCodeSQL_WHERE.' '; return $sCodeSQL; } function Fd1f78f4b(&$pclRequete) { $this->Faa055082($pclRequete,'SET'); $sCodeSQL = ''; $tabMaj = $pclRequete->m_clSet->m_tabItems; $nOccurrence = count( $tabMaj ); $bAuMoinsUneMaj = false; for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $clColonne = $tabMaj[$nKey]['COLONNE']; $clExpression = $tabMaj[$nKey]['EXPRESSION']; $sCodeColonne = Ffaa5b6f5($clColonne,$this); $sCodeValeur = Ffaa5b6f5($clExpression,$this,true); if (!isset($sCodeColonne)||!isset($sCodeValeur)) continue; if ($bAuMoinsUneMaj) $sCodeSQL .= ' , '; else $sCodeSQL .= 'SET '; $this->F3f69ad5f($clColonne,$sCodeColonneUNUSED, $clExpression,$sCodeValeur); $sCodeSQL .= $sCodeColonne.' = '.$sCodeValeur.' '; $bAuMoinsUneMaj = true; } return $sCodeSQL; } function F974a87e6(&$pclRequete) { $this->Faa055082($pclRequete,'UPDATE'); $sCodeSQL = 'UPDATE '; $sFichier = Ffaa5b6f5($pclRequete->m_clFrom,$this); $sCodeSQL.= $sFichier . ' '; return $sCodeSQL; } function F68102545(&$pclRequete) { $this->Faa055082($pclRequete,'SELECT'); $sCodeSQL = 'SELECT '; if ($pclRequete->m_clSelect->m_eOPTIONSELECT == eDISTINCT) { $sCodeSQL .= 'DISTINCT '; } $tabRubriquesOUT = $pclRequete->m_clSelect->m_tabItems; $nOccurrence = count( $tabRubriquesOUT ); $bAuMoinsUnOUT = false; for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sSelectionCourante = Ffaa5b6f5($tabRubriquesOUT[ $nKey ],$this); if (isset($sSelectionCourante)) { if ($bAuMoinsUnOUT) $sCodeSQL .= ','; $sCodeSQL .= $sSelectionCourante . ' '; if (isset($tabRubriquesOUT[ $nKey ]->m_sAlias)) { $sCodeSQL .= 'AS ' . $this->F57e42f93( $tabRubriquesOUT[ $nKey ]->m_sAlias).' '; } $bAuMoinsUnOUT = true; } } return $sCodeSQL; } function F6b91b14a(&$pclRequete) { $this->Faa055082($pclRequete,'FROM'); $sCodeSQL = 'FROM '; $tabSources =& $pclRequete->m_clFrom->m_tabItems; $nOccurrence = count( $tabSources ); $bAuMoinsUnFrom = false; for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sFromEnCours = Ffaa5b6f5($tabSources[ $nKey ],$this); if (!isset($sFromEnCours)||empty($sFromEnCours)) continue; if ($bAuMoinsUnFrom) $sCodeSQL .= ' , '; $sCodeSQL .= $sFromEnCours; $bAuMoinsUnFrom = true; } return $sCodeSQL; } function Fbf1b4678(&$pclRequete) { $this->Faa055082($pclRequete,'WHERE'); $tabConditions = (isset($pclRequete->m_clWhere)) ? $pclRequete->m_clWhere->m_tabItems : null; if (isset($tabConditions)) { $sCodeSQL_WHERE = Ffaa5b6f5($tabConditions[ 0 ],$this); if (isset($sCodeSQL_WHERE)&&!empty($sCodeSQL_WHERE)) { return 'WHERE ' . $sCodeSQL_WHERE.' '; } } return null; } function Fb8b32e53(&$pclRequete) { $this->Faa055082($pclRequete,'GROUP BY'); $tabGroupes = (isset($pclRequete->m_clGroupBy)) ? $pclRequete->m_clGroupBy->m_tabItems : null; if (isset($tabGroupes)) { $sCodeSQL_GROUPBY = null; $nOccurrence = count( $tabGroupes ); $bAuMoinsUnGroup = false; for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sGroupeCourant = Ffaa5b6f5($tabGroupes[ $nKey ],$this); if (isset($sGroupeCourant)) { if ($bAuMoinsUnGroup) $sCodeSQL_GROUPBY .= ','; $sCodeSQL_GROUPBY .= $sGroupeCourant . ' '; $bAuMoinsUnGroup = true; } } if ($bAuMoinsUnGroup) { return 'GROUP BY '.$sCodeSQL_GROUPBY.' '; } } return null; } function F5ad742de(&$pclRequete) { $this->Faa055082($pclRequete,'HAVING'); $tabConditions = (isset($pclRequete->m_clHaving)) ? $pclRequete->m_clHaving->m_tabItems : null; if (isset($tabConditions)) { $sCodeSQL_HAVING = Ffaa5b6f5($tabConditions[ 0 ],$this); if (isset($sCodeSQL_HAVING)&&!empty($sCodeSQL_HAVING)) { return 'HAVING ' . $sCodeSQL_HAVING; } } return null; } function Fdf02384a(&$pclRequete,$bIgnoreBottom = false,$bInverseOrdre=false) { $this->Faa055082($pclRequete,'ORDER BY'); $sCodeSQL = ''; $tabOrdres = (isset($pclRequete->m_clOrderBy)) ? $pclRequete->m_clOrderBy->m_tabItems : null; $pclLimit =& $pclRequete->m_clLimit; if (isset($tabOrdres)) { $sCodeSQL_ORDERBY = null; $nOccurrence = count( $tabOrdres ); $bAuMoinsUnOrdre = false; for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sOrdreCourant = Ffaa5b6f5($tabOrdres[ $nKey ],$this); if (isset($sOrdreCourant)) { if ($bAuMoinsUnOrdre) $sCodeSQL_ORDERBY .= ','; $sCodeSQL_ORDERBY .= $sOrdreCourant . ' '; if (isset($tabOrdres[ $nKey ]->m_tabOptions['ORDERBY'])) { switch ($tabOrdres[ $nKey ]->m_tabOptions['ORDERBY']) { case eCROISSANT: $sCodeSQL_ORDERBY .= ($bInverseOrdre || (!$bIgnoreBottom && isset($pclLimit) && $pclLimit->m_nType==eBOTTOM)) ? 'DESC ' : 'ASC '; break; case eDECROISSANT: $sCodeSQL_ORDERBY .= ($bInverseOrdre || (!$bIgnoreBottom && isset($pclLimit) && $pclLimit->m_nType==eBOTTOM)) ? 'ASC ' : 'DESC '; break; default: } } $bAuMoinsUnOrdre = true; } } if ($bAuMoinsUnOrdre) { $sCodeSQL .= 'ORDER BY '.$sCodeSQL_ORDERBY.' '; return $sCodeSQL; } } return null; } function Fe47eea61(&$pclRequete) { $this->Faa055082($pclRequete,'LIMIT'); $pclLimit =& $pclRequete->m_clLimit; if (isset($pclLimit)) { switch ($pclLimit->m_nType) { case eEVERY: break; case eTOP: case eBOTTOM: case eLIMIT_MYSQL: case eLIMIT_POSTGRESQL: return null; default: } } return null; } function Fd7721307(&$pclRequete) { $sCodeSQL = ''; $pclRequete->m_pszCodeSQLEnCours =& $sCodeSQL; $sCodeSQL .=$this->F68102545($pclRequete).' '; $sCodeSQL .=$this->F6b91b14a($pclRequete).' '; $sCodeSQL_WHERE = $this->Fbf1b4678($pclRequete); if (isset($sCodeSQL_WHERE)) $sCodeSQL.=$sCodeSQL_WHERE.' '; $sCodeSQL_GROUPBY = $this->Fb8b32e53($pclRequete); if (isset($sCodeSQL_GROUPBY)) $sCodeSQL.=$sCodeSQL_GROUPBY.' '; $sCodeSQL_HAVING = $this->F5ad742de($pclRequete); if (isset($sCodeSQL_HAVING)) $sCodeSQL.=$sCodeSQL_HAVING; $sCodeSQL_ORDERBY = $this->Fdf02384a($pclRequete); if (isset($sCodeSQL_ORDERBY)) $sCodeSQL.=$sCodeSQL_ORDERBY; $sCodeSQL_LIMIT = $this->Fe47eea61($pclRequete); if (isset($sCodeSQL_LIMIT)) $sCodeSQL.=$sCodeSQL_LIMIT; if (!empty($pclRequete->m_sAlias)) { $sCodeSQL= '(' . $sCodeSQL . ') AS '. $pclRequete->m_sAlias .' '; } if (isset($pclRequete->m_tabOptions['eOPSousRequeteType'])) { $sMotClefSousRequete = null; switch ($pclRequete->m_tabOptions['eOPSousRequeteType']) { case TYPE_SOUSREQUETE_EXP_SCAL: break; case TYPE_SOUSREQUETE_COMPARAISON: Fa79fbf41('Obsolète : Doit déjà être traité comme TYPE_SOUSREQUETE_EXP_SCAL'); break; case TYPE_SOUSREQUETE_EXISTS: $sMotClefSousRequete = 'EXISTS'; break; case TYPE_SOUSREQUETE_ALL: $sMotClefSousRequete = 'ALL'; break; case TYPE_SOUSREQUETE_ANY: $sMotClefSousRequete = 'ANY'; break; case TYPE_SOUSREQUETE_UNKNOWN: default: } if (isset($sMotClefSousRequete)) { $sCodeSQLOperandeGauche = (isset($pclRequete->m_pclOperande)) ? Ffaa5b6f5($pclRequete->m_pclOperande,$this) : null; if (!empty($sCodeSQLOperandeGauche)) { $sOperateurANYALL = (isset($pclRequete->m_tabOptions['sGetOperateurSousRequeteAnyAll'])) ? $pclRequete->m_tabOptions['sGetOperateurSousRequeteAnyAll'] : '='; $sCodeSQLOperandeGauche .= ' '.$sOperateurANYALL.' '; } $sCodeSQL = $sCodeSQLOperandeGauche . $sMotClefSousRequete .' ('.$sCodeSQL.')'; } } else { $nRequetesLiees = count($pclRequete->m_tabItemsUnion,COUNT_NORMAL); for($nReq = 0; $nReq < $nRequetesLiees; $nReq++) { $tabReq = $pclRequete->m_tabItemsUnion[$nReq]; $tabReq[1]->m_tabParams = $pclRequete->m_tabParams; switch ($tabReq[0]) { case 'UNION': $sCodeSQL = $this->Fa7a7772d($sCodeSQL , Ffaa5b6f5($tabReq[1],$this), (isset($tabReq[2]) ? $tabReq[2] : true)); break; default: } } } return $sCodeSQL; } function Fa7a7772d($sCodeRequete1, $sCodeRequete2, $bAll) { return 'SELECT * FROM (' . $sCodeRequete1 . ') AS '.uniqid('REQ_').' UNION' . ($bAll ? ' ALL' : '') . ' SELECT * FROM (' . $sCodeRequete2.') AS '.uniqid('REQ_'); } function Fc0f43b5f(&$pclParam) { $sNomPouRecherche = utf8_strtolower(F03771b65($pclParam->m_pszNomParametre)); $nIndex = 0; foreach ($this->m_pclRequeteEnCours->m_tabParams as $sNom => $valeur) { if (strcmp($sNomPouRecherche,$sNom)===0) { if (!isset($valeur)) { return null; } else { return $valeur; } } ++$nIndex; } return null; } function F93ec5569(&$pclRubrique) { $sNom = null; switch($this->m_pclRequeteEnCours->m_pszClauseEnCours) { case 'ORDER BY': if (isset($pclRubrique->m_tabOptions['nGetNumColonne'])) { $sNom = $pclRubrique->m_tabOptions['nGetNumColonne']+1; } else { $sNom = $this->F57e42f93( $pclRubrique->m_sAlias ) ; } break; case 'SET': case 'INSERT': { if (utf8_strpos($pclRubrique->m_sNom,'.')===false) $sNom = $this->F57e42f93($pclRubrique->m_sNom ); else { $tabNom = utf8_explode('.',$pclRubrique->m_sNom); $sNom = $this->F57e42f93( $tabNom[1] ); } } break; default: if (utf8_strpos($pclRubrique->m_sNom,'.')===false) { if (!empty($pclRubrique->m_sAliasFichier) && ($pclRubrique->m_sNomFichier != $pclRubrique->m_sAliasFichier)) { $sNom = $this->F57e42f93($pclRubrique->m_sAliasFichier) .'.'.$this->F57e42f93( $pclRubrique->m_sNom ); } else { $sNomFichier = $pclRubrique->m_sNomFichier; $pclFichierAnalyse = F80229053($sNomFichier,false,false); if (isset($pclFichierAnalyse)) { $sNomFichier = $this->F98e40c2c($pclFichierAnalyse->sNom); $pclRubriqueAnalyse =& F2b6640f3($pclFichierAnalyse,$pclRubrique->m_sNom); if (isset($pclRubriqueAnalyse)) { $sNom = $this->Ff43faec2($pclRubriqueAnalyse,$pclRubriqueAnalyse->sNom,$this->m_pclRequeteEnCours->m_pszClauseEnCours); } else { $sNom = $this->F57e42f93($sNomFichier) .'.'.$this->F57e42f93( $pclRubrique->m_sNom ); } } else { $sNom = ($sNomFichier==='' ? '' : $this->F57e42f93($sNomFichier) .'.').$this->F57e42f93( $pclRubrique->m_sNom ); } } } else { $tabNom = utf8_explode('.',$pclRubrique->m_sNom); if (!empty($pclRubrique->m_sAliasFichier) && ($pclRubrique->m_sNomFichier != $pclRubrique->m_sAliasFichier)) { $sNom = $this->F57e42f93($pclRubrique->m_sAliasFichier) .'.'.$this->F57e42f93( $tabNom[1] ); } else { $pclFichierAnalyse =& F80229053($pclRubrique->m_sNomFichier,false,false); if (!isset($pclFichierAnalyse) && $tabNom[0]!=$pclRubrique->m_sNomFichier) $pclFichierAnalyse =& F80229053($tabNom[0],false,false); if (isset($pclFichierAnalyse)) { $tabNom[0] = $pclFichierAnalyse->sNom; $pclRubriqueAnalyse =& F2b6640f3($pclFichierAnalyse,$tabNom[1]); if (isset($pclRubriqueAnalyse)) { $sNom = $this->Ff43faec2($pclRubriqueAnalyse,$pclRubriqueAnalyse->sNom,$this->m_pclRequeteEnCours->m_pszClauseEnCours); } else { $sNom = $this->F57e42f93($tabNom[0]) .'.'.$this->F57e42f93( $tabNom[1] ); } } else { $sNom = $this->F57e42f93( $tabNom[1] ); } } } } $sPrefix = ''; if (isset($pclRubrique->m_tabOptions['eOPTIONSELECT'])) { switch ($pclRubrique->m_tabOptions['eOPTIONSELECT']) { case eDISTINCT: $sPrefix = 'DISTINCT'; break; case eALL: $sPrefix = 'ALL'; break; default: $sPrefix = ''; } } return $sPrefix.' '.$sNom; } function F518ae2fe(&$pclFichier) { $pclFichierAnalyse =& F80229053($pclFichier->m_sNom,false,false); $sNomBase = (isset($pclFichierAnalyse)) ? $pclFichierAnalyse->sNom : $pclFichier->m_sNom; $sNomBase = $this->F98e40c2c($sNomBase); $sNomBase = $this->F57e42f93($sNomBase); return (!empty($pclFichier->m_sAlias)) ? $sNomBase . ' AS ' . $pclFichier->m_sAlias : $sNomBase; } function F79056dd0(&$pclJointure) { $sCodeGauche = Ffaa5b6f5($pclJointure->m_piFilsGauche,$this); $sCodeDroite = Ffaa5b6f5($pclJointure->m_piFilsDroite,$this); if ($pclJointure->m_bFilsGaucheEstTable===false) { $sCodeGauche = '(' . $sCodeGauche . ')'; } if ($pclJointure->m_bFilsDroiteEstTable===false) { $sCodeDroite = '(' . $sCodeDroite . ')'; } $sCodeSQL = $sCodeGauche . ' '; switch ($pclJointure->m_eTypeJointure) { case eOPJOIN_FULL: { $sCodeSQL.= 'FULL OUTER JOIN'; } break; case eOPJOIN_RIGHT: { $sCodeSQL.= 'RIGHT OUTER JOIN'; } break; case eOPJOIN_LEFT: { $sCodeSQL.= 'LEFT OUTER JOIN'; } break; default: case eOPJOIN_NORMAL: { $sCodeSQL.= 'INNER JOIN'; } break; } $sCodeSQL.= ' ' . $sCodeDroite; if ($pclJointure->m_piConditionOn !== null) { $sConditionOn = Ffaa5b6f5($pclJointure->m_piConditionOn,$this); if ($sConditionOn !== null) { $sCodeSQL.= ' ON ' . $sConditionOn; } } return $sCodeSQL; } function& Fae15aba3($sNomFichier,$sNomRubrique) { $pclRubrique = null; $pclFichier =& F80229053($sNomFichier,false,false); if (!isset($pclFichier)) { return $pclRubrique; } if (($nPos=utf8_strpos($sNomRubrique,'.'))!==false) $sNomRubrique = utf8_substr($sNomRubrique,$nPos+1); $pclRubrique =& F2b6640f3($pclFichier,$sNomRubrique,false); if (!isset($pclRubrique)) { return $pclRubrique; } return $pclRubrique; } function F3f69ad5f(&$pclOp1,&$sVal1,&$pclOp2,&$sVal2,$tabOptions=null) { switch ($pclOp1->m_nClasse) { case FMK_SQL_CLASSE_EXPRESSION: switch($pclOp2->m_nClasse) { case FMK_SQL_CLASSE_RUBRIQUE: if (isset($tabOptions['TYPECHAINE2'])) { $pclRubrique =& $this->Fae15aba3($pclOp2->m_sNomFichier,$pclOp2->m_sNom); $tabOptions['TYPECHAINE2'] = !$pclRubrique->F7b5edca9(); } break; case FMK_SQL_CLASSE_PARAM: case FMK_SQL_CLASSE_ITEM: if (isset($tabOptions['TYPECHAINE2'])) { $tabOptions['TYPECHAINE2'] = !is_numeric($sVal2) ; } $sVal2 = $this->F90fb578a($sVal2); break; } return false; case FMK_SQL_CLASSE_REQUETE: case FMK_SQL_CLASSE_FICHIER: return false; break; case FMK_SQL_CLASSE_RUBRIQUE: $pclRubrique =& $this->Fae15aba3($pclOp1->m_sNomFichier,$pclOp1->m_sNom); if (isset($tabOptions['TYPECHAINE1'])) { $tabOptions['TYPECHAINE1'] = !$pclRubrique->F7b5edca9(); } switch ($pclOp2->m_nClasse) { case FMK_SQL_CLASSE_EXPRESSION: return false; case FMK_SQL_CLASSE_REQUETE: case FMK_SQL_CLASSE_FICHIER: return false; case FMK_SQL_CLASSE_RUBRIQUE: if (isset($tabOptions['TYPECHAINE2'])) { $pclRubrique =& $this->Fae15aba3($pclOp2->m_sNomFichier,$pclOp2->m_sNom); $tabOptions['TYPECHAINE2'] = !$pclRubrique->F7b5edca9(); } return true; case FMK_SQL_CLASSE_PARAM: case FMK_SQL_CLASSE_ITEM: if (isset($tabOptions['TYPECHAINE2'])) { $tabOptions['TYPECHAINE2'] = !is_numeric($sVal2) ; } $sVal2=$this->Fdc8698c9($pclRubrique,$sVal2); return true; case FMK_SQL_CLASSE_INVALIDE: case FMK_SQL_CLASSE_KW: default: } break; case FMK_SQL_CLASSE_PARAM: case FMK_SQL_CLASSE_ITEM: if (isset($tabOptions['TYPECHAINE1'])) { $tabOptions['TYPECHAINE1'] = !is_numeric($sVal1); } switch ($pclOp2->m_nClasse) { case FMK_SQL_CLASSE_REQUETE: case FMK_SQL_CLASSE_FICHIER: return false; case FMK_SQL_CLASSE_RUBRIQUE: $pclRubrique =& $this->Fae15aba3($pclOp2->m_sNomFichier,$pclOp2->m_sNom); if (isset($tabOptions['TYPECHAINE2'])) { $tabOptions['TYPECHAINE2'] = !$pclRubrique->F7b5edca9(); } $sVal1=$this->Fdc8698c9($pclRubrique,$sVal1); return true; case FMK_SQL_CLASSE_PARAM: case FMK_SQL_CLASSE_EXPRESSION: case FMK_SQL_CLASSE_ITEM: if (isset($tabOptions['TYPECHAINE2'])) { $tabOptions['TYPECHAINE2'] = !is_numeric($sVal2); } $sVal1 = $this->F90fb578a($sVal1); $sVal2 = $this->F90fb578a($sVal2); return true; break; case FMK_SQL_CLASSE_INVALIDE: case FMK_SQL_CLASSE_KW: default: } break; case FMK_SQL_CLASSE_INVALIDE: case FMK_SQL_CLASSE_KW: default: } return false; } function F4500afc6(&$pclOpExpression) { $sOperateur = null; $sCodeOperation = ''; $nOperandes = count($pclOpExpression->m_tabItems,COUNT_NORMAL); switch($pclOpExpression->m_nOpExpression) { case eSTRING_DECODE: case eWL_FUNCTION: return null; break; case eDATE_SYSDATE: return 'SYSDATE()'; case eMATH_PI: return 'PI()'; case eREQ_SOUSREQ: return null; break; case eCOMP_BETWEEN: { $sCodeOperandeGauche = Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this,true); if (!isset($sCodeOperandeGauche)) return null; $sCodeOperande1 = Ffaa5b6f5($pclOpExpression->m_tabItems[1],$this,true); $sCodeOperation = $sCodeOperandeGauche.' '; $sCodeOperande2 = Ffaa5b6f5($pclOpExpression->m_tabItems[2],$this,true); if (isset($sCodeOperande1)&&isset($sCodeOperande2)) { $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperandeGauche, $pclOpExpression->m_tabItems[1],$sCodeOperande1); $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperandeGauche, $pclOpExpression->m_tabItems[2],$sCodeOperande2); $sCodeOperation .= 'BETWEEN ' . $sCodeOperande1 . ' AND ' . $sCodeOperande2; } elseif (isset($sCodeOperande1)) { $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperandeGauche, $pclOpExpression->m_tabItems[1],$sCodeOperande1); $sCodeOperation .= '> ' . $sCodeOperande1; } elseif (isset($sCodeOperande2)) { $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperandeGauche, $pclOpExpression->m_tabItems[2],$sCodeOperande2); $sCodeOperation .= '< ' . $sCodeOperande2; } else { return null; } if (isset($pclOpExpression->m_tabOptionsExpression['bOPBETWEEN_NotBetween']) && $pclOpExpression->m_tabOptionsExpression['bOPBETWEEN_NotBetween']) { $sCodeOperation = 'NOT ('.$sCodeOperation.')'; } return $sCodeOperation; } break; case eCOMP_IN: { $sCodeOperandeGauche = Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this); if (!isset($sCodeOperandeGauche)) return null; $bOpNotIn = (isset($pclOpExpression->m_tabOptionsExpression['bOpNotIn']) && $pclOpExpression->m_tabOptionsExpression['bOpNotIn']===true); $sCodeOperation = $sCodeOperandeGauche; if ($bOpNotIn) $sCodeOperation .= ' NOT'; $sCodeOperation .= ' IN ('; $nNbOperandes = $pclOpExpression->m_tabOptionsExpression['nOPIN_NbExpression']; if (!isset($nNbOperandes)) { $nNbOperandes = count($pclOpExpression->m_tabItems,COUNT_NORMAL) - 1; } $bAuMoinsUneOperandeGeneree = false; if ($nNbOperandes==1) { $bAuMoinsUneOperandeGeneree = true; $sListeValeurs = Ffaa5b6f5($pclOpExpression->m_tabItems[1],$this,true); if (!isset($sListeValeurs)) return null; $tabOperandes = utf8_explode("'",$sListeValeurs); $nNbSeparationQuote = count($tabOperandes,COUNT_NORMAL); $tabOperandesSansSeparateurs = array(); if ($nNbSeparationQuote>1) { for($i=1; $i<$nNbSeparationQuote; $i+=2) { $tabOperandesSansSeparateurs[] = $tabOperandes[$i]; } } else { $tabOperandesSansSeparateurs = utf8_explode(RC,utf8_str_replace(utf8_chr(0),RC,utf8_str_replace(';',RC,utf8_str_replace(TAB,RC,$sListeValeurs)))); } $nNbOperandes = count($tabOperandesSansSeparateurs,COUNT_NORMAL); for ($nOperandeI=0; $nOperandeI<$nNbOperandes; $nOperandeI++) { if ($nOperandeI>0) $sCodeOperation.= ','; $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperandeGaucheUNUSED, $pclOpExpression->m_tabItems[1],$tabOperandesSansSeparateurs[$nOperandeI]); $sCodeOperation .= $tabOperandesSansSeparateurs[$nOperandeI]; } } else { for ($nOperandeI=1; $nOperandeI<=$nNbOperandes; $nOperandeI++) { $pclOperandeI =& $pclOpExpression->m_tabItems[$nOperandeI]; $sCodeOperandeI = Ffaa5b6f5($pclOperandeI,$this,true); if (isset($sCodeOperandeI)) { if ($nOperandeI>1) $sCodeOperation.= ','; $bAuMoinsUneOperandeGeneree = true; $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperandeGaucheUNUSED, $pclOpExpression->m_tabItems[$nOperandeI],$sCodeOperandeI); $sCodeOperation .= $sCodeOperandeI; } } } $sCodeOperation .= ')'; return ($bAuMoinsUneOperandeGeneree) ? $sCodeOperation : null; } break; case eLIKE: { $sCodeOperande1=Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this); $sCodeOperande2=Ffaa5b6f5($pclOpExpression->m_tabItems[1],$this,true); if (!isset($sCodeOperande1)||!isset($sCodeOperande2)) return null; $tabOptions = $pclOpExpression->m_tabOptionsExpression; $bAvecJokers=false; if ( ($pclOpExpression->m_tabItems[1]->m_nClasse === FMK_SQL_CLASSE_PARAM) || ($pclOpExpression->m_tabItems[1]->m_nClasse === FMK_SQL_CLASSE_ITEM) ) { $bCommencePar = ($bDernierCaractereJoker=(!empty($sCodeOperande2) && ($sCodeOperande2[strlen($sCodeOperande2)-1] === '%'))) ? true : ($tabOptions['bOPLIKE_CommencePar'] ==1); $bFiniPar = ($bPremierCaractereJoker=(!empty($sCodeOperande2) && ($sCodeOperande2[0] === '%'))) ? true : ($tabOptions['bOPLIKE_FiniPar'] ==1); $bContient = ($bCommencePar&&$bFiniPar) ? true : ($tabOptions['bOPLIKE_Contient'] ==1); if ($bContient||$bCommencePar) { if (false==$bDernierCaractereJoker)$sCodeOperande2 = $sCodeOperande2 . '%'; $bAvecJokers=true; } if ($bContient||$bFiniPar) { if (false==$bPremierCaractereJoker)$sCodeOperande2 = '%' . $sCodeOperande2; $bAvecJokers=true; } } if ($bAvecJokers) { $sCodeOperande2 = $this->F90fb578a($sCodeOperande2); } else { $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperande1, $pclOpExpression->m_tabItems[1],$sCodeOperande2); } if (($bAvecJokers===false) && $tabOptions['bOPLIKE_CaseSensitive']==0) { if ($tabOptions['bOPLIKE_NotLike']==1) { $sCodeLike = $sCodeOperande1 . ' <> ' . $sCodeOperande2; } else { $sCodeLike = $sCodeOperande1 . ' = ' . $sCodeOperande2; } } else { if ($tabOptions['bOPLIKE_NotLike']==1) { $sCodeLike = $sCodeOperande1 . ' NOT LIKE ' . $sCodeOperande2; } else { $sCodeLike = $sCodeOperande1 . ' LIKE ' . $sCodeOperande2; } } return $sCodeLike; } break; case eCASE1: case eCASE2: { $sCodeSWITCH = 'CASE'; $nIndiceCase = 0; $bAuMoinsUneOperandeGeneree = false; $sCodeSelon = ''; if ($pclOpExpression->m_nOpExpression === eCASE1) { $sCodeSelon = Ffaa5b6f5($pclOpExpression->m_tabItems[$nIndiceCase],$this); if (!isset($sCodeSelon)) return null; $sCodeSWITCH .= $sCodeSelon; ++$nIndiceCase; } while (isset($pclOpExpression->m_tabItems[$nIndiceCase])&&isset($pclOpExpression->m_tabItems[$nIndiceCase+1])) { $sCodeOperande1 = Ffaa5b6f5($pclOpExpression->m_tabItems[$nIndiceCase],$this); $sCodeOperande2 = Ffaa5b6f5($pclOpExpression->m_tabItems[$nIndiceCase+1],$this); if (isset($sCodeOperande1)&&isset($sCodeOperande2)) { $bAuMoinsUneOperandeGeneree = true; $sCodeSWITCH .= ' WHEN ' . $sCodeOperande1 .' THEN '. $sCodeOperande2; } $nIndiceCase+=2; } if (isset($pclOpExpression->m_tabItems[$nIndiceCase])) { $sCodeOperandeElse = Ffaa5b6f5($pclOpExpression->m_tabItems[$nIndiceCase],$this,true); if (isset($sCodeOperandeElse)) { if (!$bAuMoinsUneOperandeGeneree) { return $sCodeOperandeElse; } else { $sCodeOperandeElse2=''; $this->F3f69ad5f($pclOpExpression->m_tabItems[$nIndiceCase],$sCodeOperandeElse, $pclOpExpression->m_tabItems[$nIndiceCase],$sCodeOperandeElse2); $sCodeSWITCH .= ' ELSE ' . $sCodeOperandeElse; } } } return $bAuMoinsUneOperandeGeneree ? $sCodeSWITCH.' END' : null; } break; case eMATH_CEILING: case eMATH_CEIL: $pclOperandeI =& $pclOpExpression->m_tabItems[0]; $sCodeOperande = Ffaa5b6f5($pclOperandeI,$this); if (!isset($sCodeOperande)) return null; return 'CEIL('.$sCodeOperande.')'; break; case eMATH_CBRT: $pclOperandeI =& $pclOpExpression->m_tabItems[0]; $sCodeOperandeRadian = Ffaa5b6f5($pclOperandeI,$this); if (!isset($sCodeOperandeRadian)) return null; return 'POW('.$sCodeOperandeRadian.',1/3)'; break; case eMATH_DEGREES: $pclOperandeI =& $pclOpExpression->m_tabItems[0]; $sCodeOperandeRadian = Ffaa5b6f5($pclOperandeI,$this); if (!isset($sCodeOperandeRadian)) return null; return '( ('.$sCodeOperandeRadian.'*180)/PI() )'; break; case eMATH_RADIANS: $pclOperandeI =& $pclOpExpression->m_tabItems[0]; $sCodeOperandeDegrees = Ffaa5b6f5($pclOperandeI,$this); if (!isset($sCodeOperandeDegrees)) return null; return '( ('.$sCodeOperandeDegrees.'*PI())/180 )'; break; case eMATH_RANDOM: FMK_Charge('WL/STD/Std.php',false); return Hasard(); break; case eMATH_DIV: case eFONC_COUNT: default: $sOperateur = (!empty($pclOpExpression->m_sOpExpression)) ? $pclOpExpression->m_sOpExpression : null; } $bGenerationOK = false; if (isset($sOperateur) && ($nOperandes==2) && ($pclOpExpression->m_nOpExpression>=eCOMP_EGAL) && ($pclOpExpression->m_nOpExpression<=eCOMP_EGALSOUPLE) ) { $sCodeOperande1=Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this,true); $sCodeOperande2=Ffaa5b6f5($pclOpExpression->m_tabItems[1],$this,true); if (!isset($sCodeOperande1)||!isset($sCodeOperande2)) return null; $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperande1, $pclOpExpression->m_tabItems[1],$sCodeOperande2); $sCodeOperation = $sCodeOperande1 .' '.$sOperateur.' '.$sCodeOperande2.' '; $bGenerationOK = true; } elseif (isset($sOperateur) && ($nOperandes==2) && ($pclOpExpression->m_nOpExpression==eCALC_PLUS)) { $sCodeOperande1=Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this,true); $sCodeOperande2=Ffaa5b6f5($pclOpExpression->m_tabItems[1],$this,true); if (!isset($sCodeOperande1)||!isset($sCodeOperande2)) return null; $nType1 = $nType2 = true; $tabInfo = array('TYPECHAINE1'=>&$nType1,'TYPECHAINE2'=>&$nType2); $this->F3f69ad5f($pclOpExpression->m_tabItems[0],$sCodeOperande1, $pclOpExpression->m_tabItems[1],$sCodeOperande2,$tabInfo); if ( ($tabInfo['TYPECHAINE1']) || ($tabInfo['TYPECHAINE2']) ) { $sCodeOperation = 'CONCAT(' . $sCodeOperande1. ',' .$sCodeOperande2 . ')'; } else { $sCodeOperation = $sCodeOperande1. ' + ' .$sCodeOperande2 ; } $bGenerationOK = true; } if (!$bGenerationOK) { $sCodeOperation = $pclOpExpression->m_sExpressionComplete; $bAuMoinsUneOperandeGeneree = false; $nOffset = 0; for($iOp = 0; $iOp < $nOperandes; $iOp++) { $pclOperandeI =& $pclOpExpression->m_tabItems[$iOp]; $sCodeOperationCourante = Ffaa5b6f5($pclOperandeI,$this,$pclOpExpression->m_nOpExpression === eSTORED_FUNCTION); switch ($pclOpExpression->m_nOpExpression) { case eLOGI_AND: case eLOGI_OR: { if (!isset($sCodeOperationCourante)||empty($sCodeOperationCourante)) { if (($iOp==1) && (!$bAuMoinsUneOperandeGeneree)) { $sCodeOperation = null; } continue; } if ($bAuMoinsUneOperandeGeneree) { $sCodeOperation .= $sOperateur . ' ( ' . $sCodeOperationCourante .' ) '; } else { $sCodeOperation = '(' . $sCodeOperationCourante . ')'; $bAuMoinsUneOperandeGeneree = true; } } break; case eSTORED_FUNCTION: { if ('\'' === utf8_substr($sCodeOperation,$pclOperandeI->m_nPosDebut-$pclOpExpression->m_nPosDebut+$nOffset,1)) { $sCodeOperationCourante = $this->F90fb578a((string)$sCodeOperationCourante); } } default: if ((!empty($pclOperandeI->m_nPosDebut)&&!empty($pclOperandeI->m_nPosFin))) { $nLongueurAvantRemplacement = utf8_strlen($sCodeOperation); $sCodeOperation = utf8_substr_replace($sCodeOperation,$sCodeOperationCourante, $pclOperandeI->m_nPosDebut-$pclOpExpression->m_nPosDebut+$nOffset, $pclOperandeI->m_nPosFin-$pclOperandeI->m_nPosDebut+1); $nOffset = $nOffset + utf8_strlen($sCodeOperation) - $nLongueurAvantRemplacement; } else { Fa79fbf41(Fd7624002('Impossible de procéder au remplacement dans la chaîne SQL')); } } } } return $sCodeOperation; } function F17b34f65($sCodeSQL) { $sCodeSQLSansQuote = ''; $nLongueur = utf8_strlen($sCodeSQL); $bOuvert = false; $nIndex = 0; while($nIndex < $nLongueur) { $cCaractereCourant = utf8_substr($sCodeSQL, $nIndex, 1); if($cCaractereCourant == "'" && utf8_substr($sCodeSQL, $nIndex-1, 1) != '\'') { if($bOuvert) { $sCodeSQLSansQuote .= "WD_EXPRESSION"; $bOuvert = false; } else { $bOuvert = true; } } elseif (!$bOuvert) { $sCodeSQLSansQuote .= $cCaractereCourant; } ++$nIndex; } return utf8_str_replace("\n"," ",$sCodeSQLSansQuote); } function Fd398930a(&$pclRequete,$sNomConnexion, $TabParam) { $nNbParamADefinir = 0; $nNbParams = count($pclRequete->TabParamRequete); if (is_array($pclRequete->TabParamRequete) && ($nNbParams>0)) { $TabParamRequete = array_values($pclRequete->TabParamRequete); for ($i=$nNbParams; $i>0; $i--) { if (!isset($TabParamRequete[ $i-1 ])) { $nNbParamADefinir = $i; break; } } } if (count($TabParam) < $nNbParamADefinir) { global $sLastFunction; Erreur('ErreurHF_1_Param',"ErreurParametreRequete2", $pclRequete->sNom, $sLastFunction); return false; } $pclRequete->sCodeSQL = $pclRequete->sCodeSQLInitial; if(isset($pclRequete->TabParamRequete) && count($pclRequete->TabParamRequete) > 0) { $nIndex = 0; foreach ($pclRequete->TabParamRequete as $valeur) { if(isset($TabParam) && isset($TabParam[$nIndex])) { $valeurParam = $TabParam[$nIndex]; } else { if(!isset($valeur)) { continue; } $valeurParam = $valeur; } $sNomParam = $pclRequete->TabNomParamRequete[$nIndex]; $szNomTagArg= '{'.$sNomParam.'#'.$nIndex.'}'; $szNomTagArgLike = '%{'.$sNomParam.'#'.$nIndex.'}%'; $bLikePresent = utf8_strpos( $pclRequete->sCodeSQL, $szNomTagArgLike) > 0; $szValElement = $valeurParam . ''; if ($bLikePresent) { $szValElement = '\'%'. $valeurParam . '%\''; $szNomTagArg = $szNomTagArgLike; } else { $szNomTagArgLike = '%{'.$sNomParam.'#'.$nIndex.'}'; $bLikePresent = utf8_strpos( $pclRequete->sCodeSQL, $szNomTagArgLike) > 0; if ($bLikePresent) { $szValElement = '\'%'. $valeurParam . '\''; $szNomTagArg = $szNomTagArgLike; } else { $szNomTagArgLike = '{'.$sNomParam.'#'.$nIndex.'}%'; $bLikePresent = utf8_strpos( $pclRequete->sCodeSQL, $szNomTagArgLike) > 0; if ($bLikePresent) { $szValElement = '\''. $valeurParam . '%\''; $szNomTagArg = $szNomTagArgLike; } else if ( is_string($valeurParam) ) { $szValElement = '\''. $valeurParam . '\''; } } } $pclRequete->sCodeSQL = utf8_str_replace( $szNomTagArg, $szValElement, $pclRequete->sCodeSQL ); ++$nIndex; } } $pclRequete->sCodeSQLSansQuote = $this->F17b34f65($pclRequete->sCodeSQL); $pclRequete->nTypeRequete = $pclRequete->F9d60968a($pclRequete->sCodeSQL); if(!empty($sNomConnexion)) { $pclRequete->sNomConnexion = $sNomConnexion; } $sClause = "FROM"; switch ($pclRequete->nTypeRequete) { case REQUETE_SELECT : case REQUETE_SHOW : case REQUETE_DESCRIBE : return $pclRequete->F3bd60944($pclRequete->sCodeSQLSansQuote); case REQUETE_DELETE : $sClause = "FROM"; break; case REQUETE_INSERT : $sClause = "INTO"; break; case REQUETE_UPDATE : $sClause = "UPDATE"; break; case REQUETE_GRANT : default: } if(empty($sNomConnexion)) { $sNomPremierFichier = ''; $TabSeparateur = array(' ',',','(','['); $nIndexClause = utf8_strpos(utf8_strtolower($pclRequete->sCodeSQLSansQuote), utf8_strtolower($sClause)); $nLongueur = utf8_strlen($pclRequete->sCodeSQLSansQuote); $nIndex = 0; while($nIndex < $nLongueur) { $cCaractereCourant = utf8_substr($pclRequete->sCodeSQL, $nIndex + $nIndexClause + utf8_strlen($sClause), 1); if(in_array($cCaractereCourant, $TabSeparateur)) { if(!empty($sNomPremierFichier)) { break; } } else { $sNomPremierFichier .= $cCaractereCourant; } ++$nIndex; } $Fichier = &F80229053($sNomPremierFichier); $sNomConnexion = $Fichier->sNomConnexion; } $pclRequete->sNomConnexion = $sNomConnexion; $this->m_resConnexionId = $pclRequete->F475159c6(); $nResultQuery = $pclRequete->F52651677($pclRequete->sCodeSQL, $this->m_resConnexionId); if(!$nResultQuery) { $pclRequete->Fba409abd($this->m_resConnexionId); return false; } $pclRequete->bHTrouve = false; $pclRequete->bHEnDehors = true; return true; } function F3bd60944(&$pclRequete,$sCodeSQL,$bSignalerErreur=true) { $gclContextHF =& FMK_ContextHF(); if ($pclRequete->nMode != H_REQUETE_SANS_CORRECTION) { $pclRequete->F36b4d334($sCodeSQL); $pclRequete->F0dd17814($sCodeSQL); $pclRequete->Fa18b40ba($sCodeSQL); } if(empty($pclRequete->sNomConnexion)) { reset($pclRequete->TabFichierRequete); $Fichier = &$pclRequete->TabFichierRequete[key($pclRequete->TabFichierRequete)]; $pclRequete->sNomConnexion = $Fichier->sNomConnexion; } $nIdConnexion = $this->m_resConnexionId = $pclRequete->F475159c6(); $pclRequete->m_pclDernierInitRequete = $this->query($pclRequete->sCodeSQL,null,$pclRequete); if($pclRequete->m_pclDernierInitRequete===false) { if ($bSignalerErreur) $this->Fba409abd($nIdConnexion, $pclRequete->sNom); return false; } $pclRequete->bHTrouve = false; $pclRequete->bHEnDehors = true; if(isset($gclContextHF->TabRequetes[utf8_strtolower($pclRequete->sNom)])) { $pclRequete->Fe2cc55e7(); } $pclRequete->bInit = true; return true; } function Fbe71eca8(&$pclFichier,$tabInfos=null) { } function F7f79f122(&$pclFichier, $nFlags, $sValeurRecherche= "", $RubriqueParcours = null, $bFiltre = false) { $nIdConnexion = $pclFichier->F475159c6(); $tabOptionsSQL=null; if(!empty($sValeurRecherche) && isset($RubriqueParcours)) { $tabOptionsSQL['WHERE'] = " WHERE ".$pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$sValeurRecherche), TYPE_COMP_COMMENCE_PAR, true); } else if($bFiltre && $pclFichier->bFiltreActif && !empty($pclFichier->sFiltre)) { $tabOptionsSQL['WHERE'] = " WHERE ".$pclFichier->sFiltre; } $pclQueryStatement = $this->Fe9b48ff7($pclFichier,$tabOptionsSQL); if($pclQueryStatement===false) { $this->Fba409abd($nIdConnexion,$pclFichier->sNomLogique); return -1; } $nResult = $pclQueryStatement->F3829673d(0); if($nResult!==false) { return $nResult; } return -1; } function F7ce1a2b2(&$pclFichier, &$Rubrique, $Enreg, $nSens = 0, $sValeurRecherche= '') { $nIdConnexion = $pclFichier->F475159c6(); if(!$nIdConnexion) { return -1; } $TabRub = $pclFichier->Fa15cf330($Rubrique); if(isset($TabRub)) { $tabOptionsSQL['WHERE'] = $pclFichier->F5237a205($TabRub, !$nSens, $Enreg); if(!empty($sValeurRecherche)) { $tabOptionsSQL['WHERE'] .= " AND ".$pclFichier->F0fa6e24e($Rubrique, $this->F137bdb94($Rubrique,$sValeurRecherche), TYPE_COMP_COMMENCE_PAR, true); } if($pclFichier->bFiltreActif && $Rubrique->bRubriqueFiltre) { $tabOptionsSQL['WHERE'] .= " AND ".$pclFichier->sFiltre; } $tabOptionsSQL['ORDERBY'] = $pclFichier->Fd5be2853($TabRub, !$nSens); } $pclQueryStatement = $this->Fe9b48ff7($pclFichier,$tabOptionsSQL,$Rubrique); if($pclQueryStatement===false) { $this->Fba409abd($nIdConnexion,$pclFichier->sNomLogique); return -1; } $nResult = $pclQueryStatement->F3829673d(0); if($nResult!==false) { return $nResult + 1; } return -1; } function Fa84e48aa(&$pclFichier, &$RubriqueParcours, $bPremier = true, $nFlags = 0) { $gclContextHF =& FMK_ContextHF(); if(!isset($RubriqueParcours)) { return false; } $bSansRafraichir = (($nFlags & H_SANS_RAFRAICHIR) == H_SANS_RAFRAICHIR); $bRespecteFiltre = (($nFlags & H_RESPECTE_FILTRE) == H_RESPECTE_FILTRE); if(isset($RubriqueParcours->BufferParcours)) { $BufferParcours =& $RubriqueParcours->BufferParcours; if(!$bSansRafraichir) { $BufferParcours->raz($pclFichier->nIdModifFichier); unset($RubriqueParcours->BufferParcours); } else { if (!isset($BufferParcours->sValeurRecherche) && ($bPremier == $BufferParcours->nTypeParcours || $BufferParcours->F67278b18())) { $Enreg = null; if($bPremier == $RubriqueParcours->BufferParcours->nTypeParcours) { $Enreg = $RubriqueParcours->BufferParcours->Ff9655465($pclFichier->bHTrouve, $pclFichier->bHEnDehors); } else { $Enreg = $RubriqueParcours->BufferParcours->Fecd5a84f($pclFichier->bHTrouve, $pclFichier->bHEnDehors); } if(isset($Enreg)) { $pclFichier->F96c9cbe1($Enreg); $gclContextHF->nNumErreur = 0; return true; } else { $gclContextHF->nNumErreur = 0; return false; } } } } $tabOptionsSQL = array(); if ($pclFichier->nMode != H_REQUETE_SANS_CORRECTION) { $sFrom = $pclFichier->F41e5bf49($RubriqueParcours, $bPremier); $tabOptionsSQL['FROM'] = $sFrom; $TabRub = $pclFichier->Fa15cf330($RubriqueParcours); } if(isset($TabRub)) { if($pclFichier->bFiltreActif && (strcmp($RubriqueParcours->sNom, $pclFichier->sNomRubriqueFiltre) == 0 || $bRespecteFiltre)) { $RubriqueParcours->bRubriqueFiltre = true; $tabOptionsSQL['WHERE'] = $pclFichier->sFiltre; } else if(strcmp($RubriqueParcours->sNom, $pclFichier->sNomRubriqueFiltre) != 0 ) { $RubriqueParcours->bRubriqueFiltre = false; } $tabOptionsSQL['ORDERBY'] = $pclFichier->Fd5be2853($TabRub, $bPremier); } $tabOptionsSQL['SOURCE'] = $this->Fa66a2d9c($pclFichier) ? 4 : 2; if ($this->Fa66a2d9c($pclFichier)) { $pclAN =& $pclFichier->Fb56717be(); if (isset($pclAN) && ($pclAN->F22067d84()==TYPE_BASE_MARIA||$pclAN->F22067d84()==TYPE_BASE_MYSQL)) { $nPosOrder = strpos($tabOptionsSQL['FROM'],' ORDER BY '); $nPosFinReq = strlen($tabOptionsSQL['FROM'])-strlen(''.strrchr($tabOptionsSQL['FROM'],')')); if ($nPosFinReq>$nPosOrder && strpos($tabOptionsSQL['FROM'],' LIMIT ',$nPosOrder)===false) { $tabOptionsSQL['FROM'] = substr_replace($tabOptionsSQL['FROM'],' LIMIT 18446744073709551615',$nPosFinReq,0); } } } $bOptimSansRafraichir = false; if ($pclFichier->nMode != H_REQUETE_SANS_CORRECTION) { $tabOptionsSQL['LIMIT'] = $pclFichier->nTailleFetch; $pclQueryStatement = $pclFichier->Fc513efef($pclFichier->F06c56363(),$tabOptionsSQL); } else { if($bSansRafraichir && $bPremier && Feee3b2d5($pclFichier) && !isset($RubriqueParcours->BufferParcours) && (isset($pclFichier->m_pclDernierInitRequete) && ($pclFichier->m_pclDernierInitRequete->Fd061cc94()))) { $pclQueryStatement = $pclFichier->m_pclDernierInitRequete; $bOptimSansRafraichir = true; } else { $pclQueryStatement = $pclFichier->Fc513efef($pclFichier->sCodeSQL,$tabOptionsSQL); } } if($pclQueryStatement === false) { if ($bOptimSansRafraichir) { $pclQueryStatement = $pclFichier->Fc513efef($pclFichier->sCodeSQL,$tabOptionsSQL); } if($pclQueryStatement === false) return false; } $Buffer = null; XVERIFY(F62ece511($Buffer,$this->F22067d84(),$RubriqueParcours, $pclFichier->nIdModifFichier)); $RubriqueParcours->BufferParcours = &$Buffer; $Buffer->nTypeParcours = $bPremier; if($pclQueryStatement->F2262f69c() < $pclFichier->nTailleFetch) { $Buffer->bFull = true; } $Buffer->Ff394115b($pclQueryStatement); $Enreg = $Buffer->Ff9655465($pclFichier->bHTrouve, $pclFichier->bHEnDehors); if(!isset($Enreg)) { $gclContextHF->nNumErreur = 0; return false; } $pclFichier->F96c9cbe1($Enreg); $gclContextHF->nNumErreur = 0; return true; } function Fec3a1557(&$pclFichier, &$RubriqueParcours, $bSuivant = true, $nPas = 1) { if ($nPas === 0) return true; $gclContextHF =& FMK_ContextHF(); $bSensAsc = $bSuivant; if(!isset($RubriqueParcours)) { return false; } $Buffer = &$RubriqueParcours->BufferParcours; if(!isset($Buffer)) { global $sLastFunction; Erreur('ErreurAucunParcours',$sLastFunction, $RubriqueParcours->sNom, $pclFichier->sNomLogique); } $nTypeParcours = $Buffer->nTypeParcours; if($nTypeParcours == PARCOURS_DERNIER_PRECEDENT) { $bSensAsc = !$bSuivant; } if($Buffer->nIdModif < $pclFichier->nIdModifFichier) { $Buffer->raz($pclFichier->nIdModifFichier); $Buffer->nPosition = -1; $nTypeParcours = $bSuivant; $Buffer->nTypeParcours = $nTypeParcours; if($pclFichier->bAffecteParcours) { if(isset($pclFichier->EnregModif)) { $Buffer->DernierEnregLu = $pclFichier->EnregModif; } else { $Buffer->DernierEnregLu = $pclFichier->EnregCourant; } } } else { if($nPas == 1) { if($bSensAsc) { $Enreg = $Buffer->F8aa07233($pclFichier->bHTrouve, $pclFichier->bHEnDehors); } else { $Enreg = $Buffer->getPrevious($pclFichier->bHTrouve, $pclFichier->bHEnDehors); } } else { if($bSensAsc) { $Enreg = $Buffer->F9471b0a3($nPas, $pclFichier->bHEnDehors); } else { $Enreg = $Buffer->F7fc9b3f0($nPas, $pclFichier->bHEnDehors); } } if(isset($Enreg)) { $pclFichier->F96c9cbe1($Enreg); return true; } if($Buffer->bLimiteParcours && $Buffer->F67278b18()) { return false; } if(($bSensAsc && $Buffer->F67278b18()) || (!$bSensAsc && $Buffer->getPosition() == 0) || ($Buffer->F371a91e5() && !$Buffer->bInitBuffer)) { if(!isset($Buffer->sValeurRecherche) && isset($Buffer->Cache) && !((!$bSensAsc && $Buffer->getPosition() == 0) && !$Buffer->bFromScratch)) { $gclContextHF->nNumErreur = 0; return false; } else { $Buffer->raz($pclFichier->nIdModifFichier); $Buffer->nPosition = -1; $nTypeParcours = $bSuivant; $Buffer->nTypeParcours = $nTypeParcours; } } else if($nPas > 1) { $Buffer->raz($pclFichier->nIdModifFichier); $Buffer->nPosition = -1; $nTypeParcours = $bSuivant; $Buffer->nTypeParcours = $nTypeParcours; } } $Buffer->bInitBuffer = false; $tabOptionsSQL['FROM'] = $pclFichier->F41e5bf49($RubriqueParcours, $nTypeParcours); $TabRub = $pclFichier->Fa15cf330($RubriqueParcours); if(isset($TabRub) && (isset($TabRub[1]) || !empty($TabRub[0]->sNom))) { $DernierEnregLu = null; if(!isset($Buffer->DernierEnregLu)) { $DernierEnregLu = $pclFichier->EnregCourant; } else { $DernierEnregLu = $Buffer->DernierEnregLu; } $tabOptionsSQL['WHERE'] = $pclFichier->F5237a205($TabRub, $nTypeParcours, $DernierEnregLu); if($pclFichier->bFiltreActif && $RubriqueParcours->bRubriqueFiltre) { $tabOptionsSQL['WHERE'] .= " AND ".$pclFichier->sFiltre; } $tabOptionsSQL['ORDERBY'] = $pclFichier->Fd5be2853($TabRub, $nTypeParcours); } else { unset($TabRub); } $nBonus = 0; if($nPas > 1) { $Buffer->bFromScratch = false; if($nPas <= 10) { $nBonus = $nPas-1; } else { $nBonus = 10; } } else { $nPas = 1; } $tabOptionsSQL['LIMIT'] = ($pclFichier->nTailleFetch + ($nPas - 1)); $tabOptionsSQL['LIMITFROM'] = ($nPas- 1 - $nBonus) + (isset($TabRub) ? 0 : $Buffer->nPosition+$nPas); $pclQueryStatement = $pclFichier->Fc513efef($pclFichier->F06c56363(),$tabOptionsSQL); if($pclQueryStatement === false) { return false; } $nNbEnregLu = $pclQueryStatement->F2262f69c(); if($nNbEnregLu < $pclFichier->nTailleFetch) { $RubriqueParcours->BufferParcours->bFull = true; if($nNbEnregLu <= $nBonus) { $pclFichier->bHEnDehors = true; return false; } } $RubriqueParcours->BufferParcours->Ff394115b($pclQueryStatement); if($nBonus > 0) { $Buffer->nPosition = $nBonus-1; } $Enreg = $Buffer->F8aa07233($pclFichier->bHTrouve, $pclFichier->bHEnDehors); if($Enreg == null) { $gclContextHF->nNumErreur = 0; return false; } $pclFichier->F96c9cbe1($Enreg); $gclContextHF->nNumErreur = 0; return true; } function F218e30b2(&$pclFichier, &$RubriqueParcours, $sValeur, $bPremier = true, $nFlags = 0) { $gclContextHF =& FMK_ContextHF(); if(!isset($RubriqueParcours)) { return false; } if (is_array($sValeur)) { $sValeur = $pclFichier->Fc7d0d5f9($RubriqueParcours,$sValeur); } $bSansRafraichir = (($nFlags & H_SANS_RAFRAICHIR) == H_SANS_RAFRAICHIR); $bIdentique = !(($nFlags & H_GENERIQUE) == H_GENERIQUE); $bLimiteParcours = (($nFlags & H_LIMITE_PARCOURS) == H_LIMITE_PARCOURS); $bRespecteFiltre = (($nFlags & H_RESPECTE_FILTRE) == H_RESPECTE_FILTRE); if(isset($RubriqueParcours->BufferParcours)) { $BufferParcours = &$RubriqueParcours->BufferParcours; if(!$bSansRafraichir) { $BufferParcours->raz($pclFichier->nIdModifFichier); unset($RubriqueParcours->BufferParcours); } else { if (utf8_strcasecmp($BufferParcours->sValeurRecherche,$sValeur) == 0 && $BufferParcours->bMatch && $BufferParcours->bIdentique == $bIdentique && ($bPremier == $BufferParcours->nTypeParcours || $BufferParcours->F67278b18())) { $Enreg = null; if($bPremier == $RubriqueParcours->BufferParcours->nTypeParcours) { $Enreg = $RubriqueParcours->BufferParcours->Ff9655465($pclFichier->bHTrouve, $pclFichier->bHEnDehors); } else { $Enreg = $RubriqueParcours->BufferParcours->Fecd5a84f($pclFichier->bHTrouve, $pclFichier->bHEnDehors); } if(isset($Enreg)) { $pclFichier->F96c9cbe1($Enreg); $gclContextHF->nNumErreur = 0; return true; } else { $gclContextHF->nNumErreur = 0; return false; } } } } $tabOptionsSQL = array('FROM' => $pclFichier->F41e5bf49($RubriqueParcours, $bPremier)); $tabOptionsSQL['WHERE'] = " WHERE ("; if($RubriqueParcours->Fbe67fb2c()) { if(utf8_strpos($sValeur, ID_CLE_COMP) === 0) { $FirstComp = null; if($bIdentique) { $tabOptionsSQL['WHERE'] .= "(".$pclFichier->F25514b5d($sValeur, TYPE_COMP_EGAL, $bPremier, true, $FirstComp).")"; } else { $tabOptionsSQL['WHERE'] .= "(".$pclFichier->F25514b5d($sValeur, TYPE_COMP_COMMENCE_PAR, $bPremier, true, $FirstComp).")"; } if(isset($FirstComp)) { $Rubrique = &$pclFichier->TabRubriques[utf8_strtolower($FirstComp[0])]; $tabOptionsSQL['WHERE'] .= " OR ".$pclFichier->F0fa6e24e($Rubrique, $this->F137bdb94($Rubrique,$FirstComp[1]), TYPE_COMP_SUP, $bPremier); } } else { global $sLastFunction; Erreur('ErreurHF_1_Param','ERR_HF_PARCOURS_CLE_COMPOSEE_VALEUR_SIMPLE',$pclFichier->sNom.'.'.$RubriqueParcours->sNom,$sLastFunction); } } else { if($bIdentique) { $tabOptionsSQL['WHERE'] .= $pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$sValeur), TYPE_COMP_EGAL, $bPremier); } else { $tabOptionsSQL['WHERE'] .= $pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$sValeur), TYPE_COMP_COMMENCE_PAR, $bPremier); } $tabOptionsSQL['WHERE'] .= " OR ".$pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$sValeur), TYPE_COMP_SUP, $bPremier); } $tabOptionsSQL['WHERE'] .= ")"; if($pclFichier->bFiltreActif && (strcmp($RubriqueParcours->sNom, $pclFichier->sNomRubriqueFiltre) == 0 || $bRespecteFiltre)) { $RubriqueParcours->bRubriqueFiltre = true; $tabOptionsSQL['WHERE'] .= " AND ".$pclFichier->sFiltre; } else if(strcmp($RubriqueParcours->sNom, $pclFichier->sNomRubriqueFiltre) != 0 ) { $RubriqueParcours->bRubriqueFiltre = false; } $TabRub = $pclFichier->Fa15cf330($RubriqueParcours); if(isset($TabRub)) { $tabOptionsSQL['ORDERBY'] = $pclFichier->Fd5be2853($TabRub, $bPremier); } $tabOptionsSQL['LIMIT'] = $pclFichier->nTailleFetch; $Buffer = null; XVERIFY(F62ece511($Buffer, $this->F22067d84() ,$RubriqueParcours, $pclFichier->nIdModifFichier, $sValeur, $bIdentique, $bLimiteParcours)); $RubriqueParcours->BufferParcours = &$Buffer; $Buffer->nTypeParcours = $bPremier; $Buffer->sValeurRecherche = $sValeur; $pclQueryStatement = $pclFichier->Fc513efef($pclFichier->F06c56363().' FROM ' , $tabOptionsSQL); if($pclQueryStatement === false) { return false; } if($pclQueryStatement->F2262f69c() < $pclFichier->nTailleFetch) { $Buffer->bFull = true; } $Buffer->Ff394115b($pclQueryStatement); $Enreg = $Buffer->Ff9655465($pclFichier->bHTrouve, $pclFichier->bHEnDehors); if($Enreg == null) { $gclContextHF->nNumErreur = 0; return false; } $pclFichier->F96c9cbe1($Enreg); $gclContextHF->nNumErreur = 0; return $pclFichier->bHTrouve; } function Ff83132b7(&$pclFichier, &$RubriqueParcours, $BorneMin = null, $BorneMax = null, $sConditionSelection= "") { $sFiltre = ""; $RubriqueFiltre = null; $bBorneSurCleComposee = false; if (isset($BorneMin) && is_array($BorneMin)) { $bBorneSurCleComposee = true; $BorneMin = $pclFichier->Fc7d0d5f9($RubriqueParcours,$BorneMin); } if (isset($BorneMax) && is_array($BorneMax)) { $bBorneSurCleComposee = true; $BorneMax = $pclFichier->Fc7d0d5f9($RubriqueParcours,$BorneMax); } if ($bBorneSurCleComposee && !$RubriqueParcours->Fbe67fb2c()) { Fe81a7f9e('ERR_NBCOMPOSANTE_RUBRIQUE_INSUFFISANTE',$RubriqueParcours->sNom,$pclFichier->sNomLogique,1); return ''; } if(isset($RubriqueParcours)) { if(!isset($BorneMax)) { $BorneMin = utf8_str_replace(H_VAL_MIN, $RubriqueParcours->Fa73f5cc0(), $BorneMin); $BorneMin = utf8_str_replace(H_VAL_MAX, $RubriqueParcours->F59cfd421(), $BorneMin); if(utf8_strpos($BorneMin, ID_CLE_COMP) === 0) { $tmp = null; $sFiltre = $pclFichier->F25514b5d($BorneMin, TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, $tmp); } else { $sFiltre = $pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$BorneMin), TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true); } } else { $BorneMin = utf8_str_replace(H_VAL_MIN, $RubriqueParcours->Fa73f5cc0(), $BorneMin); $BorneMin = utf8_str_replace(H_VAL_MAX, $RubriqueParcours->F59cfd421(), $BorneMin); if(utf8_strpos($BorneMin, ID_CLE_COMP) === 0) { $tmp=null; $sFiltre = $pclFichier->F25514b5d($BorneMin, TYPE_COMP_SUP_EGAL, PARCOURS_PREMIER_SUIVANT, true, $tmp); } else { $sFiltre = $pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$BorneMin), TYPE_COMP_SUP_EGAL, PARCOURS_PREMIER_SUIVANT); } $sFiltre .= " AND "; $BorneMax = utf8_str_replace(H_VAL_MIN, $RubriqueParcours->Fa73f5cc0(), $BorneMax); $BorneMax = utf8_str_replace(H_VAL_MAX, $RubriqueParcours->F59cfd421(), $BorneMax); if(utf8_strpos($BorneMax, ID_CLE_COMP) === 0) { $tmp=null; $sFiltre .= $pclFichier->F25514b5d($BorneMax, TYPE_COMP_INF_EGAL, PARCOURS_DERNIER_PRECEDENT, true, $tmp); } else { $sFiltre .= $pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$BorneMax), TYPE_COMP_INF_EGAL, PARCOURS_DERNIER_PRECEDENT); } $sFiltre = "(".$sFiltre.")"; } $RubriqueFiltre =& $RubriqueParcours; } if(!empty($sConditionSelection)) { $TabRubriques = array(); $sConditionSQL = $this->F0d85e54f($pclFichier,$sConditionSelection, $TabRubriques); if(empty($sConditionSQL)) { return ""; } if(!empty($sFiltre)) { $sFiltre .= " AND (".$sConditionSQL.")"; } else { $sFiltre .= "(".$sConditionSQL.")"; } $TabRubriques = array_unique($TabRubriques); foreach($TabRubriques as $sNomRubrique) { if(!array_key_exists(utf8_strtolower(F03771b65($sNomRubrique)), $pclFichier->TabNomRubriqueSansAccent)) { Erreur('ErreurHF_2_Param',"ErreurFiltreRubriqueInconnue", $pclFichier->sNomLogique, $sNomRubrique); } } $nIdConnexion = $pclFichier->F475159c6(); $tabOptionsSQL['FROM'] = $pclFichier->F41e5bf49(null); $tabOptionsSQL['WHERE'] = $sFiltre; $tabOptionsSQL['LIMIT'] = '1'; $tabOptionsSQL['SOURCE'] = $this->Fa66a2d9c($pclFichier) ? 4 : 1; $clSQLStatement = $this->query("SELECT 0 ",$tabOptionsSQL); if($clSQLStatement===false) { Erreur('ErreurHF',"ErreurFiltreInit"); } if(!isset($RubriqueFiltre)) { if(empty($TabRubriques)) { if(!isset($pclFichier->BestRub)) { $pclFichier->Fad8a73f6(); } $RubriqueFiltre =& $pclFichier->BestRub; } else { $RubriqueFiltre =& $pclFichier->F133178d5($TabRubriques[0]); foreach($TabRubriques as $sNomRubrique) { $Rubrique =& $pclFichier->F133178d5($sNomRubrique); if($Rubrique->Fa2afd757()) { $RubriqueFiltre = &$Rubrique; break; } if($Rubrique->F805b1e57() > $RubriqueFiltre->F805b1e57()) { $RubriqueFiltre =& $Rubrique; } } if($RubriqueFiltre->F5c7b90f9()) { if(!isset($pclFichier->BestRub)) { $pclFichier->Fad8a73f6(); } $RubriqueFiltre =& $pclFichier->BestRub; } } } } $sNomRubriqueFiltre = ''; if(isset($RubriqueFiltre)) { $sNomRubriqueFiltre = $RubriqueFiltre->sNom; $RubriqueFiltre->bRubriqueFiltre = true; $pclFichier->sFiltre = $sFiltre; $pclFichier->sNomRubriqueFiltre = $sNomRubriqueFiltre; $pclFichier->bFiltreActif = true; } return $sNomRubriqueFiltre; } function F018e8e04(&$pclFichier) { if(empty($pclFichier->sFiltre) || !$pclFichier->bFiltreActif) { return true; } $pclFichier->bFiltreActif = false; $pclFichier->F167474d7(); return true; } function F33a5022b(&$pclFichier, $sMotDepasse) { $nIdConnexion = $pclFichier->F475159c6($sMotDepasse); if($nIdConnexion == 0) { return false; } if (!Feee3b2d5($pclFichier)) { $bFichierTrouve = $this->F6897ec01( $pclFichier ); if(!$bFichierTrouve) { if (EnvGet('HCreationAutoActive')===true) { if (!$pclFichier->Fffae753d($sMotDepasse)) { $this->Fba409abd($nIdConnexion,$pclFichier->sNomLogique); return false; } } else { $this->Fba409abd($nIdConnexion,$pclFichier->sNomLogique); return false; } } } $pclFichier->bOuvert = true; return true; } function Fe2cc55e7(&$pclFichier) { foreach(array_keys($pclFichier->TabRubriques) as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; $Rubrique->raz(); $Rubrique->bRubriqueFiltre = false; } $pclFichier->nIdModifFichier = 0; $pclFichier->bAffecteParcours = false; $pclFichier->EnregModif = null; $pclFichier->sFiltre = ''; $pclFichier->bFiltreActif = false; $pclFichier->sNomRubriqueFiltre = ''; $pclFichier->bOuvert = false; $pclFichier->sNomAvecDelimiteurs = ''; return true; } function Fffae753d(&$pclFichier, $sMotDepasse, $bSiInexistant = false) { $pclFichier->Fe2cc55e7(); $nIdConnexion = $pclFichier->F475159c6($sMotDepasse); if(!$bSiInexistant) { $clQueryStatement = $this->Fe172c97d($pclFichier); if($clQueryStatement===false) { $this->Fba409abd($nIdConnexion,$pclFichier->sNomLogique); return false; } } if($bSiInexistant) { if($this->F6897ec01($pclFichier)) { return true; } } $nResultQuery = $this->F585065f5($pclFichier); if($nResultQuery===false) { $this->Fba409abd($nIdConnexion,$pclFichier->sNomLogique); return false; } return true; } function Fba409abd($nIdConnexion,$sNom, $sNomRequete='') { } function Fdc8698c9(&$Rubrique,$sValeur) { return $this->Fdee89755($Rubrique, $this->F137bdb94($Rubrique,$sValeur) ); } function F48bb09ec(&$pclRubrique,$Valeur) { } function Fdee89755(&$Rubrique,$sValeur) { if ($Rubrique->F81d228c1()) { if (!isset($sValeur)) return 'NULL'; return $this->F90fb578a((string)$sValeur); } elseif( ($Rubrique->nType == TYPE_BINAIRE)||($Rubrique->nType == TYPE_MEMO_BINAIRE) ) { if (!isset($sValeur)) return 'NULL'; return $this->F6e9e8df8((string)$sValeur); } return $sValeur; } function F137bdb94(&$Rubrique,$sValeur) { } function F90fb578a($pszChaine) { } function F6e9e8df8($pszChaine) { return $this->F90fb578a($pszChaine); } function F9d634e1a() { } function F218cc1a0() { } function Fa7865f89($nOptions=null) { } function F4b3597dc() { } function F5218fab1() { } function F0df7c3d7($nCodeErreur, $IdConnexion) { } function F6897ec01( &$pclFichier, $bEtVerifieDescription = null ) { } function Fe172c97d(&$pclFichier) { } function F585065f5(&$pclFichier) { } function F4c4e336d(&$Rubrique) { } function F27cfe4f5(&$pclFichier) { } function F7aeb10e1(&$pclFichier,&$Enreg, &$pnIdAuto,&$sNomRubIdAuto, $bForceIdAuto = false,$bEtExecute = true) { } function Fbac1b32d(&$pclFichier,$bForceIdAuto = false) { } function F100650c1(&$pclFichier) { } function F020cb2dc(&$pclFichier, $TabRub, $bUnique) { } function F06c56363(&$pclFichier) { if ($pclFichier->m_nIsXXX & 4) { return 'SELECT * '; } else { $sListeRubriques = ''; $sClauseEnglobante = $this->m_sClauseEnCours; $this->m_sClauseEnCours = 'SELECT'; foreach (array_keys($pclFichier->TabRubriques) as $sNomRubriqueMinuscule) { $pclRubrique =& $pclFichier->TabRubriques[$sNomRubriqueMinuscule]; if (isset($pclRubrique) && !$pclRubrique->Fbe67fb2c()) { if (!empty($sListeRubriques)) $sListeRubriques.=','; $sNomFormatSelect = $this->Ff43faec2($pclRubrique,$pclRubrique->sNomBase,'SELECT'); $sNomFormatSQL = $this->Ff43faec2($pclRubrique,$pclRubrique->sNomBase,false); $sListeRubriques.=$sNomFormatSelect.' AS '.$sNomFormatSQL; } } $this->m_sClauseEnCours = $sClauseEnglobante ; return 'SELECT '. $sListeRubriques. ' '; } } function F41e5bf49(&$pclFichier,$RubriqueParcours = null, $nSensParcours = PARCOURS_PREMIER_SUIVANT) { if ($pclFichier->m_nIsXXX & 4) { if(!isset($RubriqueParcours) || !$pclFichier->bOrderBy) { return ('('.$pclFichier->sCodeSQL.') '.$pclFichier->F9047540f()); } if(isset($RubriqueParcours) &&isset($pclFichier->RubriqueOrderBy) && (utf8_strcasecmp($RubriqueParcours->sNom, $pclFichier->RubriqueOrderBy->sNom) == 0)) { $sCodeSQL = $pclFichier->F6526986d($pclFichier->sCodeSQL, false, $nSensParcours); return ('('.$sCodeSQL.') '.$pclFichier->F9047540f()); } else { $pclFichier->bIgnoreClauseOrderBy = true; $sCodeSQL = $pclFichier->F6526986d($pclFichier->sCodeSQL, true); return ('('.$sCodeSQL.') '.$pclFichier->F9047540f()); } } else { return $this->F98e40c2c($pclFichier->sNom); } } function Fa66a2d9c(&$pclFichier) { return ($pclFichier->m_nIsXXX & 4); } function Fe8d9985a(&$pclFichier) { } function F7653b31e(&$pclFichier) { } function Fd5be2853(&$pclFichier,$TabRub, $nTypeParcours) { } function F5237a205(&$pclFichier,$TabRub, $nTypeParcours, &$DernierEnregLu) { } function F0fa6e24e(&$pclFichier,&$Rubrique, $sValeur, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull = true, $bNomRubriqueBase = false) { } function F25514b5d(&$pclFichier,$sValCleComp, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull, &$FirstComp) { } function F38eab526(&$RubriqueParcours, $TabVal) { if(!isset($RubriqueParcours)) { return false; } $sFiltre = "("; if($RubriqueParcours->Fbe67fb2c()) { $nMin = min(count($TabVal), count($RubriqueParcours->TabRubCleComp)); $TabComposantes = array_keys($RubriqueParcours->TabRubCleComp); for($i=0;$i<$nMin;$i++) { if($i > 0) { $sFiltre .= " AND "; } $sFiltre .= $this->F57e42f93($TabComposantes[$i])." LIKE '".$TabVal[$i]."%'"; } } else { $sFiltre .= $RubriqueParcours->F9047540f()." LIKE '".$TabVal[0]."%'"; } return $sFiltre.")"; } function Fc64a4d72(&$RubriqueParcours, $TabVal) { if(!isset($RubriqueParcours)) { return false; } $sFiltre = "("; if($RubriqueParcours->Fbe67fb2c()) { $nMin = min(count($TabVal), count($RubriqueParcours->TabRubCleComp)); $TabComposantes = array_keys($RubriqueParcours->TabRubCleComp); for($i=0;$i<$nMin;$i++) { if($i > 0) { $sFiltre .= " AND "; } $sFiltre .= $this->F57e42f93($TabComposantes[$i])." LIKE '%".$TabVal[$i]."%'"; } } else { $sFiltre .= $RubriqueParcours->F9047540f()." LIKE '%".$TabVal[0]."%'"; } return $sFiltre.")"; } function F08fec282(&$pclFichier,&$RubriqueParcours, $TabVal) { if(!isset($RubriqueParcours)) { return false; } $sFiltre = "("; if($RubriqueParcours->Fbe67fb2c()) { $nMin = min(count($TabVal), count($RubriqueParcours->TabRubCleComp)); $TabComposantes = array_keys($RubriqueParcours->TabRubCleComp); for($i=0;$i<$nMin;$i++) { if($i > 0) { $sFiltre .= " AND "; } $Composante = &$pclFichier->TabRubriques[utf8_strtolower($TabComposantes[$i])]; $sFiltre .= $pclFichier->F0fa6e24e($Composante, $this->F137bdb94($Composante,$TabVal[$i]), TYPE_COMP_EGAL); } } else { $sFiltre .= $pclFichier->F0fa6e24e($RubriqueParcours, $this->F137bdb94($RubriqueParcours,$TabVal[0]), TYPE_COMP_EGAL); } return $sFiltre.")"; } function F733817f4() { } function Ffffca4d6() { } function F0279985c() { } function F6b3e9cdf() { } function F52fb3679($sSql) { } function F72f9f2c6() { } function Fd66f4d77() { } function F69431bdf() { } function F0ee63cce() { } function query($sSQL,$tabOptions=null, $pclFichier = null) { } function F1b8fc945(&$pclChamp,&$pclFichier) { if (is_array($pclChamp->sFichierAffiche)) { $pclRubriqueAffiche = GetRubrique(F80229053($pclChamp->sFichierAffiche[1],false),$pclChamp->sRubriqueAffichee[1]); $sSQL = utf8_sprintf("SELECT %6\$s.%8\$s FROM %1\$s, %3\$s, %6\$s WHERE %1\$s.%2\$s = %3\$s.%4\$s AND %3\$s.%5\$s = %6\$s.%7\$s AND %1\$s.%2\$s = %%s", $this->F1632cfa1($pclChamp->sFichierBase), $this->F553244e5($pclChamp->sRubriqueBase), $this->F1632cfa1($pclChamp->sFichierAffiche[0]), $this->F553244e5($pclChamp->sRubriqueReliee[0]), $this->F553244e5($pclChamp->sRubriqueAffichee[0]), $this->F1632cfa1($pclChamp->sFichierAffiche[1]), $this->F553244e5($pclChamp->sRubriqueReliee[1]), $this->F553244e5($pclChamp->sRubriqueAffichee[1]), utf8_str_replace('%','%%',$this->Ff43faec2($pclRubriqueAffiche,$pclRubriqueAffiche->sNom,'SELECT')) ); } else { $pclRubriqueAffiche = GetRubrique(F80229053($pclChamp->sFichierAffiche,false),$pclChamp->sRubriqueAffichee); $sSQL = utf8_sprintf("SELECT %6\$s AS %5\$s FROM %1\$s, %3\$s WHERE %1\$s.%2\$s = %3\$s.%4\$s AND %1\$s.%2\$s = %%s", $this->F1632cfa1($pclChamp->sFichierBase), $this->F553244e5($pclChamp->sRubriqueBase), $this->F1632cfa1($pclChamp->sFichierAffiche), $this->F553244e5($pclChamp->sRubriqueReliee), $this->F553244e5($pclChamp->sRubriqueAffichee), utf8_str_replace('%','%%',$this->Ff43faec2($pclRubriqueAffiche,$pclRubriqueAffiche->sNom,'SELECT')) ); } $pclRubriqueAnalyse =& GetRubrique($pclChamp->sFichierBase,$pclChamp->sRubriqueBase); return $this->query(utf8_sprintf($sSQL,$this->Fdc8698c9($pclRubriqueAnalyse, F75ef6df8($pclChamp->sFichierBase,$pclChamp->sRubriqueBase)))); } function F553244e5($sNomRubrique) { return $this->Ff43faec2(getRef(null),$sNomRubrique,'SET'); } function F1632cfa1($sNomLogiqueFichier,$bAvecDelimiter=true) { $pclFichierAnalyse =& Fbad7a601($sNomLogiqueFichier); if (isset($pclFichierAnalyse)) $sNomLogiqueFichier = $pclFichierAnalyse->sNom; $sNomLogiqueFichier = $this->F98e40c2c($sNomLogiqueFichier); return $bAvecDelimiter ? $this->F57e42f93($sNomLogiqueFichier) : $sNomLogiqueFichier; } function F7a674c32() { } function F8541306a() { } function Fb9c44915() { } } class FMK_AN_Statement { var $m_resQuery; var $m_tabInformationsPrecalculees; function FMK_AN_Statement($resQuery,$tabInformations = null) { $this->m_resQuery = $resQuery; $this->m_tabInformationsPrecalculees = $tabInformations; } function F5374034a($fetch_style = FMK_AN_FETCH_BOTH, $cursor_orientation = null, $cursor_offset = null) { } function F210e6480() { } function F0c638d70() { } function F6e51814c() { } function F36a82aa8() { } function Faa2d6e4f() { } function Fd061cc94() { return is_resource($this->m_resQuery); } function F2262f69c() { if (isset($this->m_tabInformationsPrecalculees[FMK_AN_INFO_ROWCOUNT])) return $this->m_tabInformationsPrecalculees[FMK_AN_INFO_ROWCOUNT]; $nRows = null; if (isset($this->m_tabInformationsPrecalculees[FMK_AN_INFO_RESTYPE])) { switch ($this->m_tabInformationsPrecalculees[FMK_AN_INFO_RESTYPE]) { case 'SELECT': case 'DESCRIBE': case 'SHOW': $nRows = $this->F210e6480(); break; case 'INSERT': case 'UPDATE': case 'DELETE': $nRows = $this->F0c638d70(); break; default: } } if (isset($nRows)) return $nRows; $nRows = $this->F210e6480(); if ($nRows==0) { $nRows = $this->F0c638d70(); } return $nRows; } function F3829673d($nCol = 0) { if (($this->m_resQuery!==false)&&($this->F2262f69c()>0)) { $tabRes = $this->F5374034a(); if (($tabRes !== false)&&isset($tabRes[$nCol])) { $res = $tabRes[$nCol]; return $res; } } return false; } } ?>