<?php
//20.0.56.0 FMK/Xml.php GF 
//VersionVI: 30F200066p
//(c) 2005-2012 PC SOFT  - Release
 if (!defined('__INC__FMK/Chaine/Conversion.php')) { define('__INC__FMK/Chaine/Conversion.php',true); include_once(WB_INCLUDE_PATH.'WD2763954cb0d71a3b844e3c73c65bc4a3.php'); } function F86d71bbb($sChaineXML) { $posEncodage = utf8_strpos($sChaineXML,"?>"); if ($posEncodage!==false) { $sChaineXML = utf8_substr($sChaineXML,0,utf8_strpos($sChaineXML,'?>')); $posEncodage = utf8_strpos($sChaineXML,"encoding="); if ($posEncodage!==false) { $sEncodage = utf8_substr($sChaineXML,$posEncodage+10,utf8_strpos(utf8_substr($sChaineXML,$posEncodage+10),'"')); return $sEncodage; } } return (UNICODE_PAGE_UTF8?'UTF-8':"ISO-8859-1"); } class FMK_XML_Noeud { var $m_pclNoeud = null; function FMK_XML_Noeud($pclNoeud) { $this->m_pclNoeud =& $pclNoeud; } function Destructeur() { $this->m_pclNoeud = null; } function F5b936250($sTexte) { return utf8_decode($sTexte); } function F97a57645($sTexte) { return utf8_encode($sTexte); } function F5d4e4da9($sTagName, $sNouvelleValeur) { if (PHPVERSION_5) { $fils = new DOMElement($this->F97a57645($sTagName), $this->F97a57645($sNouvelleValeur)); $this->m_pclNoeud->appendChild($fils); return true; } else { $fils = new DOMElement($this->F97a57645($sTagName)); $fils->set_content($this->F97a57645($sNouvelleValeur)); $this->m_pclNoeud->append_child($fils); return true; } return false; } function Fe9a903cf($sTagName, $sNouvelleValeur) { if (PHPVERSION_5) { $attr = new DOMAttr($this->F97a57645($sTagName), $this->F97a57645($sNouvelleValeur)); $this->m_pclNoeud->appendChild($attr); return true; } else { $this->m_pclNoeud->set_attribute($this->F97a57645($sTagName), $this->F97a57645($sNouvelleValeur)); return true; } return false; } function F7168f84a() { if (!isset($this->m_pclNoeud)) return false; return (PHPVERSION_5) ? new FMK_XML_Noeud( $this->m_pclNoeud->firstChild ) : new FMK_XML_Noeud( $this->m_pclNoeud->first_child() ); } function Fc4f822fe() { return (PHPVERSION_5) ? $this->F5b936250($this->m_pclNoeud->data) : $this->F5b936250($this->m_pclNoeud->get_content()); } function F8feaa50c($xNouvelleValeur) { if (!isset($this->m_pclNoeud)) return false; if (PHPVERSION_5) { $this->m_pclNoeud->data = $this->F97a57645($xNouvelleValeur); } else { $this->m_pclNoeud->set_content($this->F97a57645($xNouvelleValeur)); } } function F778e8c6e() { if (!isset($this->m_pclNoeud)) return false; if (PHPVERSION_5) { $sFlux = $this->m_pclNoeud->saveXML(); } else { $sFlux = $this->m_pclNoeud->dump_mem(); } return $sFlux; } function F53d255a9($sXPath) { $sXPath = $this->F97a57645($sXPath); if (PHPVERSION_5) { $x = new DomXPath($this->m_pclNoeud); $nodes = $x->evaluate($sXPath); if (is_scalar($nodes)) return $nodes; $x = new DomXPath($this->m_pclNoeud); $nodes = $x->query($sXPath); $ret = array(); $nNbElement = $nodes->length; for($i=0; $i<$nNbElement; ++$i) { array_push($ret, new FMK_XML_Noeud($nodes->item($i))); } } else { $xpath = $this->m_pclNoeud->xpath_new_context(); if ($xpath===false) { return array(); } if ( ($nPosDeuxPoints = utf8_strpos($sXPath,':')) !==false) { F6b1e3687(); $ns = utf8_substr(utf8_strrchr(utf8_substr($sXPath,0,$nPosDeuxPoints),'/'),1); $sCodeXML = $this->F778e8c6e(); $namespaceURI = utf8_substr($sCodeXML, ($nPosDebut=utf8_strpos($sCodeXML,($sDebut=(':'.$ns.'="')))+utf8_strlen($sDebut)),utf8_strpos($sCodeXML,'"',$nPosDebut)-$nPosDebut); xpath_register_ns($xpath,$ns,$namespaceURI); F1e7b0563(); } F6b1e3687(); $nodes = $xpath->xpath_eval_expression( $sXPath ); F1e7b0563(); if (isset($nodes->nodeset)) { $ret = array(); $nNbNodes = count($nodes->nodeset,COUNT_NORMAL); for($i=0;$i<$nNbNodes;$i++) { array_push($ret, new FMK_XML_Noeud($nodes->nodeset[$i])); } } else { return $nodes->value; } } return $ret; } } class FMK_XML_Doc extends FMK_XML_Noeud { function FMK_XML_Doc($sFluxXML) { $clDom = null; if (PHPVERSION_5) { F6b1e3687(); $clDom = new DOMDocument(); $clDom->loadXML($sFluxXML); F1e7b0563(); } else { $gclDependance =& FMK_Dependance(); if (isset($gclDependance) && (!$gclDependance->F0b5f8f06('domxml'))) { } else { $clDom = new DOMDocument($sFluxXML); } } parent::FMK_XML_Noeud($clDom); } function xmlLit($sXPath,$xValeurSiNonTrouve) { $nodes = $this->F53d255a9($sXPath); if (!is_array($nodes)||(count($nodes,COUNT_NORMAL)===0)) return $xValeurSiNonTrouve; $pclPremierFils =& $nodes[0]; $pclPremierTexte = $pclPremierFils->F7168f84a(); $sDonnee = $pclPremierTexte->Fc4f822fe(); return $sDonnee; } function F731b973a($czNomElement, $nValeurFiltre, $czPrecedentSubXPath) { if($nValeurFiltre<1) { return false; } if($nValeurFiltre>1) { $czXPathElementPrecedent = utf8_sprintf("%s/%s[%d]", $czPrecedentSubXPath, $czNomElement, $nValeurFiltre-1); $nodes = $this->F53d255a9($czXPathElementPrecedent); if(count($nodes,COUNT_NORMAL)===0) { Fa19d34ae(); F853b7085(FMK_ChaineConstruit(F1ac3f040('ERR_XML_FILTRE_INCORRECT'),$nValeurFiltre,$nValeurFiltre-1)); return false; } } return true; } function F9d0a9e15(&$pczNomElement, &$pnValeurFiltre, &$czPrecedentSubXPath) { $nPos1 = utf8_strpos($pczNomElement,'['); if($nPos1===false) { $pnValeurFiltre = 1; return true; } $nPos2 = utf8_strpos($pczNomElement,']',$nPos1); if($nPos2===false) { return false; } $czValeurFiltre = utf8_substr($pczNomElement,$nPos1+1,$nPos2-$nPos1-1); if(!is_numeric($czValeurFiltre)) { return false; } $czNomElement = utf8_substr($pczNomElement,0,$nPos1); $nValeurFiltre = intval($czValeurFiltre); if(!$this->F731b973a($czNomElement, $nValeurFiltre, $czPrecedentSubXPath)) { return false; } $pczNomElement = $czNomElement; $pnValeurFiltre = $nValeurFiltre; return true; } function F82b0f071(&$pclNomElement, &$pbEstAttribut) { if( $pclNomElement[0] == '@') { $pclNomElement = utf8_substr($pclNomElement,1); $pbEstAttribut = true; } else { $pbEstAttribut = false; } return true; } function F083da90c(&$czXPath, $nPos, $nPos2, &$czPrecedentSubXPath, $xNouvelleValeur) { if($nPos2===false) $czNomElement = utf8_substr($czXPath,$nPos); else $czNomElement = utf8_substr($czXPath,$nPos,$nPos2-$nPos); $nValeurFiltre = null; if(!$this->F9d0a9e15($czNomElement, $nValeurFiltre, $czPrecedentSubXPath)) { return false; } $bEstUnAttribut = false; if($nPos2===false) { $this->F82b0f071($czNomElement, $bEstUnAttribut); } $czNomNormalise = Fe6a95d94($czNomElement); $czNomElement = utf8_str_replace(':','_',$czNomElement); if(empty($czNomElement) || (utf8_strpos($czNomElement,'\t')!==false) || (utf8_strpos($czNomElement,'\r')!==false) || (utf8_strpos($czNomElement,'\n')!==false) || (utf8_strpos($czNomElement,'<')!==false) || (utf8_strpos($czNomElement,'>')!==false) || (utf8_strpos($czNomElement,'&')!==false) || (utf8_strpos($czNomElement,'\'')!==false) || (utf8_strpos($czNomElement,'\\')!==false) || (utf8_strpos($czNomElement,'"')!==false) || ($czNomElement!=$czNomNormalise)) { return false; } if (!empty($czPrecedentSubXPath)) { $nodes = $this->F53d255a9($czPrecedentSubXPath); $node =& $nodes[0]; } else { $node =& $this; } if($nPos2===false) { if($bEstUnAttribut) return $node->Fe9a903cf($czNomElement, $xNouvelleValeur); else return $node->F5d4e4da9($czNomElement, $xNouvelleValeur); } else { return $node->F5d4e4da9($czNomElement,''); } } function Fbdfc1182($czRequeteXPATH,$xNouvelleValeur) { $nPos = utf8_strpos($czRequeteXPATH,'/')+1; $nPos2 = utf8_strpos($czRequeteXPATH,'/',$nPos+1); $bLeCheminEstValideDepuisLeDebut = true; $czPrecedentSubXPath = ''; while($nPos!==false) { assert($nPos<$nPos2 || $nPos2===false); if($nPos2===false) $czSubXPath = $czRequeteXPATH; else $czSubXPath = utf8_substr($czRequeteXPATH,0,$nPos2); if ($bLeCheminEstValideDepuisLeDebut) { $tabResultXPath = $this->F53d255a9($czSubXPath); $bResult = (count($tabResultXPath,COUNT_NORMAL)>0); } else { $bResult = false; } if (!$bResult) { $bLeCheminEstValideDepuisLeDebut = false; $bResult = $this->F083da90c($czRequeteXPATH, $nPos, $nPos2, $czPrecedentSubXPath, $xNouvelleValeur); if(!$bResult) return false; } if ($nPos2!==false) { $nPos = $nPos2+1; $nPos2 = utf8_strpos($czRequeteXPATH,'/',$nPos); $czPrecedentSubXPath = $czSubXPath; } else { $nPos = false; } } return true; } function xmlEcrit($sXPath,$xNouvelleValeur) { $nodes = $this->F53d255a9($sXPath); if (count($nodes,COUNT_NORMAL)===0) { return $this->Fbdfc1182($sXPath,$xNouvelleValeur); } else { $pclPremierFils =& $nodes[0]; $pclPremierTexte = $pclPremierFils->F7168f84a(); $pclPremierTexte->F8feaa50c($xNouvelleValeur); return true; } return false; } } ?>