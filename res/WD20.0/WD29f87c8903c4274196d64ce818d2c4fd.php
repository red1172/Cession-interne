<?php
//20.0.56.0 WL/HF/AN/Mysql.php GF 
//VersionVI: 30F200066p
//(c) 2005-2012 PC SOFT  - Release
 F3f50a0c6(HF_MYSQL); define('MYSQL_ESCAPE_CHAR', utf8_chr(96)); class FMK_AN_MYSQL extends FMK_AN { function FMK_AN_MYSQL($sHost=null,$sDB=null,$sUser=null,$sPass=null,$sInfosEtendues=null) { parent::FMK_AN($sHost,$sDB,$sUser,$sPass,$sInfosEtendues); } function F22067d84() { return TYPE_BASE_MYSQL; } function F25146199() { if(version_compare($sVersion=$this->F5218fab1(),'5.0.3','>=') && !empty($sVersion)) { return 65535; } return 255; } function F6b3e9cdf() { F6b1e3687(); $sMessage= mysql_error( $this->m_resConnexionId ); F1e7b0563(); return $sMessage; } function F3bd60944(&$pclRequete,$sCodeSQL,$bSignalerErreur=true) { $gclContextHF =& FMK_ContextHF(); $pclConnexion =& $gclContextHF->getConnexion($pclRequete->sNomConnexion); if (isset($pclConnexion)) { if(version_compare($sVersion=$pclConnexion->F5218fab1(),'4.1','<') && !empty($sVersion)) { if ($bSignalerErreur) Erreur('ErreurHF_1_Param',"ErreurVersionServeurMySQL", $sVersion); return false; } } return parent::F3bd60944($pclRequete,$sCodeSQL,$bSignalerErreur); } function Fb640a0ce($bErreur = true, $sMdp = null, $bCreateDatabse = false) { if (!function_exists( 'mysql_pconnect' )) { if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, utf8_sprintf(F1ac3f040("ERR_LIB_SQL_NON_TROUVEE"),"MySQL")); } return false; } $sMotDePasse = $this->m_sMotDePasse; if(isset($sMdp)) { $sMotDePasse = $sMdp; } F6b1e3687(); $this->m_resConnexionId = mysql_pconnect($this->m_sServeur, $this->m_sUtilisateur, $sMotDePasse); F1e7b0563(); if($this->m_resConnexionId == 0) { F6b1e3687(); $this->m_resConnexionId = mysql_connect($this->m_sServeur, $this->m_sUtilisateur, $sMotDePasse); F1e7b0563(); if($this->m_resConnexionId == 0) { if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, mysql_error()); } else { $gclContextHF =& FMK_ContextHF(); $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_ECHEC_CONNEXION"),$this->m_sBase,$this->m_sServeur,mysql_error())); $gclContextHF->ErreurHF = $Erreur; $gclContextHF->bErreurDoublon = true; Fe7895f62(true); } return false; } } F6b1e3687(); if ($this->Fe47ec54f()) { $this->Fa6486962($this->m_resConnexionId); } $res = mysql_select_db($this->m_sBase, $this->m_resConnexionId); F1e7b0563(); if (!$res) { $nErreurMysql = mysql_errno(); $sErreurMysql = mysql_error(); if ($bCreateDatabse) { if ( ($nErreurMysql == 1044) || ($nErreurMysql == 1049) ) { F6b1e3687(); $res = mysql_query('CREATE DATABASE `'. $this->m_sBase . '`', $this->m_resConnexionId); F1e7b0563(); if (!$res) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, mysql_error()); } else { F6b1e3687(); if ($this->Fe47ec54f()) { $this->Fa6486962($this->m_resConnexionId); } $res = mysql_select_db($this->m_sBase, $this->m_resConnexionId); F1e7b0563(); if ($res) return true; $sErreurMysql = mysql_error(); } } } if($bErreur) { global $sLastFunction; Erreur('ErreurEchecConnexion',$sLastFunction, $this->m_sBase, $this->m_sServeur, $sErreurMysql); } else { $gclContextHF =& FMK_ContextHF(); $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_ECHEC_CONNEXION"),$this->m_sBase,$this->m_sServeur,mysql_error())); $gclContextHF->ErreurHF = $Erreur; $gclContextHF->bErreurDoublon = true; Fe7895f62(true); } return false; } return true; } function Fa6486962($conn) { if (function_exists('mysql_set_charset')) { mysql_set_charset('utf8',$conn); } else mysql_query('SET NAMES \'utf8\'',$conn); } function F9d634e1a() { F6b1e3687(); mysql_close( $this->m_resConnexionId); F1e7b0563(); $this->m_resConnexionId = false; } function F218cc1a0() { if (!$this->m_resConnexionId) $this->Fb640a0ce(); $db_list = mysql_query('SHOW DATABASES',$this->m_resConnexionId); $tabRetour = array(); $i=0; while(false!==($ligne = mysql_fetch_assoc($db_list)) ) { $tabRetour[] = $ligne['Database']; } return $tabRetour; } function Fa7865f89($nOptions=null) { if (!$this->m_resConnexionId) $this->Fb640a0ce(); if (empty($this->m_sBase)) return ''; $sVersion = $this->F5218fab1(); if ($nOptions===null || $sVersion==='' || version_compare($sVersion,'5')===-1) { $sSql = 'SHOW TABLES FROM `'. $this->m_sBase . '`'; } else { $sSql = 'SELECT TABLE_NAME, TABLE_SCHEMA, TABLE_TYPE FROM INFORMATION_SCHEMA.TABLES  WHERE TABLE_SCHEMA = SCHEMA() AND ( 0=1 '; if(Fdef56c7f($nOptions,512)) { $sSql .=" OR TABLE_TYPE='BASE TABLE'"; } if(Fdef56c7f($nOptions,2048)) { $sSql .=" OR TABLE_TYPE='SYSTEM TABLE'"; } if(Fdef56c7f($nOptions,1024)) { $sSql .=" OR TABLE_TYPE='VIEW'"; } $sSql .= ')  ORDER BY TABLE_SCHEMA, TABLE_NAME'; } $table_list = mysql_query($sSql,$this->m_resConnexionId); $tabRetour = array(); while(false!==($ligne = mysql_fetch_row($table_list))) { $tabRetour[] = $ligne[0]; } return $tabRetour; } function F4b3597dc() { return mysql_get_client_info(); } function F5218fab1() { F6b1e3687(); $bEtatConnexion = ($this->m_resConnexionId != false); if (!$bEtatConnexion) $bEtatConnexion = $this->Fb640a0ce(); F1e7b0563(); if ($bEtatConnexion) { $sChaineInformationServeur = mysql_get_server_info($this->m_resConnexionId); $sVersion = parent::F03323c7e($sChaineInformationServeur); if (empty($sVersion)) return ''; return $sVersion; } else { return ''; } } function F850edd33(&$sSQL,$tabOptions) { parent::F850edd33($sSQL,$tabOptions); if (isset($tabOptions['LIMITFROM'])) { $sSQL .= " LIMIT ". intval($tabOptions['LIMITFROM']) . "," .intval($tabOptions['LIMIT']); } elseif (isset($tabOptions['LIMIT'])) { $sSQL .= " LIMIT ". intval($tabOptions['LIMIT']); } else { $sSQL .= " LIMIT 18446744073709551615"; } } function query($sSQL,$tabOptions=null, $pclFichier = null) { if (!$this->m_resConnexionId) $this->Fb640a0ce(); if (isset($tabOptions)) { $this->F850edd33($sSQL,$tabOptions); } $this->F5399a982($sSQL); F6b1e3687(); $resQuery = mysql_query($sSQL,$this->m_resConnexionId); F1e7b0563(); if ($resQuery === false) { return false; } $sTag = F9d60968a($sSQL,false); return new FMK_AN_Statement_MYSQL($resQuery,array(FMK_AN_INFO_RESTYPE=>$sTag)); } function F48bb09ec(&$pclRubrique,$Valeur) { $sFormat = ""; $sOpMySQL = "DATE_FORMAT"; switch($pclRubrique->nType) { case TYPE_DATE : $sFormat = "%Y%m%d"; $sOpMySQL = "DATE_FORMAT"; break; case TYPE_HEURE : switch ($pclRubrique->nTaille) { case 2: $sFormat = "%H"; break; case 4: $sFormat = "%H%i"; break; case 6: $sFormat = "%H%i%s"; break; default:$sFormat = "%H%i%s"; } $Valeur = utf8_str_pad($Valeur,6,'0',STR_PAD_RIGHT); $sOpMySQL = "TIME_FORMAT"; break; case TYPE_DATE_HEURE : $sFormat = "%Y%m%d%H%i%s000"; $sOpMySQL = "DATE_FORMAT"; break; case TYPE_DUREE : $Valeur = utf8_str_pad($Valeur,10,'0',STR_PAD_LEFT); break; default : if ($pclRubrique->F7b5edca9()) { $Valeur = doubleval($Valeur); } break; } if(!empty($sFormat)) { F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $id_result = mysql_query("SELECT ".$sOpMySQL."('".$Valeur."', '".$sFormat."')",$this->m_resConnexionId); if($id_result!==false) { $Valeur = mysql_result($id_result,0); } F1e7b0563(); } return $Valeur; } function Fdee89755(&$Rubrique,$sValeur) { $sResultat = $sValeur; if(!isset($sValeur)) { $sResultat = 'NULL'; } elseif($Rubrique->F7b5edca9()) { if(!is_numeric($sResultat)) { if (empty($sResultat)) { $sResultat = 0; } else { $sResultat = $this->F90fb578a($sResultat); } } } else { switch($Rubrique->nType) { case TYPE_DATE : $sFormatWD = "GET_FORMAT(DATE,'INTERNAL')"; break; case TYPE_HEURE : $sFormatWD = "GET_FORMAT(TIME,'INTERNAL')"; break; case TYPE_DATE_HEURE : $sFormatWD = "GET_FORMAT(DATETIME,'INTERNAL')"; break; default : $sFormatWD = null; break; } if (isset($sFormatWD)) { if(empty($sResultat)) { return 'NULL'; } $sResultat = "STR_TO_DATE('".$sResultat."',".$sFormatWD.")"; } else { return parent::Fdee89755($Rubrique,$sResultat); } } return $sResultat; } function F137bdb94(&$Rubrique,$sValeur) { $sResultat = $sValeur; if(!isset($sValeur)) { $sResultat = null; } elseif($Rubrique->F7b5edca9()) { if(!is_numeric($sResultat)) { if (empty($sResultat)) { $sResultat = 0; } } } else { switch($Rubrique->nType) { case TYPE_DATE : $sFormatWD = "%Y%m%d"; $sTypeSQL = 'DATE'; $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min(8,utf8_strlen($sResultat))),8,'0',STR_PAD_RIGHT); break; case TYPE_HEURE : { $nTaille = $Rubrique->nTaille; switch ($Rubrique->nTaille) { case 2: $sFormatWD = "%H"; break; case 4: $sFormatWD = "%H%i"; break; case 6: $sFormatWD = "%H%i%s"; break; default:$sFormatWD = "%H%i%s"; $nTaille = 6; } $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min($nTaille,utf8_strlen($sResultat))),$nTaille,'0',STR_PAD_RIGHT); $sTypeSQL = 'TIME'; } break; case TYPE_DATE_HEURE : $sResultat = utf8_str_pad(utf8_substr($sResultat,0,min(14,utf8_strlen($sResultat))),14,'0',STR_PAD_RIGHT); $sFormatWD = "%Y%m%d%H%i%s"; $sTypeSQL = 'DATETIME'; break; default : $sFormatWD = null; break; } if (isset($sFormatWD)) { if(empty($sResultat) || !isset($sResultat)) { return null; } F6b1e3687(); if (!$this->m_resConnexionId) $this->Fb640a0ce(); $id_result = mysql_query("SELECT DATE_FORMAT(STR_TO_DATE('".$sResultat."','".$sFormatWD."'),GET_FORMAT(".$sTypeSQL.",'INTERNAL') )",$this->m_resConnexionId); if($id_result!==false) { $sResultat = mysql_result($id_result,0); } if (($pclRubrique->nType==TYPE_HEURE) && (utf8_strlen($sResultat)>$pclRubrique->nTaille)) { $sResultat = utf8_substr($sResultat,0,$pclRubrique->nTaille); } F1e7b0563(); } } return $sResultat; } function Ff43faec2(&$pclRubrique, $sNomRubrique, $bAvecFormattage) { $sNom = parent::Ff43faec2($pclRubrique,$sNomRubrique,$bAvecFormattage); if ($bAvecFormattage===false) return $sNom; switch($bAvecFormattage) { case 'SELECT': switch ($pclRubrique->nType) { case TYPE_DATE: return 'DATE_FORMAT(' . $sNom . ',\'%Y%m%d\')'; break; case TYPE_DATE_HEURE: return 'DATE_FORMAT(' . $sNom . ',\'%Y%m%d%H%i%s\')'; break; case TYPE_HEURE: return 'DATE_FORMAT(' . $sNom . ',\'%H%i%s\')'; break; default: return $sNom; } break; case 'WHERE': if (Feee3b2d5($pclRubrique->Fichier)) { switch ($pclRubrique->nType) { case TYPE_DATE: return 'STR_TO_DATE(' . $sNom . ',\'%Y%m%d\')'; break; case TYPE_DATE_HEURE: return 'STR_TO_DATE(' . $sNom . ',\'%Y%m%d%H%i%s000\')'; break; case TYPE_HEURE: return 'STR_TO_DATE(' . $sNom . ',\'%H%i%s\')'; break; default: return $sNom; } } else { return $sNom; } break; default: return $sNom; break; } } function Fba409abd($nIdConnexion,$sNom, $sNomRequete='') { $gclContextHF =& FMK_ContextHF(); F6b1e3687(); $nCodeErreur = mysql_errno($nIdConnexion); F1e7b0563(); switch($nCodeErreur) { case 1062 : $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_DOUBLON"),$sNomRequete), $nCodeErreur, $this->F0df7c3d7($nCodeErreur, $nIdConnexion), $sNom, ""); $gclContextHF->ErreurHF = $Erreur; $gclContextHF->bErreurDoublon = true; SetErreurDetectee(true); break; case 1146 : $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_OUVERTURE_FICHIER"), $sNomRequete), $nCodeErreur, $this->F0df7c3d7($nCodeErreur, $nIdConnexion), $sNom, ""); $gclContextHF->ErreurHF = $Erreur; SetErreurDetectee(true); break; case 1054 : $Erreur = new FMK_ErreurHF(FMK_ChaineConstruit(F1ac3f040("ERR_SYNCHRO_ANALYSE"), $sNomRequete), $nCodeErreur, $this->F0df7c3d7($nCodeErreur, $nIdConnexion), $sNom, ""); $gclContextHF->ErreurHF = $Erreur; SetErreurDetectee(true); break; default: SetErreurDetectee(true); $sMessageBase = utf8_str_replace("\n","<BR />", $this->F0df7c3d7($nCodeErreur, $nIdConnexion)); if(!empty($sNomRequete)) { Erreur('ErreurHF_2_Param',"ErreurExecRequete",FMK_ChaineConstruit(F1ac3f040("ERR_ECHEC_EXEC_REQUETE"), $sNomRequete), $sMessageBase); } else { Erreur('ErreurHF_2_Param',"ErreurExecRequete",F1ac3f040("ERR_ERREUR_INTERNE_MYSQL"), $sMessageBase); } break; } } function F0df7c3d7($nCodeErreur, $IdConnexion) { $sMessageErr = $mysql_get_host_info = ''; if (is_resource($IdConnexion)) { $sMessageErr = mysql_error($IdConnexion); $mysql_get_host_info = mysql_get_host_info($IdConnexion); } return FMK_ChaineConstruit(Fc34ec142('ERR_MESSAGE_BASE'), $mysql_get_host_info, $nCodeErreur, $sMessageErr); } function F90fb578a($pszChaine) { if (is_string($pszChaine)) { if ($pszChaine=='') return "''"; if ($this->m_resConnexionId == 0) $this->Fb640a0ce(); $nIdConnexion = $this->m_resConnexionId; F6b1e3687(); $sChaineProtegee = mysql_real_escape_string($pszChaine,$nIdConnexion); if ($sChaineProtegee=='') { $sChaineProtegee = mysql_real_escape_string($pszChaine); } if ($sChaineProtegee=='') { $sChaineProtegee = utf8_addslashes($pszChaine); } $pszChaine = "'".$sChaineProtegee."'"; F1e7b0563(); } return $pszChaine; } function F6897ec01( &$pclFichier, $bEtVerifieDescription = null ) { if ($this->Ff31e2a62('SELECT 0 FROM '.$pclFichier->F9047540f().' LIMIT 1')===false) return false; if (false === $bEtVerifieDescription) return true; if (false === ($pclStatement=$this->query('SHOW COLUMNS FROM ' . $pclFichier->F9047540f()))) { return true; } if ($pclStatement->F2262f69c() === 0) return true; $tabNomColonnes = array(); while(false !== ($tabEnregistrement = $pclStatement->F5374034a(FMK_AN_FETCH_ASSOC)) ) { $tabNomColonnes[$tabEnregistrement['Field']] = true; } foreach (array_keys($pclFichier->TabRubriques) as $sNomRubriqueMinuscule) { $pclRubrique =& $pclFichier->TabRubriques[$sNomRubriqueMinuscule]; if (true===$pclRubrique->Fbe67fb2c()) continue; if (false === array_key_exists($pclRubrique->sNom,$tabNomColonnes)) { Fe81a7f9e('IDS_DESC_COMPAT_NOTFIC',$pclFichier->sNomLogique,$pclRubrique->sNom); return false; } } return true; } function F57e42f93($sNom=null) { return (isset ( $sNom ) && ($sNom[0]!=MYSQL_ESCAPE_CHAR)) ? (MYSQL_ESCAPE_CHAR . $sNom . MYSQL_ESCAPE_CHAR) : MYSQL_ESCAPE_CHAR; } function Fe172c97d(&$pclFichier) { $sRequeteDrop = "DROP TABLE IF EXISTS ".$pclFichier->F9047540f(); return $this->query($sRequeteDrop); } function F585065f5(&$pclFichier) { $sRequeteCreate = "CREATE TABLE ".$pclFichier->F9047540f()." ("; $tabKeys = array_keys( $pclFichier->TabRubriques ); $nOccurrence = count( $tabKeys ); for($nKey = 0; $nKey < $nOccurrence; $nKey++) { $sNom =& $tabKeys[ $nKey ]; $Rubrique =& $pclFichier->TabRubriques[ $sNom ]; if(!$Rubrique->Fbe67fb2c()) { $sRequeteCreate .= $Rubrique->F9047540f() ." ".$this->F4c4e336d($Rubrique).", "; } } if(isset($pclFichier->TabClePrimaire)) { foreach($pclFichier->TabClePrimaire as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; $sRequeteCreate .= "PRIMARY KEY (".$Rubrique->F9047540f() ."), "; } } if(isset($pclFichier->TabCleUnique)) { $sRequeteCreate .= $pclFichier->F020cb2dc($pclFichier->TabCleUnique, true); } if(isset($pclFichier->TabCleDoublon)) { $sRequeteCreate .= $pclFichier->F020cb2dc($pclFichier->TabCleDoublon, false); } if(utf8_strpos($sRequeteCreate,", ",utf8_strlen($sRequeteCreate) - 2)) { $sRequeteCreate = utf8_substr($sRequeteCreate, 0, utf8_strlen($sRequeteCreate) - 2); } $sVersion = $this->F5218fab1(); $sRequeteCreate .= ($sVersion==='' || version_compare($sVersion,'5.2')===-1) ? ') Type=InnoDB' : ') ENGINE=InnoDB'; return $this->F52fb3679($sRequeteCreate); } function F52fb3679($sSql) { $this->F5399a982($sSql); if (!$this->m_resConnexionId) $this->Fb640a0ce(); F6b1e3687(); $resQuery = mysql_query($sSql,$this->m_resConnexionId); F1e7b0563(); if ($resQuery === false) { return false; } F6b1e3687(); $nRows = mysql_affected_rows($this->m_resConnexionId); F1e7b0563(); return $nRows; } function F4c4e336d(&$Rubrique) { $sChaine = ''; $sValeurParDefaut = ''; if ( ($Rubrique->nType != TYPE_ID_AUTO) && ($Rubrique->nType != TYPE_ID_AUTO_4) && ($Rubrique->nType != TYPE_MEMO_TEXTE) && ($Rubrique->nType != TYPE_MEMO_BINAIRE) && ($Rubrique->nType != TYPE_MEMO_TEXTE_UNICODE)) { if($Rubrique->bNull) { $sValeurParDefaut = " DEFAULT NULL"; } else { if ((!isset($Rubrique->ValeurDefaut)) || (empty($Rubrique->ValeurDefaut))) { switch ($Rubrique->nType) { case TYPE_BOOLEEN : case TYPE_DUREE : case TYPE_ENTIER_1 : case TYPE_ENTIER_2 : case TYPE_ENTIER_4 : case TYPE_ENTIER_8 : case TYPE_ENTIER_NON_SIGNE_1 : case TYPE_ENTIER_NON_SIGNE_2 : case TYPE_ENTIER_NON_SIGNE_4 : case TYPE_ENTIER_NON_SIGNE_8 : case TYPE_REEL_4 : case TYPE_REEL_8 : case TYPE_MONETAIRE : case TYPE_DECIMAL : { $sValeurParDefaut = $this->Fdc8698c9($Rubrique, 0); } break; case TYPE_DATE : case TYPE_DATE_HEURE : case TYPE_HEURE : { $sValeurParDefaut = ''; } break; case TYPE_BINAIRE : case TYPE_CARACTERE : case TYPE_CHAINE : case TYPE_UNICODE : default : { $sValeurParDefaut = "''"; } break; } } else { switch ($Rubrique->nType) { case TYPE_DATE : case TYPE_DATE_HEURE : case TYPE_HEURE : { $sValeurParDefaut = $this->F137bdb94($Rubrique, $Rubrique->ValeurDefaut); } break; default: $sValeurParDefaut = $this->Fdc8698c9($Rubrique, $Rubrique->ValeurDefaut); } } if ('' !== $sValeurParDefaut) { $sValeurParDefaut = ' DEFAULT '.$sValeurParDefaut; } } } switch ($Rubrique->nType) { case TYPE_BINAIRE : $sChaine = "varchar(".$Rubrique->nTaille.")"; break; case TYPE_BOOLEEN : $sChaine = "tinyint "; break; case TYPE_CARACTERE : $sChaine = "char"; break; case TYPE_CHAINE : case TYPE_UNICODE : if ($Rubrique->nTaille>$this->F25146199()) { $sChaine = 'text'; $sValeurParDefaut = ''; } else { $sChaine = "varchar(".$Rubrique->nTaille.")" . (($Rubrique->nType==TYPE_UNICODE)?' CHARACTER SET ucs2':''); } break; case TYPE_DATE : $sChaine = "date"; break; case TYPE_DATE_HEURE : $sChaine = "datetime"; break; case TYPE_DUREE : $sChaine = "int"; break; case TYPE_ENTIER_1 : $sChaine = "tinyint"; break; case TYPE_ENTIER_2 : $sChaine = "smallint"; break; case TYPE_ENTIER_4 : $sChaine = "int"; break; case TYPE_ENTIER_8 : $sChaine = "bigint"; break; case TYPE_ENTIER_NON_SIGNE_1 : $sChaine = "tinyint UNSIGNED"; break; case TYPE_ENTIER_NON_SIGNE_2 : $sChaine = "smallint UNSIGNED"; break; case TYPE_ENTIER_NON_SIGNE_4 : $sChaine = "int UNSIGNED"; break; case TYPE_ENTIER_NON_SIGNE_8 : $sChaine = "bigint UNSIGNED"; break; case TYPE_REEL_4 : $sChaine = "float"; break; case TYPE_REEL_8 : $sChaine = "double"; break; case TYPE_HEURE : $sChaine = "time"; break; case TYPE_ID_AUTO : $sChaine = "bigint NOT NULL auto_increment"; break; case TYPE_ID_AUTO_4 : $sChaine = "int NOT NULL auto_increment"; break; case TYPE_MEMO_BINAIRE : $sChaine = "longblob"; break; case TYPE_MEMO_TEXTE : $sChaine = "longtext"; break; case TYPE_MEMO_TEXTE_UNICODE : $sChaine = "longtext CHARACTER SET ucs2"; break; case TYPE_MONETAIRE : $sChaine = "decimal(18,6)"; break; case TYPE_DECIMAL : $sChaine = "decimal(".$Rubrique->nTaille.",6)"; break; default : Fe81a7f9e('ERR_RUBRIQUE_TYPE_NON_GERE',$Rubrique->sNom); break; } return $sChaine . $sValeurParDefaut; } function F27cfe4f5(&$pclFichier) { $nIdAuto = false; if(!isset($pclFichier->bRealIdAuto)) { $pclQueryStatement = $pclFichier->F52651677("SELECT ".$pclFichier->IdAuto->sNom." FROM ".$this->F57e42f93($pclFichier->Fe8d9985a())." LIMIT 0", $this->m_resConnexionId, true); if($pclQueryStatement===false) { $this->Fba409abd($this->m_resConnexionId,$pclFichier->sNomLogique ); } else { F6b1e3687(); $sSemaphore = mysql_field_flags($pclQueryStatement->m_resQuery, 0); F1e7b0563(); $pclQueryStatement->Faa2d6e4f(); $pclFichier->bRealIdAuto = (utf8_strpos($sSemaphore, "auto_increment") !== false); } } if(!$pclFichier->bRealIdAuto) { $pclQueryStatement = $pclFichier->F52651677("SELECT MAX(".$pclFichier->IdAuto->sNom. ") FROM ".$this->F57e42f93($pclFichier->Fe8d9985a()), $this->m_resConnexionId, true); if($pclQueryStatement===false) { $this->Fba409abd($this->m_resConnexionId,$pclFichier->sNomLogique); } else { $nIdMax = 0; $nResult = $pclQueryStatement->F3829673d(0); if ($nResult!==false) { $nIdMax = $nResult + 1; } else { $nIdMax = 1; } $pclQueryStatement->Faa2d6e4f(); $nIdAuto = $nIdMax; } } else { $nIdAuto = true; } return $nIdAuto; } function F7aeb10e1(&$pclFichier,&$Enreg, &$pnIdAuto,&$sNomRubIdAuto, $bForceIdAuto = false,$bEtExecute = true) { $sNomRubIdAuto = null; $nIdAuto = 0; $this->m_sClauseEnCours ='INSERT'; $sRequeteInsert = "INSERT INTO ".$this->F57e42f93($pclFichier->Fe8d9985a()) . "("; $sRequeteValues = " VALUES ("; $nIndex = 0; foreach($Enreg as $sNom => $valeur) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($Rubrique->Fa2afd757()) { $sNomRubIdAuto = $sNom; if(!$bForceIdAuto || $valeur == 0) { $nIdAuto = $this->F27cfe4f5($pclFichier); if(!is_bool($nIdAuto)) { $valeur = $nIdAuto; } else { continue; } } else { if($valeur < 0) { global $sLastFunction; Erreur('ErreurIdAutoNegatif',$sLastFunction, $sNom, $pclFichier->sNomLogique); } } } if($nIndex != 0) { $sRequeteInsert .= ", "; $sRequeteValues .= ", "; } ++$nIndex; $this->m_sClauseEnCours ='INSERT'; $sRequeteInsert .= $this->F57e42f93($Rubrique->sNomBase); $this->m_sClauseEnCours ='VALUES'; $sRequeteValues .= $this->Fdee89755($Rubrique,$valeur); } } $sRequeteInsert = $sRequeteInsert . ")" . $sRequeteValues . ")"; if (!$bEtExecute) return $sRequeteInsert; $this->m_sClauseEnCours =null; $nResExec = $this->F52fb3679($sRequeteInsert); if(!$bForceIdAuto && isset($sNomRubIdAuto)) { if(is_bool($nIdAuto)) { F6b1e3687(); $nIdAuto = mysql_insert_id($this->m_resConnexionId); F1e7b0563(); } $pnIdAuto = $nIdAuto; } return $nResExec; } function Fbac1b32d(&$pclFichier,$bForceIdAuto = false) { $this->m_sClauseEnCours ='UPDATE'; $sRequeteUpdate = "UPDATE ".$pclFichier->F7653b31e()." SET "; $this->m_sClauseEnCours ='WHERE'; $sRequeteWhere = " WHERE ("; if(isset($pclFichier->TabClePrimaire)) { if (!Feee3b2d5($pclFichier)) { $sNomClePrimaire = $pclFichier->TabClePrimaire[0]; $ClePrimaire =& $pclFichier->TabRubriques[utf8_strtolower($sNomClePrimaire)]; $sRequeteWhere .= $pclFichier->F0fa6e24e($ClePrimaire, $pclFichier->EnregCourant[$ClePrimaire->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } else { $pclFichierLie =& $pclFichier->TabFichierRequete[key($pclFichier->TabFichierRequete)]; $sNomClePrimaire = $pclFichierLie->TabClePrimaire[0]; $ClePrimaire =& $pclFichierLie->TabRubriques[utf8_strtolower($sNomClePrimaire)]; $sRequeteWhere .= $pclFichierLie->F0fa6e24e($ClePrimaire, $pclFichier->EnregCourant[$ClePrimaire->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } } else if(isset($pclFichier->IdAuto)) { if (Feee3b2d5($pclFichier)) { $pclFichierLie =& $pclFichier->TabFichierRequete[key($pclFichier->TabFichierRequete)]; $sRequeteWhere .= $pclFichierLie->F0fa6e24e($pclFichierLie->IdAuto, $pclFichier->EnregCourant[$pclFichier->IdAuto->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } else { $sRequeteWhere .= $pclFichier->F0fa6e24e($pclFichier->IdAuto, $pclFichier->EnregCourant[$pclFichier->IdAuto->sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } } $nIndex = 0; foreach($pclFichier->EnregUtilisateur as $sNom => $valeur) { if (!isset($pclFichier->TabRubriques[utf8_strtolower($sNom)])) { continue; } $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($Rubrique->Fa2afd757()) { if($bForceIdAuto && $valeur < 0) { global $sLastFunction; Erreur('ErreurIdAutoNegatif',$sLastFunction, $sNom, $pclFichier->sNomLogique); } else if(!$bForceIdAuto) { $pclFichier->EnregUtilisateur[$sNom] = $pclFichier->EnregCourant[$sNom]; continue; } } if($nIndex != 0) { $sRequeteUpdate .= ", "; } $this->m_sClauseEnCours = 'SET'; $sRequeteUpdate .= $pclFichier->F0fa6e24e($Rubrique,$valeur, TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, false, true); if(!isset($pclFichier->TabClePrimaire) && !isset($pclFichier->IdAuto)) { if($nIndex != 0) { $sRequeteWhere .= " AND "; } $this->m_sClauseEnCours = 'WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($Rubrique, $pclFichier->EnregCourant[$sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } ++$nIndex; } } $sRequeteUpdate = $sRequeteUpdate . $sRequeteWhere . ")"; $sRequeteUpdate .= " LIMIT 1"; $this->m_sClauseEnCours = null; return $this->F52fb3679($sRequeteUpdate); } function F100650c1(&$pclFichier) { $this->m_sClauseEnCours ='DELETE'; $sRequeteDelete = "DELETE FROM ".$this->F57e42f93($pclFichier->Fe8d9985a()); $sRequeteWhere = " WHERE ("; $nIndex = 0; foreach(array_keys($pclFichier->EnregCourant) as $sNom) { $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($sNom)]; if(!isset($Rubrique->Fichier)) { $Rubrique->Fichier =& $pclFichier; } if(!$Rubrique->Fbe67fb2c()) { if($nIndex != 0) { $sRequeteWhere .= " AND "; } ++$nIndex; $this->m_sClauseEnCours ='WHERE'; $sRequeteWhere .= $pclFichier->F0fa6e24e($Rubrique, $pclFichier->EnregCourant[$sNom], TYPE_COMP_EGAL, PARCOURS_PREMIER_SUIVANT, true, true); } } $sRequeteDelete .= $sRequeteWhere . ")"; $sRequeteDelete .= " LIMIT 1"; $this->m_sClauseEnCours =null; return $this->F52fb3679($sRequeteDelete); } function F020cb2dc(&$pclFichier, $TabRub, $bUnique) { $sDefIndex = ""; foreach($TabRub as $sNom) { $Rubrique = &$pclFichier->TabRubriques[utf8_strtolower($sNom)]; if($Rubrique->Fa2afd757()) { $sDefIndex .= 'PRIMARY KEY '; } else { if($bUnique) { $sDefIndex .= 'UNIQUE '; } $sDefIndex .= 'KEY '; } if($Rubrique->Fbe67fb2c()) { $sDefIndex .= '`' . $Rubrique->sNom . '`('; $nIndex = count($Rubrique->TabRubCleComp); foreach(array_keys($Rubrique->TabRubCleComp) as $sComposante) { $sDefIndex .= '`'.$sComposante . '`'; --$nIndex; if($nIndex != 0) { $sDefIndex .= ', '; } } $sDefIndex .= ')'; } else { $sDefIndex .= '(`' . $Rubrique->sNom .'`'; if ($Rubrique->F81d228c1() && !$Rubrique->F5c7b90f9() && ($Rubrique->nTaille>$this->F25146199())) { $sDefIndex .= '('.$Rubrique->nTaille.')'; } $sDefIndex .= ')'; } $sDefIndex .= ', '; } return $sDefIndex; } function Fe8d9985a(&$pclFichier) { return $this->F98e40c2c($pclFichier->sNom); } function F7653b31e(&$pclFichier) { return $this->F98e40c2c($pclFichier->sNom); } function Fd5be2853(&$pclFichier,$TabRub, $nTypeParcours) { if(count($TabRub) == 0) { return ""; } $sOrderBy = ""; $nNbRub = count($TabRub); foreach($TabRub as $rubrique) { --$nNbRub; $sRubriqueOrderBy = $rubrique->F0c01be43($this,$nTypeParcours); $sOrderBy .= $sRubriqueOrderBy; if($nNbRub > 0 && !empty($sRubriqueOrderBy)) { $sOrderBy .= ", "; } } return (empty($sOrderBy)) ? $sOrderBy : " ORDER BY " . $sOrderBy; } function F5237a205(&$pclFichier,$TabRub, $nTypeParcours, &$DernierEnregLu) { $sWhere = " WHERE ("; $oldRub = null; $nNbParentheses = 0; foreach($TabRub as $rubrique) { if($rubrique->Fbe67fb2c()) { foreach($rubrique->TabRubCleComp as $composante => $sens ) { $RubComp = $pclFichier->TabRubriques[utf8_strtolower($composante)]; $RubComp->nSens_Parcours = $sens; if(isset($oldRub)) { $sWhere .= " OR (".$pclFichier->F0fa6e24e($oldRub, $DernierEnregLu[$oldRub->sNom], true, $nTypeParcours)." AND ("; $nNbParentheses += 2; } $sWhere .= $pclFichier->F0fa6e24e($RubComp, $DernierEnregLu[$RubComp->sNom], false, $nTypeParcours); $oldRub = $RubComp; } } else if($rubrique->nType == TYPE_CALCULE) { continue; } else { if(isset($oldRub)) { $sWhere .= " OR (".$pclFichier->F0fa6e24e($oldRub, $DernierEnregLu[$oldRub->sNom], true, $nTypeParcours)." AND ("; $nNbParentheses += 2; } $sWhere .= $pclFichier->F0fa6e24e($rubrique, $DernierEnregLu[$rubrique->sNom], false, $nTypeParcours); $oldRub = $rubrique; } } for($i=0;$i<$nNbParentheses;$i++) { $sWhere .= ")"; } return $sWhere.")"; } function F0fa6e24e(&$pclFichier,&$Rubrique, $sValeur, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull = true, $bNomRubriqueBase = false) { $sClauseEnCours = (isset($this->m_sClauseEnCours) ? $this->m_sClauseEnCours : 'WHERE'); if($bNomRubriqueBase) { $sResultat = $this->Ff43faec2( $Rubrique , $Rubrique->sNomBase ,$sClauseEnCours); } else { $sResultat = $this->Ff43faec2( $Rubrique , $Rubrique->sNom,$sClauseEnCours); } if(!isset($sValeur) && $bNull) { if($nTypeCompare == TYPE_COMP_EGAL) { $sResultat.=" IS NULL"; } else { $sResultat.=" IS NOT NULL"; } return $sResultat; } if($nTypeCompare == TYPE_COMP_EGAL) { $sResultat .= " = "; } else if($nTypeCompare == TYPE_COMP_COMMENCE_PAR) { if($Rubrique->F7b5edca9()) { $sResultat .= " = "; } else { $sResultat .= " LIKE "; $sResultat .= $this->Fdee89755($Rubrique,$sValeur.'%'); return $sResultat; } } else { if($Rubrique->F19c595c2()) { if($nTypeParcours == PARCOURS_PREMIER_SUIVANT) { $sResultat .= " >"; } else { $sResultat .= " <"; } } else { if($nTypeParcours == PARCOURS_PREMIER_SUIVANT) { $sResultat .= " <"; } else { $sResultat .= " >"; } } if($nTypeCompare == TYPE_COMP_INF_EGAL || $nTypeCompare == TYPE_COMP_SUP_EGAL) { $sResultat .= "= "; } else { $sResultat .= " "; } } if ($sClauseEnCours!=='SET' && ( (($Rubrique->nType == TYPE_REEL_4)||($Rubrique->nType == TYPE_REEL_8)) && (version_compare($sVersion=$this->F5218fab1(),'5.0.3','>=') || empty($sVersion)) )) { if (($nPos=utf8_strpos($sResultat,'>'))!==false) { $sRubrique = utf8_substr($sResultat,0,$nPos-1); $sResultatReel = $sRubrique . ' - ' . $this->Fdee89755($Rubrique,$sValeur) . ' > ' . VALEUR_EPSILON; } elseif (($nPos=utf8_strpos($sResultat,'<'))!==false) { $sRubrique = utf8_substr($sResultat,0,$nPos-1); $sResultatReel = $this->Fdee89755($Rubrique,$sValeur) . ' - ' . $sRubrique . ' > ' . VALEUR_EPSILON; } if (($nPos=utf8_strpos($sResultat,'='))!==false) { if (!isset($sResultatReel)) { $sRubrique = utf8_substr($sResultat,0,$nPos-1); $sResultatReel = ''; } else { $sResultatReel = '(' . $sResultatReel . ') OR '; } $sResultatReel = '(ABS(' . $this->Fdee89755($Rubrique,$sValeur) .'-'. $sRubrique . ') < '. VALEUR_EPSILON .')'; } return $sResultatReel; } else { $sResultat .= $this->Fdee89755($Rubrique,$sValeur); return $sResultat; } } function F25514b5d(&$pclFichier,$sValCleComp, $nTypeCompare, $nTypeParcours = PARCOURS_PREMIER_SUIVANT, $bNull, &$FirstComp) { $sResultat = ""; $sValCleComp = utf8_substr($sValCleComp, 1); $hVal = ""; if((utf8_strpos($sValCleComp, H_VAL_MIN) == (utf8_strlen($sValCleComp) - 1)) || (utf8_strpos($sValCleComp, H_VAL_MAX) == (utf8_strlen($sValCleComp) - 1))) { $hVal = utf8_substr($sValCleComp, (utf8_strlen($sValCleComp) - 1)); $sValCleComp = utf8_substr($sValCleComp, 0, (utf8_strlen($sValCleComp) - 1)); } $TabComposante = utf8_explode(SEPARATEUR_COMPOSANTE, $sValCleComp); $nBorneMax=count($TabComposante); for($i=0;$i<$nBorneMax;$i++) { $TabCoupleCleValeur = utf8_explode(SEPARATEUR_VALEUR, $TabComposante[$i]); if($i > 0) { $sResultat .= " AND "; } else { $FirstComp = $TabCoupleCleValeur; } $Rubrique =& $pclFichier->TabRubriques[utf8_strtolower($TabCoupleCleValeur[0])]; $sResultat .= $pclFichier->F0fa6e24e($Rubrique, $this->F137bdb94($Rubrique,$TabCoupleCleValeur[1].$hVal), $nTypeCompare, $nTypeParcours, $bNull); } return $sResultat; } function F4500afc6(&$pclOpExpression) { $sCodeExpression=null; switch($pclOpExpression->m_nOpExpression) { case eSTRING_LTRIM: $sTrim = 'LTRIM'; case eSTRING_RTRIM: if (!isset($sTrim)) $sTrim = 'RTRIM'; $sCodeExpression = $sTrim . '('; $sCodeChaine = Ffaa5b6f5($pclOpExpression->m_tabItems[0],$this); if (!isset($sCodeChaine)) return null; $sCodeExpression.= $sCodeChaine . ')'; break; case eMATH_UUID: return 'UUID()'; break; case eLAST_INSERT_ID: return 'LAST_INSERT_ID()'; break; default: return parent::F4500afc6($pclOpExpression); } return $sCodeExpression; } function Fe47eea61(&$pclRequete) { $this->Faa055082($pclRequete , 'LIMIT'); $pclLimit =& $pclRequete->m_clLimit; if (isset($pclLimit)) { $nType = $pclLimit->m_nType; $nOffset = $pclLimit->m_nDepuis; $nEnregs = $pclLimit->m_nNombreEnregs; switch ($nType) { case eTOP: return 'LIMIT '.$nEnregs; break; case eBOTTOM: $sCodeLimit = '(SELECT * FROM ' . $pclRequete->m_pszCodeSQLEnCours; $sCodeLimit.='LIMIT '.$nEnregs; $sCodeLimit.=') AS ' . uniqid('REQ_BOTTOM_') . ' '; $sCodeSQL_ORDERBY = $this->Fdf02384a($pclRequete,true); if (isset($sCodeSQL_ORDERBY)) $sCodeLimit.=$sCodeSQL_ORDERBY; $pclRequete->m_pszCodeSQLEnCours = ''; return $sCodeLimit; break; case eLIMIT_MYSQL: case eLIMIT_POSTGRESQL: return 'LIMIT '.$nOffset.',' . $nEnregs; break; case eEVERY: break; default: } } return null; } function F79056dd0(&$pclJointure) { if ($pclJointure->m_eTypeJointure === eOPJOIN_FULL) { return Fe81a7f9e('ERR_MYSQL_JOINTURES_FULL',$this->m_pclRequeteEnCours->m_sNom); } return parent::F79056dd0($pclJointure); } } class FMK_AN_Statement_MYSQL extends FMK_AN_Statement { function FMK_AN_Statement_MYSQL($resQuery,$tabInformations = null) { parent::FMK_AN_Statement($resQuery,$tabInformations); } function F5374034a($nFetchType = FMK_AN_FETCH_BOTH, $cursor_orientation = null, $cursor_offset = null) { if (!isset($nFetchType)) $nFetchType = FMK_AN_FETCH_BOTH ; switch ($nFetchType) { case FMK_AN_FETCH_BOTH: { F6b1e3687(); $tabMyFetch = mysql_fetch_array($this->m_resQuery,MYSQL_BOTH); F1e7b0563(); if ($tabMyFetch === false) { return false; } return $tabMyFetch; } break; case FMK_AN_FETCH_ASSOC: { F6b1e3687(); $tabMyFetch = mysql_fetch_assoc($this->m_resQuery); F1e7b0563(); if ($tabMyFetch === false) { return false; } return $tabMyFetch; } break; case FMK_AN_FETCH_LAZY: { F6b1e3687(); $tabMyFetch = mysql_fetch_assoc($this->m_resQuery); F1e7b0563(); if ($tabMyFetch === false) { return false; } $clResultat = new FMK_AN_Row(); F34bbd047($clResultat,$tabMyFetch); unset($tabMyFetch); return $clResultat; } break; case FMK_AN_FETCH_OBJ: { F6b1e3687(); $tabMyFetch = mysql_fetch_assoc($this->m_resQuery); F1e7b0563(); if ($tabMyFetch === false) { return false; } $clResultat = new stdClass(); F34bbd047($clResultat,$tabMyFetch); unset($tabMyFetch); return $clResultat; } default: return false; } } function F6e51814c() { F6b1e3687(); mysql_data_seek($this->m_resQuery,0); F1e7b0563(); } function F210e6480() { F6b1e3687(); $nOccurrence = mysql_num_rows($this->m_resQuery); F1e7b0563(); return $nOccurrence; } function F0c638d70() { F6b1e3687(); $nOccurrence = mysql_affected_rows($this->m_resQuery); F1e7b0563(); return $nOccurrence; } function F36a82aa8() { F6b1e3687(); $nColCount = mysql_num_fields($this->m_resQuery); F1e7b0563(); return $nColCount; } function Faa2d6e4f() { F6b1e3687(); mysql_free_result($this->m_resQuery); F1e7b0563(); } } ?>